<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS SuperSplat Core</title>
    <style>
        /* å¼ºåˆ¶å…¨å±æ— æ»šåŠ¨ */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; touch-action: none; }
        
        /* è°ƒè¯•æ§åˆ¶å° (å¦‚æœä¸æŠ¥é”™ä¼šè‡ªåŠ¨éšè—) */
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: auto;
            max-height: 100px; overflow-y: scroll;
            background: rgba(255,0,0,0.5); color: white;
            font-size: 10px; pointer-events: none; z-index: 9999;
            display: none; /* é»˜è®¤éšè—ï¼Œæœ‰é”™è¯¯å†æ˜¾ç¤º */
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        #header {
            position: absolute; top: 10px; left: 10px; z-index: 500;
            color: rgba(255,255,255,0.7); font-family: sans-serif; font-weight: bold;
            text-shadow: 0 1px 2px black; pointer-events: none;
        }

        /* åŠ è½½è¿›åº¦ */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #0f0; font-family: monospace; font-size: 16px;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            pointer-events: none; z-index: 1000; text-align: center;
        }

        /* åº•éƒ¨å·¥å…·æ å®¹å™¨ */
        #toolbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; background: rgba(20,20,20,0.9);
            padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #333; z-index: 500;
        }

        /* å·¥å…·æŒ‰é’® */
        .btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: #333; color: #aaa; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.9); }
        .btn.active { background: #007bff; color: white; box-shadow: 0 0 15px #007bff; }
        
        /* éšè—æ‰æ²¡ç”¨çš„æŒ‰é’® */
        .btn[disabled] { opacity: 0.2; pointer-events: none; }

    </style>
    
    <!-- å¼•å…¥åº“ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <!-- é”™è¯¯æ—¥å¿—åŒº -->
    <div id="console-log"></div>
    
    <!-- åŠ è½½æç¤º -->
    <div id="loader">ğŸš€ å¼•æ“å¯åŠ¨ä¸­...</div>
    
    <!-- æ ‡é¢˜ -->
    <div id="header">3DGS Viewer (Orbit Mode)</div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div id="toolbar">
        <button class="btn active" id="mode-view" onclick="app.setMode('view')">ğŸ‘ï¸</button>
        <div style="width:1px; background:#444; margin:0 5px;"></div>
        <button class="btn" id="mode-move" onclick="app.setMode('translate')">âœ¢</button>
        <button class="btn" id="mode-rotate" onclick="app.setMode('rotate')">â†»</button>
        <button class="btn" id="mode-scale" onclick="app.setMode('scale')">â¤¢</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // æ•è·æŠ¥é”™æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
        window.onerror = function(msg, url, line) {
            const log = document.getElementById('console-log');
            log.style.display = 'block';
            log.innerHTML += `âŒ Error: ${msg} (Line ${line})<br>`;
        };

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;     // è¿™é‡Œçš„ Controls æ˜¯ OrbitControls
                this.transform = null;    // è¿™é‡Œçš„ Transform æ˜¯ Gizmo
                this.splatMesh = null;
                this.loader = document.getElementById('loader');
            }

            async init() {
                try {
                    // 1. åˆå§‹åŒ– Viewer (âš ï¸ å…³é”®ï¼šå…³é—­å†…ç½®æ§åˆ¶ useBuiltInControls: false)
                    this.viewer = new Viewer({
                        'cameraUp': [0, 1, 0],
                        'initialCameraPosition': [0, 1, 4],
                        'initialCameraLookAt': [0, 0, 0],
                        'useBuiltInControls': false, // ğŸš« å½»åº•ç¦ç”¨åº“è‡ªå¸¦çš„ï¼Œæˆ‘ä»¬è‡ªå·±æ¥ç®¡
                        'sharedMemoryForWorkers': false,
                        'selfDrivenMode': true // å¼€å¯è‡ªé©±åŠ¨å¾ªç¯
                    });

                    // ç»‘å®šåˆ°é¡µé¢
                    document.body.appendChild(this.viewer.renderer.domElement);

                    // 2. æ‰‹åŠ¨æŒ‚è½½ OrbitControls (æ ‡å‡†æ‰‹æ„Ÿ)
                    this.setupOrbitControls();

                    // 3. æ·»åŠ ç½‘æ ¼è¾…åŠ©
                    const grid = new THREE.GridHelper(10, 10, 0x666666, 0x222222);
                    grid.position.y = -1;
                    this.viewer.threeScene.add(grid);

                    // 4. åˆå§‹åŒ– Gizmo (å˜æ¢æ§åˆ¶å™¨)
                    this.setupGizmo();

                    // 5. ä¸‹è½½å¹¶åŠ è½½
                    await this.loadModel();

                    // 6. å¼€å¯æ¸²æŸ“å¾ªç¯ (æœ‰äº›åº“å¦‚æœä¸æ‰‹åŠ¨æ›´æ–°controlsä¼šå¡ä½)
                    this.animate();

                } catch (e) {
                    alert("åˆå§‹åŒ–å¤±è´¥: " + e.message);
                }
            }

            setupOrbitControls() {
                // å¿…é¡»ä¼  camera å’Œ renderer.domElement
                this.controls = new OrbitControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.controls.enableDamping = true; // æƒ¯æ€§æ»‘åŠ¨ (æ‰‹æ„Ÿé¡ºæ»‘çš„å…³é”®)
                this.controls.dampingFactor = 0.05;
                this.controls.screenSpacePanning = true;
                this.controls.minDistance = 0.1;
                this.controls.maxDistance = 50;
                
                // è§£å†³è§¦æ‘¸å†²çª
                this.controls.listenToKeyEvents(window); 
            }

            setupGizmo() {
                this.transform = new TransformControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.transform.setSize(1.2); // åŠ å¤§å°ºå¯¸æ–¹ä¾¿æ‰‹æœºç‚¹
                
                // å…³é”®äº‹ä»¶ï¼šå½“æ‹–æ‹½ Gizmo æ—¶ï¼Œç¦ç”¨ OrbitControlsï¼Œé˜²æ­¢è§†è§’ä¹±è·‘
                this.transform.addEventListener('dragging-changed', (event) => {
                    this.controls.enabled = !event.value;
                });

                this.viewer.threeScene.add(this.transform);
            }

            async loadModel() {
                this.loader.innerText = "â³ ä¸‹è½½æ•°æ®ä¸­...";
                
                const response = await fetch(MODEL_URL);
                if(!response.ok) throw new Error("ä¸‹è½½å¤±è´¥");
                const blob = await response.blob();
                const url = URL.createObjectURL(blob) + '#.splat';

                this.loader.innerText = "âš™ï¸ è§£ææ¨¡å‹...";
                
                // åŠ è½½
                await this.viewer.addSplatScene(url, { 
                    'showLoadingUI': false,
                    'splatAlphaRemovalThreshold': 5
                });

                // è·å– Mesh
                this.splatMesh = this.viewer.getSplatScene(0);
                if (this.splatMesh) {
                    this.loader.style.display = 'none';
                    this.viewer.start(); // å¯åŠ¨å¼•æ“æ¸²æŸ“
                } else {
                    throw new Error("æ¨¡å‹åŠ è½½ä¸ºç©º");
                }
            }

            setMode(mode) {
                // æ›´æ–°æŒ‰é’® UI
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                document.getElementById(`mode-${mode === 'translate' ? 'move' : mode}`).classList.add('active');

                if (mode === 'view') {
                    this.transform.detach();
                    this.controls.enabled = true; // ç¡®ä¿è§†è§’å¯ä»¥è½¬åŠ¨
                } else {
                    if (this.splatMesh) {
                        this.transform.attach(this.splatMesh);
                        this.transform.setMode(mode);
                        // æ³¨æ„ï¼šè¿™é‡Œä¸è¦ç¦ç”¨ controlsï¼Œåªé  dragging-changed äº‹ä»¶è‡ªåŠ¨ç®¡ç†
                    }
                }
            }

            // è‡ªå®šä¹‰æ¸²æŸ“å¾ªç¯é’©å­
            animate() {
                requestAnimationFrame(() => this.animate());
                // å¿…é¡»æ¯ä¸€å¸§æ›´æ–° OrbitControls æ‰èƒ½æœ‰æƒ¯æ€§æ•ˆæœ
                if (this.controls) this.controls.update();
            }
        }

        // å¯åŠ¨åº”ç”¨
        const app = new App();
        app.init();
        
        // æŒ‚è½½åˆ° window æ–¹ä¾¿ HTML æŒ‰é’®è°ƒç”¨
        window.app = app;

    </script>
</body>
</html>
