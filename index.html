<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Perfect Gyro</title>
    <style>
        /* 1. å¼ºåˆ¶å…¨å±ï¼Œç¦æ­¢æ‰€æœ‰é»˜è®¤æ»šåŠ¨ */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; /* å…³é”®ï¼šç¦æ­¢æµè§ˆå™¨å¤„ç†è§¦æ‘¸ */
        }

        /* 2. é¡¶éƒ¨æç¤º (ç©¿é€ç‚¹å‡») */
        #top-ui {
            position: absolute; top: 20px; left: 0; width: 100%; text-align: center;
            pointer-events: none; z-index: 100;
        }
        .pill {
            background: rgba(0,0,0,0.6); color: #fff; padding: 8px 16px;
            border-radius: 20px; font-family: sans-serif; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.3);
            display: inline-block;
        }
        .pill.active { border-color: #00ff88; color: #00ff88; background: rgba(0,255,136,0.2); }

        /* 3. åº•éƒ¨æŒ‰é’® (å…è®¸ç‚¹å‡») */
        #bottom-ui {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 30px;
            pointer-events: none; /* å®¹å™¨ç©¿é€ */
            z-index: 100;
        }
        .btn {
            pointer-events: auto; /* æŒ‰é’®å¯ç‚¹ */
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid #555;
            background: rgba(40,40,40,0.9); color: white; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .btn:active { transform: scale(0.95); }
        .btn.gyro-active { border-color: #00ff88; background: #003311; color: #00ff88; }

        /* 4. è°ƒè¯•ä¿¡æ¯ (å¦‚æœåœ¨å±å¹•ä¸Šçœ‹åˆ°çº¢å­—ï¼Œé‚£æ˜¯æŠ¥é”™) */
        #debug {
            position: absolute; top: 0; left: 0; color: red; background: rgba(0,0,0,0.8);
            z-index: 9999; pointer-events: none; font-size: 12px;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="debug"></div>

    <div id="top-ui">
        <div class="pill" id="status-msg">ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨æµè§ˆ</div>
    </div>

    <div id="bottom-ui">
        <div class="btn" id="btn-reset">â†º</div>
        <div class="btn" id="btn-gyro">ğŸ“±</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ç®€å•çš„æ—¥å¿—è¾“å‡ºï¼Œå¦‚æœåŠ¨ä¸äº†çœ‹çœ‹å±å¹•å·¦ä¸Šè§’
        const debug = document.getElementById('debug');
        window.onerror = (e) => debug.innerHTML += `ERR: ${e}<br>`;

        // å…¨å±€å˜é‡
        let viewer, controls;
        let isGyroOn = false;
        
        // é™€èºä»ªä¸“ç”¨å˜é‡
        const baseQ = new THREE.Quaternion(); // åŸºå‡†è§’åº¦
        let startBeta = 0, startGamma = 0; // åˆå§‹æ‰‹æœºå§¿æ€
        let currBeta = 0, currGamma = 0;   // å½“å‰æ‰‹æœºå§¿æ€

        async function init() {
            // =========================================================
            // 1. åˆå§‹åŒ– Viewer (å®Œå…¨ç…§æ¬æš´åŠ›ç‰ˆé…ç½®)
            // =========================================================
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 1, 5],
                'initialCameraLookAt': [0, 0, 0],
                'useBuiltInControls': false, // ğŸš« å¿…é¡»å…³é—­ï¼Œå¦åˆ™æŠ¢äº‹ä»¶
                'selfDrivenMode': false,     // ğŸš« å¿…é¡»å…³é—­ï¼Œæ‰‹åŠ¨é©±åŠ¨
                'sharedMemoryForWorkers': false
            });

            const canvas = viewer.renderer.domElement;
            // å¼ºåˆ¶ Canvas æ ·å¼ï¼Œç¡®ä¿å®ƒåœ¨æœ€åº•å±‚ä¸”é“ºæ»¡
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.zIndex = '0'; 
            document.body.appendChild(canvas);

            // =========================================================
            // 2. åˆå§‹åŒ– OrbitControls (å¿…é¡»ç…§æ¬æš´åŠ›ç‰ˆ)
            // =========================================================
            // å…³é”®ç‚¹ï¼šç»‘å®šåˆ° document.bodyï¼Œè¿™æ˜¯ä¸Šæ¬¡æˆåŠŸçš„å…³é”®
            controls = new OrbitControls(viewer.camera, document.body);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 0.1;
            controls.maxDistance = 100;
            // è§£é”è§’åº¦é™åˆ¶ï¼Œè®©ä½ çœ‹å¾—æ›´çˆ½
            controls.minPolarAngle = 0; 
            controls.maxPolarAngle = Math.PI;

            // =========================================================
            // 3. å§‹ç»ˆç›‘å¬è®¾å¤‡æ–¹å‘ (åªè¯»å–ï¼Œæš‚ä¸åº”ç”¨)
            // =========================================================
            window.addEventListener('deviceorientation', (e) => {
                currBeta = e.beta || 0;
                currGamma = e.gamma || 0;
            });

            // =========================================================
            // 4. å¯åŠ¨æ¸²æŸ“å¾ªç¯ (æš´åŠ›é©±åŠ¨)
            // =========================================================
            animate();

            // =========================================================
            // 5. åŠ è½½æ¨¡å‹
            // =========================================================
            loadModel();

            // =========================================================
            // 6. æŒ‰é’®äº‹ä»¶
            // =========================================================
            document.getElementById('btn-reset').addEventListener('click', () => {
                controls.reset();
                if(isGyroOn) toggleGyro(); // é‡ç½®æ—¶å…³é—­é™€èºä»ª
            });

            document.getElementById('btn-gyro').addEventListener('click', toggleGyro);
        }

        async function loadModel() {
            const url = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';
            // ä½¿ç”¨æœ€åŸå§‹çš„ fetch
            const resp = await fetch(url);
            const blob = await resp.blob();
            const objUrl = URL.createObjectURL(blob) + '#.splat';
            
            await viewer.addSplatScene(objUrl, { 'showLoadingUI': true });
        }

        // =========================================================
        // æ ¸å¿ƒåŠŸèƒ½ï¼šé™€èºä»ªå¼€å…³é€»è¾‘
        // =========================================================
        function toggleGyro() {
            // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šç‚¹å‡»æŒ‰é’® -> ç”³è¯·æƒé™ -> åˆ‡æ¢çŠ¶æ€
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(state => {
                        if (state === 'granted') executeToggle();
                        else alert('è¯·å…è®¸é™€èºä»ªæƒé™');
                    })
                    .catch(console.error);
            } else {
                executeToggle();
            }
        }

        function executeToggle() {
            isGyroOn = !isGyroOn;
            
            const btn = document.getElementById('btn-gyro');
            const msg = document.getElementById('status-msg');

            if (isGyroOn) {
                // === å¼€å¯é™€èºä»ª ===
                controls.enabled = false; // 1. å…³æ‰è§¦æ§
                
                // 2. é”å®šå½“å‰è§†è§’ä¸ºâ€œåŸºå‡†â€
                baseQ.copy(viewer.camera.quaternion);
                startBeta = currBeta;
                startGamma = currGamma;

                btn.classList.add('gyro-active');
                msg.classList.add('active');
                msg.innerText = "ğŸ“± æ™ƒåŠ¨æ‰‹æœºé¢„è§ˆ";
            } else {
                // === å…³é—­é™€èºä»ª ===
                controls.enabled = true; // 1. æ¢å¤è§¦æ§
                
                btn.classList.remove('gyro-active');
                msg.classList.remove('active');
                msg.innerText = "ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨æµè§ˆ";
            }
        }

        // =========================================================
        // æ¸²æŸ“å¾ªç¯ (æ¯ä¸€å¸§éƒ½åœ¨è·‘)
        // =========================================================
        function animate() {
            requestAnimationFrame(animate);

            if (isGyroOn) {
                // --- é™€èºä»ªæ¨¡å¼ ---
                
                // 1. ç®—å‡ºåç§»é‡
                let deltaX = currBeta - startBeta;   // ä¸Šä¸‹
                let deltaY = currGamma - startGamma; // å·¦å³

                // 2. é™åˆ¶å¹…åº¦ (æœ€å¤§30åº¦)
                const limit = 30;
                deltaX = Math.max(-limit, Math.min(limit, deltaX));
                deltaY = Math.max(-limit, Math.min(limit, deltaY));

                // 3. è½¬æˆæ—‹è½¬ (çµæ•åº¦ 0.5)
                const sens = 0.5;
                const qx = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), THREE.MathUtils.degToRad(deltaX * sens));
                const qy = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), THREE.MathUtils.degToRad(deltaY * sens));

                // 4. åº”ç”¨åˆ°ç›¸æœº (åŸºå‡† * åè½¬)
                const target = baseQ.clone().multiply(qy).multiply(qx);
                viewer.camera.quaternion.slerp(target, 0.1); // å¹³æ»‘è¿‡æ¸¡

            } else {
                // --- è§¦æ§æ¨¡å¼ ---
                if (controls) controls.update(); // å¿…é¡»è°ƒç”¨ï¼Œå¦åˆ™æ²¡æƒ¯æ€§
            }

            // å¼ºåˆ¶æ¸²æŸ“
            if (viewer) {
                viewer.update();
                viewer.render();
            }
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
