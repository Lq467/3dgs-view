<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS ç»ˆæä¿®æ­£ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 10px; background: rgba(0,0,0,0.6); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        #ui-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.85); padding: 15px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000;
        }

        .slider-row {
            display: flex; align-items: center; justify-content: space-between;
            color: white; font-size: 14px;
        }
        .slider-row label { width: 50px; }
        .slider-row input { flex: 1; margin: 0 10px; }
        .slider-row span { width: 30px; text-align: right; color: #aaa; }

        .btn-row {
            display: flex; justify-content: center; margin-top: 5px;
        }

        #gyro-btn {
            padding: 12px 30px; font-size: 16px; border-radius: 25px; border: none;
            background: #eee; color: #333; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }
        #gyro-btn.active {
            background: #0f0; color: black; box-shadow: 0 0 15px #0f0;
        }
    </style>
    
    <!-- å¼•ç”¨ v0.4.7 å¼•æ“ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">å‡†å¤‡åŠ è½½...</div>

    <div id="ui-panel" style="display:none">
        <!-- è·ç¦»æ»‘æ†ï¼šå¸®ä½ æ‹‰è¿œç›¸æœºï¼Œçœ‹æ¸…å…¨è²Œ -->
        <div class="slider-row">
            <label>è·ç¦»</label>
            <input type="range" id="cam-dist" min="1" max="100" step="1" value="5">
            <span id="dist-val">5</span>
        </div>
        <!-- ç¼©æ”¾æ»‘æ†ï¼šå¦‚æœæ¨¡å‹å¤ªå¤§å°±ç¼©å° -->
        <div class="slider-row">
            <label>ç¼©æ”¾</label>
            <input type="range" id="model-scale" min="0.1" max="5" step="0.1" value="1">
            <span id="scale-val">1.0</span>
        </div>
        
        <div class="btn-row">
            <button id="gyro-btn">ğŸ§­ å¼€å¯é™€èºä»ª</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä½ çš„ HF ç›´é“¾
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const uiPanel = document.getElementById('ui-panel');
        const gyroBtn = document.getElementById('gyro-btn');
        
        // æ»‘æ†
        const distSlider = document.getElementById('cam-dist');
        const scaleSlider = document.getElementById('model-scale');
        const distVal = document.getElementById('dist-val');
        const scaleVal = document.getElementById('scale-val');

        let viewer;
        let splatScene; 
        let isGyroActive = false;
        let initialGyro = null;
        
        // é™€èºä»ªçµæ•åº¦ & è§’åº¦é™åˆ¶
        const CLAMP_X = 0.6; // ä¸Šä¸‹
        const CLAMP_Y = 0.8; // å·¦å³

        async function main() {
            // 1. åˆå§‹åŒ–å¼•æ“
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                // åˆå§‹æŠŠç›¸æœºæ”¾è¿œç‚¹ (Z=5)
                'initialCameraPosition': [0, 1, 5], 
                'initialCameraLookAt': [0, 0, 0],
                'useBuiltInControls': true, // å¼€å¯è§¦æ‘¸
                'sharedMemoryForWorkers': false,
            });
            document.body.appendChild(viewer.renderer.domElement);

            try {
                // 2. æ‰‹åŠ¨ä¸‹è½½
                status.innerText = "ğŸš€ æ­£åœ¨ä¸‹è½½...";
                const response = await fetch(MODEL_URL);
                if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥: " + response.status);

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0; 
                let chunks = []; 

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    let progress = contentLength ? Math.round((receivedLength / contentLength) * 100) + "%" : (receivedLength / 1024 / 1024).toFixed(1) + " MB";
                    status.innerText = `ğŸ“¥ ä¸‹è½½ä¸­... ${progress}`;
                }

                status.innerText = "âš™ï¸ å¤„ç†æ•°æ®...";
                
                // 3. ç”Ÿæˆ Blob URL
                const blob = new Blob(chunks);
                const originalUrl = URL.createObjectURL(blob);
                
                // ğŸ”´ å…³é”®ä¿®å¤ï¼šåœ¨é“¾æ¥åé¢æ‹¼ä¸Š #.splat
                // è¿™æ ·æ—¢æ˜¯å­—ç¬¦ä¸²(String)ï¼Œåˆä»¥ .splat ç»“å°¾ï¼Œå¼•æ“æ‰ä¼šé€šè¿‡
                const fakeUrl = originalUrl + '#.splat';

                // 4. åŠ è½½åœºæ™¯
                const scenes = await viewer.addSplatScene(fakeUrl, {
                    'showLoadingUI': false,
                    'splatAlphaRemovalThreshold': 2, // ç§»é™¤æ‚ç‚¹
                });
                
                splatScene = scenes[0]; // æ‹¿åˆ°æ¨¡å‹å¼•ç”¨æ–¹ä¾¿ç¼©æ”¾

                status.innerText = "âœ… åŠ è½½æˆåŠŸï¼è¯·è°ƒèŠ‚ä¸‹æ–¹æ»‘æ†";
                setTimeout(() => { status.style.display = 'none'; }, 2000);
                
                uiPanel.style.display = 'block';
                viewer.start();

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
            }
        }

        // ================= æ»‘æ†é€»è¾‘ =================
        
        // è°ƒèŠ‚ç›¸æœºè·ç¦»
        distSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            distVal.innerText = val;
            
            // ç§»åŠ¨ç›¸æœº Z è½´
            viewer.camera.position.z = val;
            viewer.camera.lookAt(0, 0, 0);
            
            // æ›´æ–°æ§åˆ¶å™¨ä¸­å¿ƒç‚¹
            if (viewer.controls) viewer.controls.update();
        });

        // è°ƒèŠ‚æ¨¡å‹å¤§å°
        scaleSlider.addEventListener('input', (e) => {
            if (!splatScene) return;
            const val = parseFloat(e.target.value);
            scaleVal.innerText = val;
            
            // å®æ—¶ç¼©æ”¾
            splatScene.scale.set(val, val, val);
        });

        // ================= é™€èºä»ªé€»è¾‘ =================

        gyroBtn.addEventListener('click', () => {
            if (!isGyroActive) {
                requestGyro();
            } else {
                // å…³é—­é™€èºä»ª
                isGyroActive = false;
                gyroBtn.classList.remove('active');
                gyroBtn.innerText = "ğŸ§­ å¼€å¯é™€èºä»ª";
                
                // æ¢å¤è§¦æ‘¸
                if (viewer.controls) viewer.controls.enabled = true;
                window.removeEventListener('deviceorientation', handleOrientation);
            }
        });

        function requestGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateGyro();
                        } else {
                            alert('éœ€è¦æˆæƒæ‰èƒ½ä½¿ç”¨é™€èºä»ª');
                        }
                    }).catch(console.error);
            } else {
                activateGyro();
            }
        }

        function activateGyro() {
            isGyroActive = true;
            initialGyro = null;
            gyroBtn.classList.add('active');
            gyroBtn.innerText = "ğŸ›‘ å…³é—­é™€èºä»ª";
            
            // âŒ å¿…é¡»ç¦ç”¨è§¦æ‘¸ï¼Œå¦åˆ™å’Œé™€èºä»ªå†²çª
            if (viewer.controls) viewer.controls.enabled = false;
            
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleOrientation(event) {
            if (!viewer || !isGyroActive) return;

            if (!initialGyro && event.alpha !== null) {
                initialGyro = { beta: event.beta, gamma: event.gamma };
                return;
            }
            if (!initialGyro) return;

            let deltaX = (event.beta - initialGyro.beta) * (Math.PI / 180);
            let deltaY = (event.gamma - initialGyro.gamma) * (Math.PI / 180);

            // é™åˆ¶é˜²ç©¿å¸®
            deltaX = Math.max(-CLAMP_X, Math.min(CLAMP_X, deltaX));
            deltaY = Math.max(-CLAMP_Y, Math.min(CLAMP_Y, deltaY));

            viewer.camera.rotation.set(deltaX, deltaY, 0, 'YXZ');
            viewer.update();
        }

        main();
    </script>
</body>
</html>
