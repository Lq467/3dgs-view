<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS å®Œç¾å†…æ ¸ç‰ˆ</title>
    <style>
        /* 1. åŸºç¡€ç¯å¢ƒï¼šé»‘åº•ã€æ— æ»šåŠ¨ */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; /* å…³é”®ï¼šç¦æ­¢ç³»ç»Ÿè§¦æ‘¸ï¼Œå…¨æƒäº¤ç»™JS */
            font-family: sans-serif; user-select: none;
        }

        /* 2. é¡¶éƒ¨é”å®šæŒ‰é’® (æ ¸å¿ƒäº¤äº’) */
        #top-area {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; pointer-events: none; z-index: 2000;
        }
        #lock-btn {
            pointer-events: auto; /* å…è®¸ç‚¹å‡» */
            background: rgba(0, 0, 0, 0.6); color: #fff; border: 1px solid #555;
            padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; gap: 8px; backdrop-filter: blur(5px);
            transition: all 0.2s; opacity: 0; transform: translateY(-20px);
        }
        #lock-btn.visible { opacity: 1; transform: translateY(0); }
        #lock-btn.locked { background: #ffaa00; color: #000; border-color: #ffaa00; box-shadow: 0 0 15px rgba(255,170,0,0.5); }

        /* 3. åº•éƒ¨æ“ä½œæ  */
        #dock {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20,20,20,0.95); padding: 10px; border-radius: 20px;
            display: flex; gap: 12px; border: 1px solid #444; z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        .btn {
            width: 55px; height: 55px; background: transparent; border: none;
            color: #888; font-size: 24px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn span { font-size: 11px; margin-top: 3px; }
        
        .btn.active { background: #333; color: white; transform: translateY(-3px); }
        .btn.active.view { color: #00ff88; }
        .btn.active.edit { color: #00aaff; }

        /* åˆ†å‰²çº¿ */
        .sep { width: 1px; height: 35px; background: #444; margin: 10px 2px; }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .loader-text { color:#00ff88; margin-top:15px; font-family:monospace; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="font-size:30px;">ğŸ›°ï¸</div>
        <div class="loader-text" id="load-msg">å¯åŠ¨å¼•æ“...</div>
    </div>

    <div id="top-area">
        <button id="lock-btn" onclick="app.toggleLock()">ğŸ”“ è§†è§’æœªé”</button>
    </div>

    <div id="dock">
        <button class="btn active view" id="b-view" onclick="app.setMode('view')">
            ğŸ‘ï¸<span>æµè§ˆ</span>
        </button>
        <div class="sep"></div>
        <button class="btn" id="b-translate" onclick="app.setMode('translate')">
            âœ¢<span>ç§»åŠ¨</span>
        </button>
        <button class="btn" id="b-rotate" onclick="app.setMode('rotate')">
            â†»<span>æ—‹è½¬</span>
        </button>
        <button class="btn" id="b-scale" onclick="app.setMode('scale')">
            â¤¢<span>ç¼©æ”¾</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.gizmo = null;
                this.sceneRoot = null; // æˆ‘ä»¬çš„æ¨¡å‹å®¹å™¨
                this.isLocked = false;
            }

            async init() {
                try {
                    // 1. åˆå§‹åŒ– Viewer (å®Œå…¨å¤åˆ»â€œå®Œç¾ç‰ˆâ€çš„é…ç½®)
                    // æ ¸å¿ƒï¼šå…³é—­å†…ç½®æ§åˆ¶ï¼Œå…³é—­è‡ªé©±åŠ¨
                    this.viewer = new Viewer({
                        'cameraUp': [0, 1, 0],
                        'initialCameraPosition': [0, 1, 5],
                        'initialCameraLookAt': [0, 0, 0],
                        'useBuiltInControls': false, 
                        'selfDrivenMode': false,
                        'sharedMemoryForWorkers': false
                    });
                    
                    document.body.appendChild(this.viewer.renderer.domElement);

                    // 2. åˆ›å»ºå®¹å™¨ Group (è§£å†³æ¨¡å‹æ— æ³•ç§»åŠ¨çš„é—®é¢˜)
                    this.sceneRoot = new THREE.Group();
                    this.viewer.threeScene.add(this.sceneRoot);

                    // 3. OrbitControls (ç»‘å®šåˆ° document.body ç¡®ä¿å…¨å±å“åº”)
                    this.controls = new OrbitControls(this.viewer.camera, document.body);
                    this.controls.enableDamping = true; // æƒ¯æ€§
                    this.controls.dampingFactor = 0.05;
                    // ğŸ”“ è§£é”è§†è§’é™åˆ¶ï¼šå…è®¸ä»æ­£ä¸Šæ–¹çœ‹åˆ°æ­£ä¸‹æ–¹ (0 ~ PI)
                    this.controls.minPolarAngle = 0;
                    this.controls.maxPolarAngle = Math.PI; 
                    this.controls.minDistance = 0.1;
                    this.controls.maxDistance = 100;

                    // 4. TransformControls (åæ ‡è½´)
                    this.gizmo = new TransformControls(this.viewer.camera, this.viewer.renderer.domElement);
                    this.gizmo.setSize(1.2); // æ”¾å¤§
                    this.gizmo.setSpace('local');
                    // ğŸ”¥ å¼ºåˆ¶åæ ‡è½´ç©¿é€æ˜¾ç¤º (DepthTest False)
                    this.gizmo.traverse(child => {
                        if(child.material) {
                            child.material.depthTest = false;
                            child.material.depthWrite = false;
                            child.renderOrder = 9999;
                        }
                    });

                    // è‡ªåŠ¨äº’æ–¥ï¼šæ‹–åŠ¨åæ ‡è½´æ—¶ï¼Œæš‚åœç›¸æœº
                    this.gizmo.addEventListener('dragging-changed', (event) => {
                        if (!this.isLocked) {
                            this.controls.enabled = !event.value;
                        }
                    });
                    this.viewer.threeScene.add(this.gizmo);

                    // 5. æ·»åŠ ç½‘æ ¼è¾…åŠ©
                    const grid = new THREE.GridHelper(20, 20, 0x444444, 0x111111);
                    grid.position.y = -1;
                    this.viewer.threeScene.add(grid);

                    // 6. å¯åŠ¨æ‰‹åŠ¨æ¸²æŸ“å¾ªç¯
                    this.animate();

                    // 7. åŠ è½½æ¨¡å‹
                    await this.loadModel();

                } catch (e) {
                    alert("å¯åŠ¨å¤±è´¥: " + e.message);
                }
            }

            async loadModel() {
                const msg = document.getElementById('load-msg');
                msg.innerText = "ä¸‹è½½æ•°æ®...";
                
                const response = await fetch(MODEL_URL);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob) + '#.splat';

                msg.innerText = "è§£ææ¨¡å‹...";
                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });

                // ç­‰å¾…æ¨¡å‹ç”Ÿæˆ
                setTimeout(() => {
                    const splat = this.viewer.getSplatScene(0);
                    if (splat) {
                        // âš ï¸ æ ¸å¿ƒä¿®å¤ï¼šæŠŠæ¨¡å‹æ”¾å…¥ sceneRoot å®¹å™¨
                        this.sceneRoot.add(splat);
                        
                        document.getElementById('loader').style.display = 'none';
                        this.setMode('view'); // é»˜è®¤è¿›å…¥æµè§ˆ
                    }
                }, 500);
            }

            setMode(mode) {
                // UI æ›´æ–°
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active', 'view', 'edit'));
                const btn = document.getElementById('b-' + mode);
                btn.classList.add('active', mode === 'view' ? 'view' : 'edit');

                const lockBtn = document.getElementById('lock-btn');

                if (mode === 'view') {
                    // === æµè§ˆæ¨¡å¼ ===
                    this.gizmo.detach();
                    this.unlockCamera(); // å¼ºåˆ¶è§£é”
                    lockBtn.classList.remove('visible'); // éšè—é”å®šæŒ‰é’®
                } else {
                    // === ç¼–è¾‘æ¨¡å¼ ===
                    this.gizmo.attach(this.sceneRoot); // é™„ç€åˆ°å®¹å™¨ä¸Š
                    this.gizmo.setMode(mode);
                    
                    lockBtn.classList.add('visible'); // æ˜¾ç¤ºé”å®šæŒ‰é’®
                    // é»˜è®¤å…ˆä¸é”ï¼Œè®©ç”¨æˆ·è‡ªå·±é”ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©é»˜è®¤é”
                    // è¿™é‡Œä¸ºäº†é˜²æ­¢è¯¯è§¦ï¼Œæˆ‘ä»¬**è‡ªåŠ¨é”å®š**ä¸€ä¸‹è¯•è¯•ï¼Ÿ
                    // ä¸ï¼Œè¿˜æ˜¯è®©ç”¨æˆ·æ‰‹åŠ¨é”æ¯”è¾ƒç¬¦åˆç›´è§‰ã€‚
                }
            }

            toggleLock() {
                if (this.isLocked) this.unlockCamera();
                else this.lockCamera();
            }

            lockCamera() {
                this.isLocked = true;
                this.controls.enabled = false; // ç¦æ­¢ç›¸æœº
                const btn = document.getElementById('lock-btn');
                btn.classList.add('locked');
                btn.innerText = "ğŸ”’ è§†è§’å·²é” (å¯æ‹–åŠ¨æ¨¡å‹)";
            }

            unlockCamera() {
                this.isLocked = false;
                this.controls.enabled = true; // å¯ç”¨ç›¸æœº
                const btn = document.getElementById('lock-btn');
                btn.classList.remove('locked');
                btn.innerText = "ğŸ”“ è§†è§’æœªé”";
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                // å¿…é¡»æ‰‹åŠ¨æ›´æ–°
                this.controls.update();
                this.viewer.update();
                this.viewer.render();
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
