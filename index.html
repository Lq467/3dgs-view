<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Object Grip</title>
    <style>
        /* åŸºç¡€ç¯å¢ƒ */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: -apple-system, sans-serif; user-select: none;
        }

        /* é¡¶éƒ¨æç¤º */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: center; padding-top: 20px;
            pointer-events: none; z-index: 100;
        }
        .pill {
            background: rgba(30,30,30,0.6); color: #fff; padding: 8px 20px;
            border-radius: 30px; font-size: 14px; border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px); transition: all 0.3s;
        }
        .pill.active {
            border-color: #00ff88; color: #00ff88; background: rgba(0, 255, 136, 0.15);
            box-shadow: 0 0 20px rgba(0,255,136,0.2);
        }

        /* åº•éƒ¨æŒ‰é’® */
        #controls {
            position: absolute; bottom: 50px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 40px;
            pointer-events: none; z-index: 100;
        }
        .btn {
            pointer-events: auto;
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid #444;
            background: rgba(30,30,30,0.9); color: #ccc; font-size: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.1s, border-color 0.3s;
        }
        .btn:active { transform: scale(0.9); }
        .btn.active { border-color: #00ff88; color: #00ff88; background: #002211; }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .loader-text { color:#00ff88; margin-top:20px; font-family:monospace; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="font-size:50px;">ğŸ—¿</div>
        <div class="loader-text">åŠ è½½æ¨¡å‹ä¸­...</div>
    </div>

    <div id="top-bar">
        <div class="pill" id="status-msg">ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨è°ƒæ•´æœ€ä½³è§’åº¦</div>
    </div>

    <div id="controls">
        <div class="btn" id="btn-reset">â†º</div>
        <div class="btn" id="btn-gyro">ğŸ“±</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä¾ç„¶åŸºäºè¿™ä¸ªæœ€ç¨³çš„ç‰ˆæœ¬
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.isGyroOn = false;

                // é™€èºä»ªè®¡ç®—å˜é‡
                this.startBeta = 0;
                this.startGamma = 0;
                this.currBeta = 0;
                this.currGamma = 0;
                
                // æ ¸å¿ƒï¼šè®°å½•åŸºå‡†ä½ç½®å‘é‡ï¼ˆè€Œä¸æ˜¯æ—‹è½¬å››å…ƒæ•°ï¼‰
                this.basePosition = new THREE.Vector3(); 
                this.cameraTarget = new THREE.Vector3(0, 0, 0); // å‡è®¾æ¨¡å‹åœ¨ä¸­å¿ƒ
            }

            async init() {
                // 1. Viewer é…ç½® (ä¿æŒåŸæ ·ï¼Œæœ€ç¨³)
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 1, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, 
                    'selfDrivenMode': false,
                    'sharedMemoryForWorkers': false
                });

                // å¼ºåˆ¶ Canvas å…¨å±
                const canvas = this.viewer.renderer.domElement;
                canvas.style.position = 'absolute'; canvas.style.top = '0'; canvas.style.zIndex = '0';
                document.body.appendChild(canvas);

                // 2. è§¦æ§é…ç½® (OrbitControls)
                this.controls = new OrbitControls(this.viewer.camera, document.body);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 0.1;
                this.controls.maxDistance = 100;

                // 3. ç›‘å¬é™€èºä»ªæ•°æ®
                window.addEventListener('deviceorientation', (e) => {
                    this.currBeta = e.beta || 0;
                    this.currGamma = e.gamma || 0;
                });

                // 4. æ¸²æŸ“å¾ªç¯
                this.animate();

                // 5. åŠ è½½æ¨¡å‹
                await this.loadModel();

                // 6. ç»‘å®šæŒ‰é’®
                this.bindEvents();
            }

            async loadModel() {
                const resp = await fetch(MODEL_URL);
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob) + '#.splat';
                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });
                
                document.getElementById('loader').style.display = 'none';
            }

            toggleGyro() {
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(res => {
                            if (res === 'granted') this.setGyroState(!this.isGyroOn);
                            else alert("éœ€è¦æƒé™");
                        });
                } else {
                    this.setGyroState(!this.isGyroOn);
                }
            }

            setGyroState(active) {
                this.isGyroOn = active;
                const btn = document.getElementById('btn-gyro');
                const msg = document.getElementById('status-msg');

                if (active) {
                    // === å¼€å¯é™€èºä»ª ===
                    this.controls.enabled = false; // æš‚åœæ‰‹æŒ‡

                    // 1. è®°å½•åˆå§‹æ‰‹æœºè§’åº¦
                    this.startBeta = this.currBeta;
                    this.startGamma = this.currGamma;

                    // 2. æ ¸å¿ƒï¼šè®°å½•ç›¸æœºç›¸å¯¹äºä¸­å¿ƒç‚¹çš„åˆå§‹ä½ç½®å‘é‡
                    // è¿™æ ·æˆ‘ä»¬æ˜¯åŸºäºâ€œå½“å‰ä½ç½®â€è¿›è¡Œåç§»ï¼Œè€Œä¸æ˜¯é‡ç½®è§†è§’
                    this.basePosition.copy(this.viewer.camera.position).sub(this.cameraTarget);

                    btn.classList.add('active');
                    msg.classList.add('active');
                    msg.innerText = "ğŸ“± å€¾æ–œæ‰‹æœºæŠŠç©æ¨¡å‹";
                } else {
                    // === å…³é—­é™€èºä»ª ===
                    this.controls.enabled = true; // æ¢å¤æ‰‹æŒ‡
                    btn.classList.remove('active');
                    msg.classList.remove('active');
                    msg.innerText = "ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨è°ƒæ•´æœ€ä½³è§’åº¦";
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                if (this.isGyroOn) {
                    // ==============================
                    // ğŸŒŸ æ ¸å¿ƒç®—æ³•ï¼šè½¨é“å…¬è½¬ (Orbit)
                    // ==============================

                    // 1. ç®—å‡ºåç§»é‡
                    let deltaX = this.currBeta - this.startBeta;   // ä¸Šä¸‹å€¾æ–œ
                    let deltaY = this.currGamma - this.startGamma; // å·¦å³å€¾æ–œ

                    // 2. é™åˆ¶è§’åº¦ (æœ€å¤§20åº¦ï¼Œé˜²æ­¢ç©¿å¸®)
                    const MAX_DEG = 20; 
                    deltaX = Math.max(-MAX_DEG, Math.min(MAX_DEG, deltaX));
                    deltaY = Math.max(-MAX_DEG, Math.min(MAX_DEG, deltaY));

                    // 3. è½¬æ¢é€»è¾‘ (æ ¹æ®ä½ çš„è¦æ±‚åè½¬)
                    // æ‰‹æœºå‘å·¦å€¾æ–œ (Gamma è´Ÿæ•°) -> æˆ‘ä»¬å¸Œæœ›æ¨¡å‹å‘å·¦è½¬ -> ç›¸å½“äºç›¸æœºå‘å·¦å…¬è½¬
                    // æ‰‹æŒ‡å³æ»‘ = ç›¸æœºå‘å·¦å…¬è½¬ = Gamma è´Ÿæ•°
                    
                    const sensitivity = 0.02; // ç³»æ•°ï¼Œè¶Šå°è¶Šå¹³æ»‘

                    // 4. è®¡ç®—æ—‹è½¬çŸ©é˜µ
                    // ç»• Y è½´è½¬ (å·¦å³) -> å¯¹åº” Gamma
                    // æ³¨æ„æ–¹å‘ï¼šdeltaY ä¸ºè´Ÿæ—¶ (å·¦å€¾)ï¼Œæˆ‘ä»¬å¸Œæœ›ç›¸æœºå‘å·¦è·‘ï¼Œæ‰€ä»¥è§’åº¦ä¹Ÿæ˜¯è´Ÿçš„
                    const rotateY = deltaY * sensitivity * 1.5; // 1.5å€è®©å·¦å³çµæ•ç‚¹
                    
                    // ç»• ç›¸æœºå³å‘é‡ è½¬ (ä¸Šä¸‹) -> å¯¹åº” Beta
                    const rotateX = deltaX * sensitivity;

                    // 5. åº”ç”¨æ—‹è½¬åˆ° Position å‘é‡ä¸Š
                    const tempPos = this.basePosition.clone();
                    
                    // å…ˆå·¦å³è½¬ (ç»•ä¸–ç•ŒYè½´)
                    tempPos.applyAxisAngle(new THREE.Vector3(0, 1, 0), THREE.MathUtils.degToRad(-deltaY * 2)); // è´Ÿå·ä¿®æ­£æ–¹å‘

                    // å†ä¸Šä¸‹è½¬ (ç»•ç›¸æœºæœ¬åœ°Xè½´) - è¿™æ ·æ›´è‡ªç„¶ï¼Œåƒæ‹¿åœ¨æ‰‹é‡Œ
                    // è·å–å½“å‰ç›¸æœºçš„å³å‘é‡
                    const cameraRight = new THREE.Vector3(1, 0, 0).applyQuaternion(this.viewer.camera.quaternion);
                    tempPos.applyAxisAngle(cameraRight, THREE.MathUtils.degToRad(-deltaX * 2));

                    // 6. æ›´æ–°ç›¸æœºä½ç½®
                    const targetPos = this.cameraTarget.clone().add(tempPos);
                    
                    // ä½¿ç”¨ lerp å¹³æ»‘æ’å€¼ï¼Œæ¶ˆé™¤æŠ–åŠ¨
                    this.viewer.camera.position.lerp(targetPos, 0.1);
                    this.viewer.camera.lookAt(this.cameraTarget);

                } else {
                    // è§¦æ§æ¨¡å¼
                    this.controls.update();
                }

                this.viewer.update();
                this.viewer.render();
            }

            bindEvents() {
                document.getElementById('btn-reset').addEventListener('click', () => {
                    this.controls.reset();
                    if(this.isGyroOn) this.setGyroState(false);
                });
                document.getElementById('btn-gyro').addEventListener('click', () => this.toggleGyro());
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
