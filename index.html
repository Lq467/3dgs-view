<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS SuperEditor (Box Mode)</title>
    <style>
        /* å…¨å±€è®¾å®š */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #111;
            touch-action: none; /* ç¦æ­¢ç³»ç»Ÿæ‰‹åŠ¿ */
            font-family: sans-serif; user-select: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ¡ */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px; background: rgba(20,20,20,0.9); border-bottom: 1px solid #333;
            color: #888; font-size: 14px; text-align: center; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        #status-text { font-weight: bold; color: #00ff88; }
        
        /* åº•éƒ¨å·¥å…·æ  */
        #dock {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #222; padding: 8px; border-radius: 16px;
            display: flex; gap: 10px; border: 1px solid #444; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .btn {
            width: 50px; height: 50px; background: #333; border: 1px solid #444;
            border-radius: 12px; color: #aaa; font-size: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn span { font-size: 10px; margin-top: 2px; }

        /* æ¿€æ´»æ ·å¼ */
        .btn.active { background: #007bff; color: white; border-color: #0056b3; }
        .btn.active.mode-view { background: #00ff88; color: #000; }
        
        /* åŠ è½½é®ç½© */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background:#111; z-index:5000; display:flex; flex-direction:column;
            align-items:center; justify-content:center;
        }
        .bar-box { width:200px; height:4px; background:#333; margin-top:15px; border-radius:2px; }
        .bar-fill { width:0%; height:100%; background:#00ff88; transition:width 0.1s; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="color:white; font-weight:bold;">æ­£åœ¨åŠ è½½ç¼–è¾‘å™¨èµ„æº...</div>
        <div class="bar-box"><div class="bar-fill" id="progress"></div></div>
        <div style="color:#666; font-size:12px; margin-top:10px;" id="p-text">0%</div>
    </div>

    <div id="top-bar">
        <div id="status-text">åˆå§‹åŒ–ä¸­...</div>
        <button onclick="app.resetCamera()" style="background:#444; color:white; border:none; padding:5px 10px; border-radius:4px;">é‡ç½®è§†è§’</button>
    </div>

    <div id="dock">
        <button class="btn active mode-view" id="b-view" onclick="app.setMode('view')">
            ğŸ‘ï¸<span>æµè§ˆ</span>
        </button>
        <div style="width:1px; background:#444; margin:0 5px;"></div>
        <button class="btn" id="b-translate" onclick="app.setMode('translate')">
            âœ¢<span>ç§»åŠ¨</span>
        </button>
        <button class="btn" id="b-rotate" onclick="app.setMode('rotate')">
            â†»<span>æ—‹è½¬</span>
        </button>
        <button class="btn" id="b-scale" onclick="app.setMode('scale')">
            â¤¢<span>ç¼©æ”¾</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä½ çš„æ¨¡å‹
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.orbit = null;
                this.gizmo = null;
                this.container = null; // è¿™æ˜¯ä¸€ä¸ª Groupï¼Œç”¨æ¥è£… Splat
                this.helper = null;    // é»„è‰²çš„åŒ…å›´ç›’
            }

            async init() {
                // 1. åˆå§‹åŒ–å¼•æ“
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 1, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, // ğŸš« å¿…é¡»å…³é—­
                    'selfDrivenMode': false,     // æ‰‹åŠ¨é©±åŠ¨
                    'sharedMemoryForWorkers': false
                });

                const canvas = this.viewer.renderer.domElement;
                document.body.appendChild(canvas);

                // 2. åˆ›å»ºä¸€ä¸ªå®¹å™¨ Group
                // æˆ‘ä»¬ä¸ç›´æ¥æ§åˆ¶ Splatï¼Œè€Œæ˜¯æ§åˆ¶è¿™ä¸ª Group
                this.container = new THREE.Group();
                this.viewer.threeScene.add(this.container);

                // 3. OrbitControls (è§†è§’)
                this.orbit = new OrbitControls(this.viewer.camera, canvas);
                this.orbit.enableDamping = true;
                this.orbit.dampingFactor = 0.05;
                
                // 4. TransformControls (åæ ‡è½´)
                this.gizmo = new TransformControls(this.viewer.camera, canvas);
                this.gizmo.setSize(1.2); 
                // å¼ºåˆ¶åæ ‡è½´åœ¨æœ€ä¸Šå±‚
                this.gizmo.traverse(c => {
                    if(c.material) { c.material.depthTest = false; c.renderOrder = 9999; }
                });
                this.viewer.threeScene.add(this.gizmo);

                // 5. å¯åŠ¨å¾ªç¯
                this.animate();

                // 6. åŠ è½½æ¨¡å‹
                await this.loadModel();
            }

            async loadModel() {
                const pBar = document.getElementById('progress');
                const pText = document.getElementById('p-text');

                // ä¸‹è½½
                const resp = await fetch(MODEL_URL);
                const len = +resp.headers.get('Content-Length');
                const reader = resp.body.getReader();
                let received = 0;
                let chunks = [];

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    chunks.push(value);
                    received += value.length;
                    if(len) {
                        const pct = Math.round((received/len)*100);
                        pBar.style.width = pct + "%";
                        pText.innerText = pct + "%";
                    }
                }
                
                // åŠ è½½
                const blob = new Blob(chunks);
                const url = URL.createObjectURL(blob) + '#.splat';
                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });

                // âš ï¸ å…³é”®æ“ä½œï¼šè·å–æ¨¡å‹å¹¶æ”¾å…¥å®¹å™¨
                setTimeout(() => {
                    const splat = this.viewer.getSplatScene(0);
                    if (splat) {
                        this.container.add(splat);
                        
                        // æ·»åŠ ä¸€ä¸ªé»„è‰²çš„åŒ…å›´ç›’ï¼Œè®©ä½ çŸ¥é“æ¨¡å‹åœ¨å“ªé‡Œ
                        this.helper = new THREE.BoxHelper(this.container, 0xffff00);
                        this.viewer.threeScene.add(this.helper);
                        
                        document.getElementById('loader').style.display = 'none';
                        this.setMode('view');
                    }
                }, 200);
            }

            setMode(mode) {
                // UI æ›´æ–°
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active', 'mode-view'));
                const btn = document.getElementById(mode === 'view' ? 'b-view' : 'b-' + mode);
                btn.classList.add('active');
                if(mode === 'view') btn.classList.add('mode-view');

                const status = document.getElementById('status-text');

                if (mode === 'view') {
                    // === æµè§ˆæ¨¡å¼ ===
                    this.gizmo.detach();       // ç§»é™¤åæ ‡è½´
                    this.orbit.enabled = true; // âœ… å¼€å¯è§†è§’æ—‹è½¬
                    
                    if(this.helper) this.helper.visible = false; // éšè—åŒ…å›´ç›’
                    
                    status.innerText = "ğŸ‘€ æµè§ˆæ¨¡å¼ (å¯ä»¥è½¬åŠ¨è§†è§’)";
                    status.style.color = "#00ff88";

                } else {
                    // === ç¼–è¾‘æ¨¡å¼ ===
                    if (this.container) {
                        this.gizmo.attach(this.container); // é™„ç€åˆ°å®¹å™¨
                        this.gizmo.setMode(mode);
                        
                        if(this.helper) {
                            this.helper.visible = true; // æ˜¾ç¤ºåŒ…å›´ç›’
                            this.helper.update();
                        }
                    }

                    this.orbit.enabled = false; // â›”ï¸ å½»åº•é”æ­»è§†è§’
                    
                    status.innerText = `ğŸ”§ ${mode}æ¨¡å¼ (è§†è§’å·²é”ï¼Œè¯·æ‹–åŠ¨åæ ‡è½´)`;
                    status.style.color = "#00aaff";
                }
            }

            resetCamera() {
                this.orbit.reset();
                this.viewer.camera.position.set(0, 1, 5);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                this.orbit.update();
                
                // å®æ—¶æ›´æ–°åŒ…å›´ç›’ï¼Œè®©å®ƒè·Ÿç€æ¨¡å‹åŠ¨
                if (this.helper && this.container) {
                    this.helper.update();
                }

                this.viewer.update();
                this.viewer.render();
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
