<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS ç§»åŠ¨ç«¯ä¸“ä¸šç‰ˆ</title>
    <style>
        /* å…¨å±€ç¦æ­¢é»˜è®¤è§¦æ§ï¼Œäº¤ç»™3Då¼•æ“ */
        body { 
            margin: 0; overflow: hidden; background-color: #111; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æç¤º */
        #status-pill {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: #0f0;
            padding: 8px 20px; border-radius: 30px; font-size: 14px; font-weight: bold;
            pointer-events: none; z-index: 2000; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        /* æ¨¡å¼æŒ‡ç¤ºå™¨ (å±å¹•ä¸­å¤®ä¸‹æ–¹) */
        #mode-indicator {
            position: absolute; bottom: 120px; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 900;
            opacity: 0; transition: opacity 0.3s;
        }
        .mode-tag {
            background: rgba(0, 123, 255, 0.8); color: white;
            padding: 6px 12px; border-radius: 4px; font-size: 12px;
            display: inline-block; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* åº•éƒ¨ä¸»æ§æ  */
        #dock {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            height: 70px;
            background: rgba(30, 30, 30, 0.95);
            border-radius: 20px;
            display: flex; justify-content: space-around; align-items: center;
            border: 1px solid #444;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 0 10px;
        }

        /* å¤§æŒ‰é’®æ ·å¼ */
        .dock-btn {
            width: 55px; height: 55px;
            border-radius: 12px; border: none;
            background: transparent; color: #888;
            font-size: 24px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; position: relative;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .dock-btn span { font-size: 10px; margin-top: 4px; font-weight: 500; }
        
        /* æ¿€æ´»çŠ¶æ€ */
        .dock-btn.active { 
            background: #333; color: #00ff88; transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.2);
        }
        /* æ¿€æ´»æ—¶çš„å›¾æ ‡é¢œè‰² */
        .dock-btn.active.mode-move { color: #ff5555; box-shadow: 0 5px 15px rgba(255,85,85,0.2); }
        .dock-btn.active.mode-rotate { color: #55ff55; box-shadow: 0 5px 15px rgba(85,255,85,0.2); }
        .dock-btn.active.mode-scale { color: #5555ff; box-shadow: 0 5px 15px rgba(85,85,255,0.2); }

        /* åˆ†å‰²çº¿ */
        .divider { width: 1px; height: 40px; background: #555; }

        /* åŠ è½½æ¡ */
        #progress { position: absolute; top:0; left:0; height:3px; background:#00ff88; width:0%; transition:width 0.2s; z-index:3000; }

        /* æç¤ºé®ç½© */
        #tip-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            z-index: 5000; color: white; text-align: center; pointer-events: none;
            opacity: 0; transition: opacity 0.5s;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="progress"></div>
    <div id="status-pill"><span>ğŸ“¡</span> <span id="status-msg">åˆå§‹åŒ–...</span></div>
    
    <!-- æ¨¡å¼æç¤º -->
    <div id="mode-indicator"><span class="mode-tag" id="mode-text">ğŸ‘€ æµè§ˆæ¨¡å¼ï¼šå•æŒ‡æ—‹è½¬ï¼ŒåŒæŒ‡ç¼©æ”¾</span></div>

    <!-- åº•éƒ¨ Dock æ  -->
    <div id="dock">
        <!-- æµè§ˆæ¨¡å¼ (é»˜è®¤) -->
        <button class="dock-btn active" id="btn-view" onclick="setMode('view')">
            <span>ğŸ‘ï¸</span><span>æµè§ˆ</span>
        </button>
        
        <div class="divider"></div>

        <!-- ç¼–è¾‘å·¥å…· -->
        <button class="dock-btn mode-move" id="btn-translate" onclick="setMode('translate')">
            <span>âœ¢</span><span>ç§»åŠ¨</span>
        </button>
        <button class="dock-btn mode-rotate" id="btn-rotate" onclick="setMode('rotate')">
            <span>â†»</span><span>æ—‹è½¬</span>
        </button>
        <button class="dock-btn mode-scale" id="btn-scale" onclick="setMode('scale')">
            <span>â¤¢</span><span>ç¼©æ”¾</span>
        </button>

        <div class="divider"></div>

        <!-- é‡ç½® -->
        <button class="dock-btn" id="btn-reset" onclick="resetAll()">
            <span>â†º</span><span>é‡ç½®</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä½ çš„æ¨¡å‹é“¾æ¥
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        // å…¨å±€å˜é‡
        let viewer, transformControl, splatMesh;
        let currentMode = 'view'; // view | translate | rotate | scale
        
        const ui = {
            bar: document.getElementById('progress'),
            msg: document.getElementById('status-msg'),
            pill: document.getElementById('status-pill'),
            indicator: document.getElementById('mode-indicator'),
            modeText: document.getElementById('mode-text'),
            btns: document.querySelectorAll('.dock-btn')
        };

        // --- 1. åˆå§‹åŒ–å¼•æ“ ---
        async function init() {
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 2, 5],
                'initialCameraLookAt': [0, 0, 0],
                'useBuiltInControls': true, 
                'sharedMemoryForWorkers': false,
                'splatAlphaRemovalThreshold': 5 // æé«˜ä¸€ç‚¹é˜ˆå€¼ï¼Œå‡å°‘å™ªç‚¹
            });
            
            // è§£å†³è§¦æ‘¸ç©¿é€çš„å…³é”®
            viewer.renderer.domElement.style.touchAction = 'none';
            document.body.appendChild(viewer.renderer.domElement);

            // æ·»åŠ ç½‘æ ¼åœ°é¢ (å‚è€ƒç³»)
            const grid = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            grid.position.y = -1; //ç¨å¾®ä¸‹æ²‰ä¸€ç‚¹
            viewer.threeScene.add(grid);

            // åˆå§‹åŒ–ç¼–è¾‘æ§åˆ¶å™¨
            setupGizmo();

            // å¼€å§‹ä¸‹è½½
            try {
                ui.msg.innerText = "æ­£åœ¨ä¸‹è½½æ¨¡å‹...";
                const buffer = await download(MODEL_URL);
                await loadSplat(buffer);
            } catch (e) {
                ui.msg.innerText = "âŒ é”™è¯¯: " + e.message;
                ui.pill.style.borderColor = "#f00";
            }
        }

        // --- 2. é…ç½® Gizmo (åæ ‡è½´) ---
        function setupGizmo() {
            transformControl = new TransformControls(viewer.camera, viewer.renderer.domElement);
            
            // ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šåŠ å¤§å°ºå¯¸ï¼Œæ›´å®¹æ˜“ç‚¹ä¸­
            transformControl.setSize(1.2); 
            transformControl.setSpace('local'); // æœ¬åœ°åæ ‡ç³»ç¼–è¾‘

            // äº‹ä»¶ï¼šå½“æ‹–æ‹½å¼€å§‹æ—¶
            transformControl.addEventListener('dragging-changed', (event) => {
                // å¦‚æœæ­£åœ¨æ‹–æ‹½ Gizmoï¼Œå¼ºåˆ¶ç¦ç”¨ç›¸æœºï¼Œä»¥é˜²ä¸‡ä¸€
                if (viewer.controls) viewer.controls.enabled = !event.value;
            });

            viewer.threeScene.add(transformControl);
        }

        // --- 3. ä¸‹è½½ä¸åŠ è½½é€»è¾‘ ---
        async function download(url) {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error("ç½‘ç»œé”™è¯¯ " + resp.status);
            
            const len = +resp.headers.get('Content-Length');
            const reader = resp.body.getReader();
            let received = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                received += value.length;
                if(len) ui.bar.style.width = (received/len)*100 + "%";
            }
            return new Blob(chunks);
        }

        async function loadSplat(blob) {
            ui.msg.innerText = "è§£ææ•°æ®ä¸­...";
            const url = URL.createObjectURL(blob) + '#.splat';
            
            // åŠ è½½
            await viewer.addSplatScene(url, { 'showLoadingUI': false });
            
            // è·å–å¯¹è±¡
            splatMesh = viewer.getSplatScene(0);
            
            if (splatMesh) {
                ui.msg.innerText = "âœ… å°±ç»ª";
                setTimeout(() => ui.pill.style.display = 'none', 2000);
                viewer.start();
                
                // é»˜è®¤è¿›å…¥æµè§ˆæ¨¡å¼
                setMode('view');
            }
        }

        // --- 4. æ ¸å¿ƒï¼šæ¨¡å¼åˆ‡æ¢é€»è¾‘ ---
        
        // å°†å‡½æ•°æŒ‚è½½åˆ° window ä»¥ä¾¿ HTML onclick è°ƒç”¨
        window.setMode = function(mode) {
            currentMode = mode;
            
            // 1. æ›´æ–° UI é«˜äº®
            ui.btns.forEach(b => b.classList.remove('active'));
            const btnId = mode === 'view' ? 'btn-view' : 
                          mode === 'translate' ? 'btn-translate' : 
                          mode === 'rotate' ? 'btn-rotate' : 'btn-scale';
            document.getElementById(btnId).classList.add('active');

            // 2. çŠ¶æ€æœºé€»è¾‘ (å…³é”®ï¼)
            if (!splatMesh) return;

            if (mode === 'view') {
                // === æµè§ˆæ¨¡å¼ ===
                // éšè— Gizmo
                transformControl.detach();
                transformControl.enabled = false; 
                
                // è§£é”ç›¸æœº
                if(viewer.controls) viewer.controls.enabled = true;

                // æç¤º
                showToast("ğŸ‘€ æµè§ˆæ¨¡å¼ï¼šå•æŒ‡æ—‹è½¬ï¼ŒåŒæŒ‡ç¼©æ”¾");

            } else {
                // === ç¼–è¾‘æ¨¡å¼ (ç§»åŠ¨/æ—‹è½¬/ç¼©æ”¾) ===
                // é™„ç€ Gizmo
                transformControl.attach(splatMesh);
                transformControl.setMode(mode);
                transformControl.enabled = true;

                // ğŸ”’ é”å®šç›¸æœºï¼šé˜²æ­¢åœ¨ç¼–è¾‘æ—¶è¯¯è§¦æ—‹è½¬è§†è§’
                if(viewer.controls) viewer.controls.enabled = false;

                // æç¤º
                const actionName = mode==='translate'?'ç§»åŠ¨':(mode==='rotate'?'æ—‹è½¬':'ç¼©æ”¾');
                showToast(`ğŸ”§ ${actionName}æ¨¡å¼ï¼šæ‹–åŠ¨è½´çº¿ | ç›¸æœºå·²é”å®š`);
            }
        };

        window.resetAll = function() {
            if (confirm("é‡ç½®æ¨¡å‹ä½ç½®å’Œè§†è§’ï¼Ÿ")) {
                if(splatMesh) {
                    splatMesh.position.set(0,0,0);
                    splatMesh.rotation.set(0,0,0);
                    splatMesh.scale.set(1,1,1);
                }
                viewer.camera.position.set(0, 2, 5);
                viewer.camera.lookAt(0,0,0);
                if(viewer.controls) viewer.controls.target.set(0,0,0);
                
                setMode('view'); // é‡ç½®åå›åˆ°æµè§ˆæ¨¡å¼
            }
        };

        // ç®€å•çš„å±å¹•æç¤º
        let toastTimer;
        function showToast(text) {
            ui.modeText.innerText = text;
            ui.indicator.style.opacity = 1;
            
            // ç¼–è¾‘æ¨¡å¼ä¸‹å¸¸é©»æç¤ºï¼Œæµè§ˆæ¨¡å¼ä¸‹3ç§’æ¶ˆå¤±
            if (currentMode === 'view') {
                clearTimeout(toastTimer);
                toastTimer = setTimeout(() => {
                    ui.indicator.style.opacity = 0;
                }, 3000);
            }
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
