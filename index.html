<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS ç»ˆæä¿®æ­£ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* çŠ¶æ€æç¤ºæ  */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 15px; background: rgba(0,0,0,0.8); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* å¼€å§‹æŒ‰é’® */
        #start-btn {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
            padding: 12px 30px; font-size: 18px; border-radius: 25px;
            background: white; border: none; cursor: pointer; display: none;
            z-index: 1000; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
    </style>

    <!-- ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šå‡çº§åˆ°æœ€æ–° v0.4.7 ç‰ˆæœ¬ï¼Œå½»åº•è§£å†³ Promise æŠ¥é”™ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">æ­£åœ¨è¿æ¥å¼•æ“ v0.4.7...</div>
    <button id="start-btn">å¼€å¯é™€èºä»ªè§‚çœ‹</button>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ==============================================================
        // ğŸ‘‡ è¯·æŠŠä½ çš„ Hugging Face ç›´é“¾ç²˜è´´åœ¨è¿™é‡Œ
        const MODEL_FILE = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat?download=true';
        // ==============================================================

        const status = document.getElementById('status-bar');
        const btn = document.getElementById('start-btn');
        let viewer;
        let isRunning = false;
        let initialGyro = null;

        // é™€èºä»ªé™åˆ¶è§’åº¦ï¼ˆé˜²ç©¿å¸®ï¼‰
        const CLAMP_X = 0.5; // ä¸Šä¸‹çº¦30åº¦
        const CLAMP_Y = 0.6; // å·¦å³çº¦35åº¦

        async function main() {
            // 1. åˆå§‹åŒ–å¼•æ“
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 1, 4], // ç›¸æœºä½ç½®
                'initialCameraLookAt': [0, 0, 0],
                // å¯ç”¨å…±äº«å†…å­˜ï¼ˆè‹¥æ‰‹æœºç™½å±å¯æ”¹ä¸º falseï¼‰
                'sharedMemoryForWorkers': false, 
            });

            document.body.appendChild(viewer.renderer.domElement);

            // 2. åŠ è½½æ¨¡å‹
            status.innerText = "æ­£åœ¨è¯·æ±‚æ–‡ä»¶ï¼Œè¯·ç¨å€™...";
            
            try {
                await viewer.addSplatScene(MODEL_FILE, {
                    'showLoadingUI': false, // å…³é—­é»˜è®¤UIï¼Œç”¨æˆ‘ä»¬è‡ªå·±çš„
                    'splatAlphaRemovalThreshold': 5, 
                    'onProgress': (percent, percentStr) => {
                        // å³ä½¿æ˜¯ NaN ä¹Ÿä¸è¦æ…Œï¼Œè¯´æ˜åœ¨ä¸‹è½½æµ
                        if (percentStr === 'NaN') {
                            status.innerText = `ğŸ“¥ æ­£åœ¨ä¸‹è½½æ•°æ®æµ... (ä¿æŒç½‘ç»œé€šç•…)`;
                        } else {
                            status.innerText = `ğŸ“¥ ä¸‹è½½è¿›åº¦: ${percentStr}%`;
                        }
                    }
                });

                // 3. åŠ è½½æˆåŠŸ
                status.innerText = "âœ… æ¨¡å‹å°±ç»ªï¼è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®";
                status.style.color = "#fff";
                btn.style.display = "block";

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
                // åªæœ‰ v0.4.7 æ‰èƒ½æ­£ç¡®æ•è·è¿™ä¸ªé”™è¯¯ï¼Œä¸ä¼šå†æŠ¥ .reject ä¸æ˜¯å‡½æ•°äº†
            }
        }

        // 4. æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        btn.addEventListener('click', () => {
            btn.style.display = 'none';
            status.style.display = 'none';
            viewer.start();
            isRunning = true;
            requestGyro();
        });

        // 5. ç”³è¯·é™€èºä»ªæƒé™
        function requestGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ éœ€è¦ç”³è¯·
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            alert('éœ€è¦å…è®¸é™€èºä»ªæƒé™æ‰èƒ½è§‚çœ‹');
                        }
                    })
                    .catch(console.error);
            } else {
                // å®‰å“ / æ™®é€šè®¾å¤‡ç›´æ¥ç›‘å¬
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        // 6. é™€èºä»ªæ§åˆ¶é€»è¾‘
        function handleOrientation(event) {
            if (!viewer || !isRunning) return;

            // è®°å½•åˆå§‹è§’åº¦
            if (!initialGyro && event.alpha !== null) {
                initialGyro = { beta: event.beta, gamma: event.gamma };
                return;
            }
            if (!initialGyro) return;

            // è®¡ç®—å·®å€¼
            let deltaX = (event.beta - initialGyro.beta) * (Math.PI / 180);
            let deltaY = (event.gamma - initialGyro.gamma) * (Math.PI / 180);

            // é™åˆ¶è§’åº¦ (Clamp)
            deltaX = Math.max(-CLAMP_X, Math.min(CLAMP_X, deltaX));
            deltaY = Math.max(-CLAMP_Y, Math.min(CLAMP_Y, deltaY));

            // åº”ç”¨æ—‹è½¬
            viewer.camera.rotation.set(deltaX, deltaY, 0, 'YXZ');
            viewer.update();
        }

        main();
    </script>
</body>
</html>
