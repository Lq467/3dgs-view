<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Perfect Subtle</title>
    <style>
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: -apple-system, sans-serif; user-select: none;
        }

        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: none; z-index: 100; display: flex; justify-content: center; padding-top: 20px;
        }
        .pill {
            background: rgba(20,20,20,0.8); color: #fff; padding: 6px 16px;
            border-radius: 20px; font-size: 13px; border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .pill.active {
            border-color: #00ff88; color: #00ff88; background: rgba(0, 255, 136, 0.15);
        }

        #controls {
            position: absolute; bottom: 50px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 30px;
            pointer-events: none; z-index: 100;
        }
        .btn {
            pointer-events: auto;
            width: 64px; height: 64px; border-radius: 50%; border: 2px solid #555;
            background: rgba(30,30,30,0.9); color: #ccc; font-size: 26px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            transition: transform 0.1s, border-color 0.3s;
        }
        .btn:active { transform: scale(0.95); }
        .btn.active { border-color: #00ff88; color: #00ff88; background: #002211; }

        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .loader-text { color:#00ff88; margin-top:20px; font-family:monospace; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="font-size:40px;">ğŸ’</div>
        <div class="loader-text">åŠ è½½é«˜ç²¾æ¨¡å‹...</div>
    </div>

    <div id="top-bar">
        <div class="pill" id="status-msg">ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨è°ƒæ•´ - ğŸ“± å¼€å¯å¾®è°ƒ</div>
    </div>

    <div id="controls">
        <div class="btn" id="btn-reset">â†º</div>
        <div class="btn" id="btn-gyro">ğŸ“±</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.isGyroOn = false;

                // é™€èºä»ªæ•°æ®
                this.startBeta = 0;
                this.startGamma = 0;
                this.currBeta = 0;
                this.currGamma = 0;

                // æ ¸å¿ƒï¼šçƒåæ ‡ç³» (è§£å†³è·³å˜é—®é¢˜çš„å…³é”®)
                this.spherical = new THREE.Spherical();
                this.baseTheta = 0; // å¼€å¯æ—¶çš„æ°´å¹³è§’
                this.basePhi = 0;   // å¼€å¯æ—¶çš„å‚ç›´è§’
                
                // å¹³æ»‘æ’å€¼ç›®æ ‡
                this.targetTheta = 0;
                this.targetPhi = 0;
            }

            async init() {
                // 1. Viewer
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 1, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, 
                    'selfDrivenMode': false,
                    'sharedMemoryForWorkers': false
                });

                const canvas = this.viewer.renderer.domElement;
                canvas.style.position = 'absolute'; canvas.style.top = '0'; canvas.style.zIndex = '0';
                document.body.appendChild(canvas);

                // 2. Controls
                this.controls = new OrbitControls(this.viewer.camera, document.body);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 0.1;
                this.controls.maxDistance = 100;

                // 3. ç›‘å¬è®¾å¤‡
                window.addEventListener('deviceorientation', (e) => {
                    this.currBeta = e.beta || 0;
                    this.currGamma = e.gamma || 0;
                });

                // 4. å¾ªç¯
                this.animate();

                // 5. åŠ è½½
                await this.loadModel();
                
                // 6. ç»‘å®š
                this.bindEvents();
            }

            async loadModel() {
                const resp = await fetch(MODEL_URL);
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob) + '#.splat';
                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });
                document.getElementById('loader').style.display = 'none';
            }

            toggleGyro() {
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(res => {
                            if (res === 'granted') this.setGyroState(!this.isGyroOn);
                            else alert("éœ€è¦æƒé™");
                        });
                } else {
                    this.setGyroState(!this.isGyroOn);
                }
            }

            setGyroState(active) {
                this.isGyroOn = active;
                const btn = document.getElementById('btn-gyro');
                const msg = document.getElementById('status-msg');

                if (active) {
                    // === å¼€å¯é™€èºä»ª ===
                    this.controls.enabled = false; // æš‚åœæ‰‹æŒ‡

                    // 1. è®°å½•åˆå§‹æ‰‹æœºè§’åº¦
                    this.startBeta = this.currBeta;
                    this.startGamma = this.currGamma;

                    // 2. æ ¸å¿ƒä¿®å¤ï¼šè®¡ç®—å½“å‰ç›¸æœºç›¸å¯¹äº Target çš„çƒåæ ‡
                    // è¿™ä¸€æ­¥ä¿è¯äº†â€œæ— ç¼è¡”æ¥â€ï¼Œç»å¯¹ä¸ä¼šè·³å˜
                    const offset = this.viewer.camera.position.clone().sub(this.controls.target);
                    this.spherical.setFromVector3(offset);

                    // 3. è®°å½•åŸºå‡†ç»çº¬åº¦
                    this.baseTheta = this.spherical.theta;
                    this.basePhi = this.spherical.phi;
                    
                    // åˆå§‹åŒ–å¹³æ»‘ç›®æ ‡
                    this.targetTheta = this.baseTheta;
                    this.targetPhi = this.basePhi;

                    btn.classList.add('active');
                    msg.classList.add('active');
                    msg.innerText = "ğŸ“± å¾®è°ƒæ¨¡å¼ (è§’åº¦å·²é™åˆ¶)";
                } else {
                    // === å…³é—­é™€èºä»ª ===
                    this.controls.enabled = true; // æ¢å¤æ‰‹æŒ‡
                    btn.classList.remove('active');
                    msg.classList.remove('active');
                    msg.innerText = "ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨è°ƒæ•´";
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                if (this.isGyroOn) {
                    // ==============================
                    // ğŸŒŸ ä¿®æ­£åçš„å¾®è°ƒç®—æ³•
                    // ==============================

                    // 1. ç®—å‡ºåç§»é‡
                    let deltaX = this.currBeta - this.startBeta;   // ä¸Šä¸‹
                    let deltaY = this.currGamma - this.startGamma; // å·¦å³

                    // 2. é™åˆ¶è§’åº¦ (å¤§å¹…ç¼©å°ï¼)
                    // ä¹‹å‰æ˜¯ 20åº¦ï¼Œç°åœ¨æ”¹æˆ 5åº¦ (çº¦ 0.08å¼§åº¦)
                    // è¿™æ ·æ™ƒåŠ¨æ‰‹æœºæ—¶ï¼Œæ¨¡å‹åªä¼šå¾ˆå…‹åˆ¶åœ°åŠ¨ä¸€ç‚¹ç‚¹
                    const MAX_DEG = 8; 
                    deltaX = Math.max(-MAX_DEG, Math.min(MAX_DEG, deltaX));
                    deltaY = Math.max(-MAX_DEG, Math.min(MAX_DEG, deltaY));

                    // 3. è½¬æ¢é€»è¾‘ (çƒåæ ‡åç§»)
                    // æ‰‹æœºå·¦å€¾ (Gammaè´Ÿ) -> ç›¸æœºå·¦é£ (Thetaå‡å°‘) -> æ¨¡å‹çœ‹èµ·æ¥å·¦è½¬
                    // æ‰‹æœºä¸ŠæŠ¬ (Betaæ­£) -> ç›¸æœºä¸Šé£ (Phiå‡å°‘ï¼Œæ³¨æ„Phiä»é¡¶ç«¯0å¼€å§‹) -> æ¨¡å‹çœ‹èµ·æ¥ä¸Šè½¬
                    
                    const sensitivity = 0.005; // æä½çµæ•åº¦ï¼Œä¿è¯å¾®è°ƒæ„Ÿ

                    const offsetTheta = deltaY * sensitivity * 3.0; // å·¦å³ç¨å¾®çµæ•ç‚¹
                    const offsetPhi = -deltaX * sensitivity * 2.0;  // ä¸Šä¸‹ (æ³¨æ„è´Ÿå·)

                    // 4. è®¡ç®—ç›®æ ‡çƒåæ ‡ (åŸºå‡† + åç§»)
                    // è¿™æ ·æ°¸è¿œæ˜¯åœ¨â€œå¼€å¯é‚£ä¸€åˆ»â€çš„è§†è§’é™„è¿‘æ™ƒåŠ¨ï¼Œç»ä¸è·‘å
                    const desiredTheta = this.baseTheta - offsetTheta;
                    const desiredPhi = this.basePhi - offsetPhi;

                    // é™åˆ¶å‚ç›´è§’åº¦é˜²æ­¢ç¿»è½¬ (Phi å¿…é¡»åœ¨ 0.1 ~ PI-0.1 ä¹‹é—´)
                    const safePhi = Math.max(0.1, Math.min(Math.PI - 0.1, desiredPhi));

                    // 5. å¹³æ»‘æ’å€¼ (Lerp)
                    // è®©æ•°å€¼æ…¢æ…¢è¿½èµ¶ï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬å˜åŒ–
                    this.targetTheta += (desiredTheta - this.targetTheta) * 0.1;
                    this.targetPhi += (safePhi - this.targetPhi) * 0.1;

                    // 6. åº”ç”¨å›ç›¸æœº
                    this.spherical.theta = this.targetTheta;
                    this.spherical.phi = this.targetPhi;
                    this.spherical.makeSafe();

                    // ä»çƒåæ ‡è½¬å› XYZ åæ ‡ï¼Œå¹¶åŠ ä¸Š Target åç§»
                    this.viewer.camera.position.setFromSpherical(this.spherical).add(this.controls.target);
                    this.viewer.camera.lookAt(this.controls.target);

                } else {
                    // è§¦æ§æ¨¡å¼
                    this.controls.update();
                }

                this.viewer.update();
                this.viewer.render();
            }

            bindEvents() {
                document.getElementById('btn-reset').addEventListener('click', () => {
                    this.controls.reset();
                    if(this.isGyroOn) this.setGyroState(false);
                });
                document.getElementById('btn-gyro').addEventListener('click', () => this.toggleGyro());
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
