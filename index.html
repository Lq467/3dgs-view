<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS å®ä½“ä»£ç†æ“ä½œç‰ˆ</title>
    <style>
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: sans-serif; user-select: none;
        }

        /* é¡¶éƒ¨æç¤º */
        #top-msg {
            position: absolute; top: 10px; left: 0; width: 100%; text-align: center;
            pointer-events: none; z-index: 1000;
        }
        .msg-box {
            background: rgba(255, 0, 0, 0.8); color: white; padding: 8px 15px;
            border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-block;
        }

        /* åº•éƒ¨æ“ä½œåŒº */
        #dock {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #222; padding: 10px; border-radius: 16px;
            display: flex; gap: 15px; border: 1px solid #444; z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .btn {
            width: 55px; height: 55px; background: #333; border: 1px solid #555;
            border-radius: 12px; color: #aaa; font-size: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn span { font-size: 10px; margin-top: 2px; }
        .btn.active { background: #007bff; color: white; border-color: #00aaff; }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .loader-text { color: #0f0; margin-top: 20px; font-family: monospace; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="font-size: 40px;">ğŸ“¦</div>
        <div class="loader-text" id="load-text">æ­£åœ¨æ„å»ºå®ä½“å®¹å™¨...</div>
    </div>

    <div id="top-msg">
        <div class="msg-box" id="status-label">è¯·æ“ä½œçº¢è‰²çš„ç›’å­</div>
    </div>

    <div id="dock">
        <button class="btn active" id="btn-view" onclick="app.setMode('view')">
            ğŸ‘ï¸<span>æµè§ˆ</span>
        </button>
        <div style="width:1px; background:#555;"></div>
        <button class="btn" id="btn-translate" onclick="app.setMode('translate')">
            âœ¢<span>ç§»åŠ¨</span>
        </button>
        <button class="btn" id="btn-rotate" onclick="app.setMode('rotate')">
            â†»<span>æ—‹è½¬</span>
        </button>
        <button class="btn" id="btn-scale" onclick="app.setMode('scale')">
            â¤¢<span>ç¼©æ”¾</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.gizmo = null;
                
                // æ ¸å¿ƒï¼šè¿™æ˜¯ä¸€ä¸ªå®ä½“çš„ BoxMeshï¼Œç”¨æ¥ä»£æ›¿ç‚¹äº‘è¢«ç‚¹å‡»
                this.proxyBox = null; 
                this.splatMesh = null;
            }

            async init() {
                // 1. åˆå§‹åŒ–å¼•æ“
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 2, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, 
                    'selfDrivenMode': false,
                    'sharedMemoryForWorkers': false
                });
                
                document.body.appendChild(this.viewer.renderer.domElement);

                // 2. åˆ›å»ºä¸€ä¸ªâ€œå®ä½“ä»£ç†ç›’â€ (Proxy Box)
                // è¿™æ˜¯ä¸€ä¸ªçœ‹å¾—è§ã€æ‘¸å¾—ç€çš„çº¢è‰²åŠé€æ˜æ–¹å—
                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000, 
                    wireframe: true,  // çº¿æ¡†æ¨¡å¼ï¼Œæ–¹ä¾¿çœ‹é‡Œé¢çš„æ¨¡å‹
                    transparent: true, 
                    opacity: 0.5,
                    depthTest: false  // ä¿è¯æ°¸è¿œæ˜¾ç¤ºåœ¨æœ€å‰é¢
                });
                
                this.proxyBox = new THREE.Mesh(geometry, material);
                this.proxyBox.visible = false; // åˆå§‹éšè—ï¼Œç¼–è¾‘æ¨¡å¼æ‰æ˜¾ç¤º
                this.viewer.threeScene.add(this.proxyBox);

                // 3. OrbitControls (ç›¸æœº)
                this.controls = new OrbitControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.controls.enableDamping = true;
                
                // 4. TransformControls (åæ ‡è½´)
                this.gizmo = new TransformControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.gizmo.setSize(1.2);
                // è§£å†³å†²çªï¼šæ‹–åŠ¨åæ ‡è½´æ—¶ï¼Œç¦æ­¢ç›¸æœºè½¬åŠ¨
                this.gizmo.addEventListener('dragging-changed', (e) => {
                    this.controls.enabled = !e.value;
                });
                this.viewer.threeScene.add(this.gizmo);

                // 5. å¯åŠ¨å¾ªç¯
                this.animate();

                // 6. åŠ è½½æ¨¡å‹
                await this.loadModel();
            }

            async loadModel() {
                const txt = document.getElementById('load-text');
                txt.innerText = "ä¸‹è½½æ¨¡å‹æ•°æ®...";
                
                const resp = await fetch(MODEL_URL);
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob) + '#.splat';
                
                txt.innerText = "æ³¨å…¥ä»£ç†å®¹å™¨...";
                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });

                setTimeout(() => {
                    this.splatMesh = this.viewer.getSplatScene(0);
                    if (this.splatMesh) {
                        // âš ï¸ ç»ˆææ“ä½œï¼šæŠŠ Splat æ¨¡å‹å¡è¿› ProxyBox é‡Œ
                        // è¿™æ · ProxyBox åŠ¨ï¼ŒSplat å¿…é¡»åŠ¨ï¼
                        this.proxyBox.add(this.splatMesh);
                        
                        // è°ƒæ•´ä¸€ä¸‹ Splat åœ¨ç›’å­é‡Œçš„ä½ç½®ï¼ˆé€šå¸¸å±…ä¸­ï¼‰
                        this.splatMesh.position.set(0, 0, 0);
                        
                        document.getElementById('loader').style.display = 'none';
                        this.setMode('view');
                    }
                }, 500);
            }

            setMode(mode) {
                // UI
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                const btnId = mode === 'view' ? 'btn-view' : 'btn-' + mode;
                document.getElementById(btnId).classList.add('active');

                const label = document.getElementById('status-label');

                if (mode === 'view') {
                    // === æµè§ˆæ¨¡å¼ ===
                    this.gizmo.detach();
                    this.proxyBox.visible = false; // éšè—çº¢ç›’å­
                    this.controls.enabled = true;  // å…è®¸è½¬è§†è§’
                    
                    label.innerText = "ğŸ‘€ æµè§ˆæ¨¡å¼ï¼šè½¬åŠ¨è§†è§’";
                    label.style.backgroundColor = "rgba(0,0,0,0.6)";
                } else {
                    // === ç¼–è¾‘æ¨¡å¼ ===
                    // 1. æ˜¾ç¤ºçº¢ç›’å­ (å®ä½“!)
                    this.proxyBox.visible = true; 
                    
                    // 2. åæ ‡è½´é™„ç€åœ¨çº¢ç›’å­ä¸Š (è€Œä¸æ˜¯é™„ç€åœ¨è™šæ— çš„ç‚¹äº‘ä¸Š)
                    this.gizmo.attach(this.proxyBox);
                    this.gizmo.setMode(mode);
                    
                    // 3. è¿™é‡Œçš„ controls.enabled ä¸éœ€è¦æ‰‹åŠ¨ falseï¼Œ
                    // å› ä¸ºæˆ‘ä»¬ä¸Šé¢ç»‘å®šäº† dragging-changed äº‹ä»¶ã€‚
                    // åªè¦ä½ ç‚¹ä¸­äº†çº¢ç›’å­æˆ–åæ ‡è½´ï¼Œç›¸æœºå°±ä¼šåœã€‚
                    
                    label.innerText = `ğŸ”§ ${mode}æ¨¡å¼ï¼šè¯·æ‹–åŠ¨çº¢è‰²æ–¹æ¡†`;
                    label.style.backgroundColor = "rgba(255,0,0,0.8)";
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.controls.update();
                this.viewer.update();
                this.viewer.render();
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
