<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS SuperSplat äº¤äº’ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: sans-serif; }
        
        /* é¡¶éƒ¨æç¤º */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 10px; background: rgba(0,0,0,0.8); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ (ä»¿ SuperSplat) */
        #controls-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: rgba(30,30,30,0.95); 
            border-top: 1px solid #555;
            display: flex; flex-direction: column;
            z-index: 1000; transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        /* æ ‡é¢˜æ  (ç‚¹å‡»å¯æŠ˜å ) */
        .panel-header {
            padding: 12px; background: #222; color: white; 
            font-size: 14px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none; border-bottom: 1px solid #444;
        }
        
        .scroll-area {
            flex: 1; overflow-y: auto; padding: 20px 15px;
        }

        .control-group { margin-bottom: 20px; }
        .control-title { color: #888; font-size: 12px; margin-bottom: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        /* æ»‘æ†è¡Œæ ·å¼ */
        .slider-row {
            display: flex; align-items: center; margin-bottom: 12px;
        }
        .slider-label { color: #ddd; width: 25px; font-size: 14px; font-weight: bold; }
        input[type=range] { 
            flex: 1; margin: 0 15px; cursor: pointer; height: 4px; border-radius: 2px;
            accent-color: #0f0; /* å®‰å“æ»‘å—é¢œè‰² */
        }
        .slider-val { color: #0f0; width: 45px; font-size: 12px; text-align: right; font-family: monospace; }

        /* é‡ç½®æŒ‰é’® */
        #reset-cam {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.9); border: none; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; z-index: 900;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; font-size: 14px;
        }
        #reset-cam:active { transform: scale(0.95); }
    </style>
    
    <!-- å¼•ç”¨ v0.4.7 å¼•æ“ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">å‡†å¤‡åŠ è½½...</div>
    <button id="reset-cam">ğŸ”„ é‡ç½®è§†è§’</button>

    <div id="controls-panel">
        <div class="panel-header" id="toggle-panel">
            <span>ğŸ›ï¸ æ¨¡å‹è°ƒæ ¡ (ä½ç½®/æ—‹è½¬/ç¼©æ”¾)</span>
            <span id="arrow-icon">â¬‡ï¸</span>
        </div>
        <div class="scroll-area">
            
            <!-- ç¼©æ”¾ -->
            <div class="control-group">
                <div class="control-title">ç¼©æ”¾ (Scale)</div>
                <div class="slider-row">
                    <span class="slider-label">S</span>
                    <input type="range" id="scale" min="0.1" max="10.0" step="0.1" value="1.0">
                    <span class="slider-val" id="val-scale">1.0</span>
                </div>
            </div>

            <!-- æ—‹è½¬ -->
            <div class="control-group">
                <div class="control-title">æ—‹è½¬ (Rotation)</div>
                <div class="slider-row">
                    <span class="slider-label" style="color:#ff5555">X</span>
                    <input type="range" class="rot-slider" data-axis="x" min="-180" max="180" value="0">
                    <span class="slider-val" id="val-rot-x">0Â°</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label" style="color:#55ff55">Y</span>
                    <input type="range" class="rot-slider" data-axis="y" min="-180" max="180" value="0">
                    <span class="slider-val" id="val-rot-y">0Â°</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label" style="color:#5555ff">Z</span>
                    <input type="range" class="rot-slider" data-axis="z" min="-180" max="180" value="0">
                    <span class="slider-val" id="val-rot-z">0Â°</span>
                </div>
            </div>

            <!-- ä½ç§» -->
            <div class="control-group">
                <div class="control-title">ä½ç§» (Position)</div>
                <div class="slider-row">
                    <span class="slider-label">X</span>
                    <input type="range" class="pos-slider" data-axis="x" min="-10" max="10" step="0.1" value="0">
                    <span class="slider-val" id="val-pos-x">0</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Y</span>
                    <input type="range" class="pos-slider" data-axis="y" min="-10" max="10" step="0.1" value="0">
                    <span class="slider-val" id="val-pos-y">0</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Z</span>
                    <input type="range" class="pos-slider" data-axis="z" min="-10" max="10" step="0.1" value="0">
                    <span class="slider-val" id="val-pos-z">0</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä½ çš„ HF ç›´é“¾
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const resetBtn = document.getElementById('reset-cam');
        let viewer;
        let splatMesh = null; // çœŸæ­£çš„æ¨¡å‹å¯¹è±¡

        // å˜æ¢å‚æ•°ç¼“å­˜
        let params = {
            scale: 1.0,
            rot: { x: 0, y: 0, z: 0 },
            pos: { x: 0, y: 0, z: 0 }
        };

        async function main() {
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                // é»˜è®¤ç›¸æœºä½ç½®ï¼šå¾€åæ‹‰ (Z=5)
                'initialCameraPosition': [0, 1, 5], 
                'initialCameraLookAt': [0, 0, 0],
                // ğŸŸ¢ å¼€å¯å†…ç½®æ§åˆ¶å™¨ (SuperSplat æ ¸å¿ƒäº¤äº’)
                'useBuiltInControls': true, 
                'sharedMemoryForWorkers': false,
            });
            document.body.appendChild(viewer.renderer.domElement);

            try {
                // 1. ä¸‹è½½æ•°æ®
                status.innerText = "ğŸš€ æ­£åœ¨ä¸‹è½½...";
                const response = await fetch(MODEL_URL);
                if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥: " + response.status);

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0; 
                let chunks = []; 

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    let progress = contentLength ? Math.round((receivedLength / contentLength) * 100) + "%" : (receivedLength / 1024 / 1024).toFixed(1) + " MB";
                    status.innerText = `ğŸ“¥ ä¸‹è½½ä¸­... ${progress}`;
                }

                status.innerText = "âš™ï¸ è§£ææ¨¡å‹...";
                const blob = new Blob(chunks);
                const originalUrl = URL.createObjectURL(blob);
                const fakeUrl = originalUrl + '#.splat';

                // 2. åŠ è½½åœºæ™¯ (ä¸æ¥è¿”å›å€¼)
                await viewer.addSplatScene(fakeUrl, {
                    'showLoadingUI': false,
                    'splatAlphaRemovalThreshold': 2, 
                });

                // 3. ğŸŸ¢ ä¿®æ­£åçš„æŸ¥æ‰¾é€»è¾‘
                // ä¼˜å…ˆå°è¯•ä» viewer.getSplatScene(0) è·å–
                splatMesh = viewer.getSplatScene(0);

                // å¦‚æœä¸Šé¢æ²¡æ‹¿åˆ°ï¼Œæˆ–è€…æƒ³ç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œå» threeScene é‡Œéå†
                if (!splatMesh && viewer.threeScene) {
                    viewer.threeScene.traverse((child) => {
                        if (child.isMesh || (child.constructor && child.constructor.name.includes('Splat'))) {
                            splatMesh = child;
                        }
                    });
                }

                if (splatMesh) {
                    console.log("âœ… æˆåŠŸè·å–æ¨¡å‹å¯¹è±¡:", splatMesh);
                    status.innerText = "âœ… åŠ è½½æˆåŠŸï¼";
                    setTimeout(() => { status.style.display = 'none'; }, 2000);
                    viewer.start();
                } else {
                    throw new Error("æ¨¡å‹å·²åŠ è½½ä½†æœªæ‰¾åˆ°å¯¹è±¡ï¼Œæ— æ³•æ§åˆ¶");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
            }
        }

        // ================= å˜æ¢é€»è¾‘ =================
        
        function updateTransform() {
            if (!splatMesh) return;
            splatMesh.scale.set(params.scale, params.scale, params.scale);
            splatMesh.rotation.set(
                THREE.MathUtils.degToRad(params.rot.x),
                THREE.MathUtils.degToRad(params.rot.y),
                THREE.MathUtils.degToRad(params.rot.z)
            );
            splatMesh.position.set(params.pos.x, params.pos.y, params.pos.z);
        }

        // ç»‘å®šæ‰€æœ‰æ»‘æ†
        document.getElementById('scale').addEventListener('input', (e) => {
            params.scale = parseFloat(e.target.value);
            document.getElementById('val-scale').innerText = params.scale;
            updateTransform();
        });

        document.querySelectorAll('.rot-slider').forEach(el => {
            el.addEventListener('input', (e) => {
                const axis = e.target.dataset.axis;
                const val = parseFloat(e.target.value);
                params.rot[axis] = val;
                document.getElementById(`val-rot-${axis}`).innerText = val + "Â°";
                updateTransform();
            });
        });

        document.querySelectorAll('.pos-slider').forEach(el => {
            el.addEventListener('input', (e) => {
                const axis = e.target.dataset.axis;
                const val = parseFloat(e.target.value);
                params.pos[axis] = val;
                document.getElementById(`val-pos-${axis}`).innerText = val;
                updateTransform();
            });
        });

        // ================= å…¶ä»–åŠŸèƒ½ =================

        // é‡ç½®ç›¸æœº
        resetBtn.addEventListener('click', () => {
            viewer.camera.position.set(0, 1, 5);
            viewer.camera.lookAt(0, 0, 0);
            if (viewer.controls) {
                viewer.controls.target.set(0, 0, 0);
                viewer.controls.update();
            }
        });

        // é¢æ¿æŠ˜å 
        const panel = document.getElementById('controls-panel');
        const header = document.getElementById('toggle-panel');
        const arrow = document.getElementById('arrow-icon');
        let isExpanded = true;
        
        header.addEventListener('click', () => {
            isExpanded = !isExpanded;
            if (isExpanded) {
                panel.style.transform = "translateY(0)";
                arrow.innerText = "â¬‡ï¸";
            } else {
                panel.style.transform = "translateY(calc(100% - 45px))"; // åªç•™æ ‡é¢˜
                arrow.innerText = "â¬†ï¸";
            }
        });

        main();
    </script>
</body>
</html>
