<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS æœ€ç»ˆå®Œç¾è¿è¡Œç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* çŠ¶æ€æç¤ºæ¡ */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 15px; background: rgba(0,0,0,0.8); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* å¯åŠ¨æŒ‰é’® */
        #start-btn {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
            padding: 12px 30px; font-size: 18px; border-radius: 25px;
            background: white; border: none; cursor: pointer; display: none;
            z-index: 1000; box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
    </style>

    <!-- ğŸŸ¢ å¼•æ“æ ¸å¿ƒ v0.4.7 (ä¿®å¤æ‰€æœ‰å·²çŸ¥æŠ¥é”™) -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
    <button id="start-btn">å¼€å¯é™€èºä»ª</button>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // âœ… å·²ä¿®æ­£ï¼šå°† blob æ›¿æ¢ä¸º resolveï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„æ–‡ä»¶ä¸‹è½½é“¾æ¥
        const MODEL_FILE = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const btn = document.getElementById('start-btn');
        let viewer;
        let isRunning = false;
        let initialGyro = null;
        
        // é™€èºä»ªé˜²ç©¿å¸®ï¼šé™åˆ¶ä¸Šä¸‹å·¦å³è½¬åŠ¨çš„è§’åº¦
        const CLAMP_X = 0.5; // ä¸Šä¸‹çº¦30åº¦
        const CLAMP_Y = 0.6; // å·¦å³çº¦35åº¦

        async function main() {
            // åˆå§‹åŒ–å¼•æ“
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 1, 4], // ç›¸æœºå¾€åæ‹‰ä¸€ç‚¹
                'initialCameraLookAt': [0, 0, 0],
                'sharedMemoryForWorkers': false, // å…¼å®¹æ€§è®¾ç½®
            });
            document.body.appendChild(viewer.renderer.domElement);

            status.innerText = "æ­£åœ¨è¯·æ±‚æ–‡ä»¶...";
            
            try {
                await viewer.addSplatScene(MODEL_FILE, {
                    'showLoadingUI': false,
                    'format': 'splat',       // å¼ºåˆ¶æŒ‡å®šæ ¼å¼ï¼Œé˜²æ­¢å¼•æ“è¯¯åˆ¤
                    'streamView': true,      // å¼€å¯æµå¼åŠ è½½ï¼Œä¸€è¾¹ä¸‹ä¸€è¾¹çœ‹ï¼Œé˜²æ­¢æ‰‹æœºå†…å­˜çˆ†
                    'splatAlphaRemovalThreshold': 5, // ç§»é™¤èƒŒæ™¯æ‚ç‚¹
                    'onProgress': (percent, percentStr) => {
                        if (percentStr === 'NaN') {
                            status.innerText = `ğŸ“¥ æ­£åœ¨åŠ è½½æ•°æ®æµ... (è¯·ç¨å€™)`;
                        } else {
                            status.innerText = `ğŸ“¥ ä¸‹è½½è¿›åº¦: ${percentStr}%`;
                        }
                    }
                });

                // åŠ è½½æˆåŠŸï¼
                status.innerText = "âœ… æ¨¡å‹åŠ è½½å®Œæˆï¼";
                status.style.color = "#fff";
                btn.style.display = "block";

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
            }
        }

        // æŒ‰é’®ç‚¹å‡»ï¼šå¼€å§‹æ¸²æŸ“å¹¶è¯·æ±‚é™€èºä»ª
        btn.addEventListener('click', () => {
            btn.style.display = 'none';
            status.style.display = 'none';
            viewer.start();
            isRunning = true;
            requestGyro();
        });

        // ç”³è¯·æƒé™ (é’ˆå¯¹ iOS)
        function requestGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            alert('éœ€è¦å…è®¸é™€èºä»ªæƒé™æ‰èƒ½æ§åˆ¶è§†è§’');
                        }
                    }).catch(console.error);
            } else {
                // å®‰å“ç›´æ¥ç›‘å¬
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        // é™€èºä»ªé€»è¾‘
        function handleOrientation(event) {
            if (!viewer || !isRunning) return;
            
            // è®°å½•åˆå§‹è§’åº¦ä½œä¸ºé›¶ç‚¹
            if (!initialGyro && event.alpha !== null) {
                initialGyro = { beta: event.beta, gamma: event.gamma };
                return;
            }
            if (!initialGyro) return;

            // è®¡ç®—ç›¸å¯¹è½¬åŠ¨
            let deltaX = (event.beta - initialGyro.beta) * (Math.PI / 180);
            let deltaY = (event.gamma - initialGyro.gamma) * (Math.PI / 180);

            // é™åˆ¶èŒƒå›´ (é˜²ç©¿å¸®)
            deltaX = Math.max(-CLAMP_X, Math.min(CLAMP_X, deltaX));
            deltaY = Math.max(-CLAMP_Y, Math.min(CLAMP_Y, deltaY));

            // åº”ç”¨æ—‹è½¬
            viewer.camera.rotation.set(deltaX, deltaY, 0, 'YXZ');
            viewer.update();
        }

        main();
    </script>
</body>
</html>
