<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS æˆåŠŸè¿è¡Œç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 15px; background: rgba(0,0,0,0.8); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }
        #start-btn {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
            padding: 12px 30px; font-size: 18px; border-radius: 25px;
            background: white; border: none; cursor: pointer; display: none;
            z-index: 1000;
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">æ­£åœ¨è¿æ¥...</div>
    <button id="start-btn">å¼€å¯é™€èºä»ª</button>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ğŸŸ¢ é‡ç‚¹æ£€æŸ¥è¿™é‡Œï¼
        // 1. æˆ‘ä¿ç•™äº† datasets (å› ä¸ºä½ ç¡®å®å»ºçš„æ˜¯dataset)
        // 2. æˆ‘å»æ‰äº† ?download=true (é˜²æ­¢å¼•æ“è¯¯åˆ¤æ ¼å¼)
        // 3. ã€é‡è¦ã€‘å¦‚æœä½ çš„æ–‡ä»¶ä¸å« scene.splatï¼Œè¯·æŠŠæœ€åè¿™ä¸ªåå­—æ”¹æˆä½ åˆ—è¡¨é‡ŒçœŸå®çš„åå­—ï¼
        const MODEL_FILE = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const btn = document.getElementById('start-btn');
        let viewer;
        let isRunning = false;
        let initialGyro = null;
        
        const CLAMP_X = 0.5; 
        const CLAMP_Y = 0.6; 

        async function main() {
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 1, 4],
                'initialCameraLookAt': [0, 0, 0],
                'sharedMemoryForWorkers': false,
            });
            document.body.appendChild(viewer.renderer.domElement);

            status.innerText = "æ­£åœ¨è¯·æ±‚æ–‡ä»¶...";
            
            try {
                await viewer.addSplatScene(MODEL_FILE, {
                    'showLoadingUI': false,
                    // å¼ºåˆ¶æŒ‡å®šæ ¼å¼ï¼Œé˜²æ­¢å› ä¸ºé“¾æ¥æ²¡å†™å¯¹åç¼€è€ŒæŠ¥é”™
                    'format': 'splat',
                    'streamView': true, 
                    'splatAlphaRemovalThreshold': 5, 
                    'onProgress': (percent, percentStr) => {
                        if (percentStr === 'NaN') {
                            status.innerText = `ğŸ“¥ æ­£åœ¨æµå¼åŠ è½½... (å¦‚æœå¡ä½ä¸åŠ¨ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å†™å¯¹)`;
                        } else {
                            status.innerText = `ğŸ“¥ ä¸‹è½½è¿›åº¦: ${percentStr}%`;
                        }
                    }
                });

                status.innerText = "âœ… åŠ è½½æˆåŠŸï¼";
                status.style.color = "#fff";
                btn.style.display = "block";

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
                
                if (err.message.includes('404') || err.message.includes('supported')) {
                     status.innerText += "\nğŸ‘‰ è¯Šæ–­ï¼šé“¾æ¥æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚è¯·æ£€æŸ¥æ–‡ä»¶åæ˜¯ä¸æ˜¯å†™é”™äº†(åŒºåˆ†å¤§å°å†™)ï¼Ÿ";
                }
            }
        }

        btn.addEventListener('click', () => {
            btn.style.display = 'none';
            status.style.display = 'none';
            viewer.start();
            isRunning = true;
            requestGyro();
        });

        function requestGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            alert('éœ€å…è®¸é™€èºä»ªæƒé™');
                        }
                    }).catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            if (!viewer || !isRunning) return;
            if (!initialGyro && event.alpha !== null) {
                initialGyro = { beta: event.beta, gamma: event.gamma };
                return;
            }
            if (!initialGyro) return;

            let deltaX = (event.beta - initialGyro.beta) * (Math.PI / 180);
            let deltaY = (event.gamma - initialGyro.gamma) * (Math.PI / 180);
            deltaX = Math.max(-CLAMP_X, Math.min(CLAMP_X, deltaX));
            deltaY = Math.max(-CLAMP_Y, Math.min(CLAMP_Y, deltaY));
            viewer.camera.rotation.set(deltaX, deltaY, 0, 'YXZ');
            viewer.update();
        }

        main();
    </script>
</body>
</html>
