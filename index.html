<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Gyro Immersive</title>
    <style>
        /* 1. åŸºç¡€ç¯å¢ƒï¼šé»‘åº•ã€æ— æ»šåŠ¨ */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; /* ç¦æ­¢ç³»ç»Ÿé»˜è®¤è§¦æ‘¸ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            user-select: none;
        }

        /* é¡¶éƒ¨æç¤ºæ¡ */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: none; z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .status-pill {
            background: rgba(20, 20, 20, 0.6); color: #fff;
            padding: 8px 20px; border-radius: 30px; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        .status-pill.gyro-on {
            background: rgba(0, 255, 136, 0.2); color: #00ff88; border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
        }

        /* åº•éƒ¨æŒ‰é’®åŒº */
        #controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 25px; z-index: 1000;
        }

        .btn {
            width: 64px; height: 64px; border-radius: 50%; border: none;
            background: rgba(40,40,40,0.9); color: #ccc;
            font-size: 26px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.1s, background 0.3s;
        }
        .btn:active { transform: scale(0.9) translateX(-50%); }

        /* é™€èºä»ªæ¿€æ´»æ—¶çš„æŒ‰é’®æ ·å¼ */
        #btn-gyro.active {
            background: #00ff88; color: #000; box-shadow: 0 0 20px rgba(0,255,136,0.6);
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000;
            transition: opacity 0.5s;
        }
        .loader-text { color:#00ff88; margin-top:15px; font-family:monospace; }

        /* è°ƒè¯•æ—¥å¿— (å¦‚æœå‡ºé—®é¢˜å¯ä»¥çœ‹åˆ°) */
        #err-log {
            position:absolute; top:0; left:0; color:red; font-size:10px; 
            background:rgba(0,0,0,0.8); pointer-events:none; z-index:9999;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="err-log"></div>

    <div id="loader">
        <div style="font-size:40px;">ğŸ”®</div>
        <div class="loader-text">åŠ è½½å…¨æ™¯æ¨¡å‹...</div>
    </div>

    <div id="top-bar">
        <div class="status-pill" id="status-msg">ğŸ‘† è§¦æ‘¸æ»‘åŠ¨ä»¥è°ƒæ•´è§†è§’</div>
    </div>

    <div id="controls">
        <button class="btn" id="btn-reset" title="é‡ç½®è§†è§’">â†º</button>
        <button class="btn" id="btn-gyro" title="ä½“æ„Ÿæ¨¡å¼">ğŸ“±</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // é”™è¯¯æ•è·
        window.onerror = (msg) => document.getElementById('err-log').innerHTML += msg + '<br>';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.gyroActive = false;

                // é™€èºä»ªè¿ç®—ä¸“ç”¨å˜é‡
                this.baseQuaternion = new THREE.Quaternion(); // å¼€å¯é‚£ä¸€åˆ»çš„åŸºå‡†è§’åº¦
                this.startBeta = 0;
                this.startGamma = 0;
                this.currentBeta = 0;
                this.currentGamma = 0;
            }

            async init() {
                try {
                    // 1. åˆå§‹åŒ– Viewer (å®Œå…¨å¤åˆ»å®Œç¾ç‰ˆçš„å‚æ•°)
                    this.viewer = new Viewer({
                        'cameraUp': [0, 1, 0],
                        'initialCameraPosition': [0, 1, 4],
                        'initialCameraLookAt': [0, 0, 0],
                        'useBuiltInControls': false, // ğŸš« å…³é”®ï¼šå…³æ‰å†…ç½®ï¼Œç”¨æˆ‘ä»¬è‡ªå·±çš„
                        'selfDrivenMode': false,     // æ‰‹åŠ¨é©±åŠ¨æ¸²æŸ“
                        'sharedMemoryForWorkers': false
                    });
                    document.body.appendChild(this.viewer.renderer.domElement);

                    // 2. åˆå§‹åŒ– OrbitControls (è§¦æ‘¸æ§åˆ¶)
                    // âš ï¸ å…³é”®ï¼šç»‘å®šåˆ° document.bodyï¼Œç¡®ä¿è§¦æ‘¸å“åº”ç»å¯¹çµæ•
                    this.controls = new OrbitControls(this.viewer.camera, document.body);
                    this.controls.enableDamping = true; // å¼€å¯æƒ¯æ€§
                    this.controls.dampingFactor = 0.05;
                    this.controls.minDistance = 0.1;
                    this.controls.maxDistance = 100;
                    // å…è®¸å¤§è§’åº¦è§‚å¯Ÿ
                    this.controls.minPolarAngle = 0; 
                    this.controls.maxPolarAngle = Math.PI;

                    // 3. ç›‘å¬é™€èºä»ªæ•°æ® (æ—¶åˆ»å‡†å¤‡ç€)
                    window.addEventListener('deviceorientation', (e) => {
                        this.currentBeta = e.beta || 0;   // å‰åç¿»è½¬
                        this.currentGamma = e.gamma || 0; // å·¦å³ç¿»è½¬
                    });

                    // 4. å¯åŠ¨æ¸²æŸ“å¾ªç¯
                    this.animate();

                    // 5. åŠ è½½æ¨¡å‹
                    await this.loadModel();

                    // 6. ç»‘å®šæŒ‰é’®
                    this.bindEvents();

                } catch (e) {
                    alert("åˆå§‹åŒ–é”™è¯¯: " + e.message);
                }
            }

            async loadModel() {
                const response = await fetch(MODEL_URL);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob) + '#.splat';

                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });
                
                // éšè— Loading
                document.getElementById('loader').style.opacity = 0;
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }

            toggleGyro() {
                // å¤„ç† iOS 13+ æƒé™
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(state => {
                            if (state === 'granted') this._setGyroState(!this.gyroActive);
                            else alert("éœ€è¦æƒé™æ‰èƒ½ä½¿ç”¨ä½“æ„Ÿ");
                        })
                        .catch(console.error);
                } else {
                    this._setGyroState(!this.gyroActive);
                }
            }

            _setGyroState(active) {
                this.gyroActive = active;
                const btn = document.getElementById('btn-gyro');
                const msg = document.getElementById('status-msg');

                if (this.gyroActive) {
                    // === å¼€å¯é™€èºä»ª ===
                    // 1. ç¦ç”¨è§¦æ‘¸ï¼Œé˜²æ­¢å†²çª
                    this.controls.enabled = false;
                    
                    // 2. é”å®šå½“å‰è§†è§’ä¸ºâ€œåŸºå‡†â€
                    this.baseQuaternion.copy(this.viewer.camera.quaternion);
                    this.startBeta = this.currentBeta;
                    this.startGamma = this.currentGamma;

                    // UI å˜åŒ–
                    btn.classList.add('active');
                    msg.classList.add('gyro-on');
                    msg.innerText = "ğŸ“± æ™ƒåŠ¨æ‰‹æœºå¾®è°ƒè§†è§’";

                } else {
                    // === å…³é—­é™€èºä»ª ===
                    // 1. æ¢å¤è§¦æ‘¸
                    this.controls.enabled = true;
                    
                    // UI å˜åŒ–
                    btn.classList.remove('active');
                    msg.classList.remove('gyro-on');
                    msg.innerText = "ğŸ‘† è§¦æ‘¸æ»‘åŠ¨ä»¥è°ƒæ•´è§†è§’";
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                if (this.gyroActive) {
                    // === é™€èºä»ªæ¨¡å¼é€»è¾‘ ===
                    
                    // 1. è®¡ç®—åç§»é‡ (å½“å‰å§¿æ€ - åˆå§‹å§¿æ€)
                    let deltaX = this.currentBeta - this.startBeta;   // ä¸Šä¸‹ç‚¹å¤´
                    let deltaY = this.currentGamma - this.startGamma; // å·¦å³æ‘‡å¤´

                    // 2. é™åˆ¶å¹…åº¦ (Clamp) - æ¯”å¦‚æœ€å¤šåè½¬ 20 åº¦
                    const MAX_DEG = 20;
                    deltaX = Math.max(-MAX_DEG, Math.min(MAX_DEG, deltaX));
                    deltaY = Math.max(-MAX_DEG, Math.min(MAX_DEG, deltaY));

                    // 3. çµæ•åº¦ (0.5 è¡¨ç¤ºåŠ¨1åº¦ï¼Œç”»é¢è½¬0.5åº¦)
                    const SENSITIVITY = 0.5;
                    
                    // 4. å°†åç§»è½¬ä¸ºå››å…ƒæ•°
                    const qx = new THREE.Quaternion();
                    qx.setFromAxisAngle(new THREE.Vector3(1, 0, 0), THREE.MathUtils.degToRad(deltaX * SENSITIVITY));
                    
                    const qy = new THREE.Quaternion();
                    qy.setFromAxisAngle(new THREE.Vector3(0, 1, 0), THREE.MathUtils.degToRad(deltaY * SENSITIVITY));

                    // 5. åº”ç”¨ï¼šåŸºå‡†è§†è§’ * åç§»
                    // é¡ºåºï¼šå…ˆå·¦å³åï¼Œå†ä¸Šä¸‹å (ç¬¦åˆå¤´éƒ¨è¿åŠ¨ç›´è§‰)
                    const targetQ = this.baseQuaternion.clone();
                    targetQ.multiply(qy); // å·¦å³
                    targetQ.multiply(qx); // ä¸Šä¸‹
                    
                    // 6. å¹³æ»‘æ’å€¼ (slerp) è®©è¿åŠ¨æ›´æŸ”å’Œ
                    this.viewer.camera.quaternion.slerp(targetQ, 0.1);

                } else {
                    // === è§¦æ§æ¨¡å¼é€»è¾‘ ===
                    // å¿…é¡»æ¯å¸§æ›´æ–° controls æ‰æœ‰æƒ¯æ€§æ•ˆæœ
                    this.controls.update();
                }

                this.viewer.update();
                this.viewer.render();
            }

            bindEvents() {
                document.getElementById('btn-reset').addEventListener('click', () => {
                    this.controls.reset();
                    if(this.gyroActive) this._setGyroState(false);
                });

                document.getElementById('btn-gyro').addEventListener('click', () => {
                    this.toggleGyro();
                });
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
