<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS ç»ˆææš´åŠ›ç‰ˆ</title>
    <style>
        /* 1. å¼ºåˆ¶å…¨å±ï¼Œç¦æ­¢æ‰€æœ‰é»˜è®¤æ»šåŠ¨ */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; /* å…³é”®ï¼šç¦æ­¢æµè§ˆå™¨å¤„ç†è§¦æ‘¸ */
        }

        /* 2. è°ƒè¯•ä¿¡æ¯ */
        #debug-info {
            position: absolute; top: 10px; left: 10px; 
            color: yellow; font-family: monospace; font-size: 12px;
            background: rgba(0,0,0,0.5); padding: 5px; pointer-events: none;
            z-index: 9999;
        }

        /* 3. åº•éƒ¨æ“ä½œæ  */
        #toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; z-index: 1000;
        }
        .btn {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid #555;
            background: rgba(50,50,50,0.8); color: white; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: #00ff88; color: black; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="debug-info">
        åˆå§‹åŒ–ä¸­...<br>
        å¦‚æœæ˜¯çº¢å—èƒ½åŠ¨ä½†æ¨¡å‹ä¸åŠ¨ï¼Œè¯´æ˜æ¨¡å‹å¤ªå°æˆ–å¤ªè¿œã€‚
    </div>

    <div id="toolbar">
        <div class="btn" id="btn-reset">ğŸ </div>
        <div class="btn" id="btn-mode">ğŸ‘ï¸</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // è°ƒè¯•è¾“å‡º
        const debugEl = document.getElementById('debug-info');
        function log(msg) { debugEl.innerHTML = msg + '<br>' + debugEl.innerHTML; }
        
        // æ•è·æ‰€æœ‰é”™è¯¯
        window.onerror = (e) => log("âŒ ERROR: " + e);

        // å…¨å±€å˜é‡
        let viewer, controls, gizmo, splatMesh;
        let testBox; // æµ‹è¯•ç”¨çš„çº¢è‰²æ–¹å—

        async function init() {
            try {
                log("1. å¯åŠ¨ Viewer...");
                
                // âš ï¸ æ ¸å¿ƒé…ç½®ï¼šå®Œå…¨ç¦ç”¨å†…ç½®æ§åˆ¶ï¼Œè‡ªé©±åŠ¨å¾ªç¯
                viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 2, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, 
                    'selfDrivenMode': false, // å…³é—­è‡ªå¸¦å¾ªç¯ï¼Œæˆ‘ä»¬æ‰‹åŠ¨é€šè¿‡ requestAnimationFrame é©±åŠ¨
                    'sharedMemoryForWorkers': false
                });

                // å¼ºåˆ¶ Canvas æ ·å¼
                const canvas = viewer.renderer.domElement;
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.zIndex = '1'; // ç¡®ä¿åœ¨åº•å±‚
                document.body.appendChild(canvas);

                // 2. æ·»åŠ æµ‹è¯•å‚ç…§ç‰© (çº¢è‰²æ–¹å—)
                log("2. æ·»åŠ æµ‹è¯•æ–¹å—...");
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                testBox = new THREE.Mesh(geometry, material);
                testBox.position.y = 0.5;
                viewer.threeScene.add(testBox);
                
                // æ·»åŠ ç½‘æ ¼
                viewer.threeScene.add(new THREE.GridHelper(10, 10));

                // 3. æ‰‹åŠ¨ç»‘å®š OrbitControls (ç»‘å®šåˆ° body ç¡®ä¿èƒ½æŠ“åˆ°äº‹ä»¶)
                log("3. ç»‘å®šæ§åˆ¶å™¨åˆ° document.body...");
                controls = new OrbitControls(viewer.camera, document.body); // ğŸ‘ˆ å…³é”®ï¼šç»‘å®šåˆ° body
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 0.1;
                controls.maxDistance = 100;

                // 4. åˆå§‹åŒ– Gizmo
                gizmo = new TransformControls(viewer.camera, canvas);
                gizmo.setSize(1.2);
                gizmo.addEventListener('dragging-changed', (e) => {
                    controls.enabled = !e.value;
                });
                viewer.threeScene.add(gizmo);

                // 5. å¯åŠ¨è‡ªå®šä¹‰æ¸²æŸ“å¾ªç¯
                log("4. å¯åŠ¨æ¸²æŸ“å¾ªç¯...");
                animate();

                // 6. åŠ è½½æ¨¡å‹
                log("5. å¼€å§‹ä¸‹è½½æ¨¡å‹...");
                const url = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';
                
                // ä½¿ç”¨ fetch ä¸‹è½½
                const response = await fetch(url);
                const blob = await response.blob();
                const objectURL = URL.createObjectURL(blob) + '#.splat';
                
                log("6. è§£ææ¨¡å‹æ•°æ®...");
                await viewer.addSplatScene(objectURL, { 'showLoadingUI': false });
                
                splatMesh = viewer.getSplatScene(0);
                if (splatMesh) {
                    log("âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼");
                    // è‡ªåŠ¨ç¼©æ”¾æ¨¡å‹ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé˜²æ­¢å¤ªå°çœ‹ä¸è§
                    splatMesh.scale.set(1, 1, 1);
                    splatMesh.position.set(0, 0, 0);
                    
                    // é»˜è®¤é™„ç€ gizmo
                    gizmo.attach(splatMesh);
                    gizmo.setMode('translate'); // é»˜è®¤ç§»åŠ¨æ¨¡å¼
                } else {
                    log("âš ï¸ æœªæ£€æµ‹åˆ°æ¨¡å‹å¯¹è±¡");
                }

            } catch (err) {
                log("âŒ åˆå§‹åŒ–å´©æºƒ: " + err.message);
            }
        }

        // è‡ªå®šä¹‰æ¸²æŸ“å¾ªç¯ (å¼ºåŠ›é©±åŠ¨)
        function animate() {
            requestAnimationFrame(animate);
            
            // 1. è®©æµ‹è¯•æ–¹å—è½¬èµ·æ¥ (è¯æ˜ç”»é¢æ˜¯æ´»çš„)
            if (testBox) {
                testBox.rotation.y += 0.01;
                testBox.rotation.x += 0.005;
            }

            // 2. æ›´æ–°æ§åˆ¶å™¨
            if (controls) controls.update();

            // 3. å¼ºåˆ¶ Viewer æ¸²æŸ“
            // æ³¨æ„ï¼šgaussian-splats-3d çš„ update() éœ€è¦æ‰‹åŠ¨è°ƒç”¨
            if (viewer) {
                viewer.update(); 
                viewer.render(); 
            }
        }

        // æŒ‰é’®äº¤äº’
        document.getElementById('btn-reset').addEventListener('click', () => {
            controls.reset();
            if (splatMesh) {
                splatMesh.position.set(0,0,0);
                splatMesh.rotation.set(0,0,0);
                splatMesh.scale.set(1,1,1);
            }
            log("ä½ç½®å·²é‡ç½®");
        });

        let modeIndex = 0;
        const modes = ['translate', 'rotate', 'scale', 'view'];
        document.getElementById('btn-mode').addEventListener('click', () => {
            modeIndex = (modeIndex + 1) % modes.length;
            const mode = modes[modeIndex];
            log("åˆ‡æ¢æ¨¡å¼: " + mode);
            
            if (mode === 'view') {
                gizmo.detach();
                controls.enabled = true;
                document.getElementById('btn-mode').innerText = 'ğŸ‘ï¸';
            } else {
                if(splatMesh) gizmo.attach(splatMesh);
                gizmo.setMode(mode);
                document.getElementById('btn-mode').innerText = mode === 'translate' ? 'âœ¢' : (mode === 'rotate' ? 'â†»' : 'â¤¢');
            }
        });

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
