<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Immersive Window</title>
    <style>
        /* --- 1. åŸºç¡€ç¯å¢ƒ --- */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: sans-serif; user-select: none;
        }

        /* --- 2. é¡¶éƒ¨æç¤º --- */
        #top-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .status-pill {
            background: rgba(0,0,0,0.6); color: #fff; padding: 8px 18px;
            border-radius: 20px; font-size: 14px; border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px); transition: all 0.3s;
        }
        .status-pill.active {
            border-color: #00ff88; color: #00ff88; background: rgba(0,255,136,0.2);
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
        }

        /* --- 3. åº•éƒ¨æŒ‰é’® --- */
        #bottom-ui {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 30px;
            pointer-events: none; z-index: 100;
        }
        .btn {
            pointer-events: auto;
            width: 64px; height: 64px; border-radius: 50%; border: 2px solid #555;
            background: rgba(40,40,40,0.9); color: white; font-size: 26px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            transition: transform 0.1s, background 0.3s;
        }
        .btn:active { transform: scale(0.95); }
        .btn.gyro-active { border-color: #00ff88; background: #003311; color: #00ff88; }

        /* --- åŠ è½½ --- */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .text { color:#00ff88; margin-top:15px; font-family:monospace; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="font-size:40px;">ğŸ§Š</div>
        <div class="text">æ­£åœ¨æ„å»ºå®æ™¯çª—å£...</div>
    </div>

    <div id="top-ui">
        <div class="status-pill" id="msg">ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨å¯»æ‰¾è§†è§’</div>
    </div>

    <div id="bottom-ui">
        <div class="btn" id="btn-reset">â†º</div>
        <div class="btn" id="btn-gyro">ğŸ“±</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä¾ç„¶æ˜¯è¿™ä¸ªæœ€ç¨³çš„é…ç½®
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        // æ ¸å¿ƒå˜é‡
        let viewer, controls;
        let isGyroOn = false;
        
        // é™€èºä»ªè®¡ç®—ä¸“ç”¨
        const baseQuaternion = new THREE.Quaternion(); // å¼€å¯æ—¶åˆ»çš„â€œåŸºå‡†å§¿æ€â€
        let startBeta = 0, startGamma = 0;             // å¼€å¯æ—¶åˆ»çš„æ‰‹æœºè§’åº¦
        let currentBeta = 0, currentGamma = 0;         // å®æ—¶æ‰‹æœºè§’åº¦

        async function init() {
            // 1. åˆå§‹åŒ– Viewer (ä½ çš„æœ€çˆ±é…ç½®)
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 1, 5],
                'initialCameraLookAt': [0, 0, 0],
                'useBuiltInControls': false, 
                'selfDrivenMode': false,
                'sharedMemoryForWorkers': false
            });

            const canvas = viewer.renderer.domElement;
            canvas.style.position = 'absolute'; 
            canvas.style.zIndex = '0';
            document.body.appendChild(canvas);

            // 2. åˆå§‹åŒ– OrbitControls (å¿…é¡»ç»‘å®šåˆ° body)
            controls = new OrbitControls(viewer.camera, document.body);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 0.1;
            controls.maxDistance = 100;
            
            // 3. å…¨å±€ç›‘å¬è®¾å¤‡æ–¹å‘ (åªè®°å½•æ•°æ®ï¼Œä¸å¤„ç†é€»è¾‘)
            window.addEventListener('deviceorientation', (e) => {
                // beta: å‰åå€¾æ–œ (-180 ~ 180)
                // gamma: å·¦å³å€¾æ–œ (-90 ~ 90)
                currentBeta = e.beta || 0;
                currentGamma = e.gamma || 0;
            });

            // 4. å¯åŠ¨å¾ªç¯
            animate();

            // 5. åŠ è½½æ¨¡å‹
            await loadModel();

            // 6. ç»‘å®šäº‹ä»¶
            setupEvents();
        }

        async function loadModel() {
            const resp = await fetch(MODEL_URL);
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob) + '#.splat';
            await viewer.addSplatScene(url, { 'showLoadingUI': false });
            
            document.getElementById('loader').style.display = 'none';
        }

        function setupEvents() {
            // é‡ç½®æŒ‰é’®
            document.getElementById('btn-reset').addEventListener('click', () => {
                controls.reset();
                if (isGyroOn) toggleGyro(); // é‡ç½®æ—¶è‡ªåŠ¨é€€å›æ‰‹æŒ‡æ¨¡å¼
            });

            // é™€èºä»ªå¼€å…³
            document.getElementById('btn-gyro').addEventListener('click', toggleGyro);
        }

        function toggleGyro() {
            // iOS æƒé™è¯·æ±‚å¤§æ³•
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(res => {
                        if (res === 'granted') executeToggle();
                        else alert("è¯·å…è®¸é™€èºä»ªæƒé™ä»¥ä½¿ç”¨ä½“æ„ŸåŠŸèƒ½");
                    })
                    .catch(console.error);
            } else {
                executeToggle();
            }
        }

        function executeToggle() {
            isGyroOn = !isGyroOn;
            const btn = document.getElementById('btn-gyro');
            const msg = document.getElementById('msg');

            if (isGyroOn) {
                // === å¼€å¯ä½“æ„Ÿæ¨¡å¼ ===
                
                // 1. ç¦ç”¨æ‰‹æŒ‡è§¦æ§ (é˜²æ­¢æ‰“æ¶)
                controls.enabled = false;
                
                // 2. æ ¸å¿ƒï¼šé”å®šå½“å‰è§†è§’ä¸ºâ€œé›¶ç‚¹â€
                baseQuaternion.copy(viewer.camera.quaternion);
                
                // 3. è®°å½•å½“å‰çš„æ‰‹æœºè§’åº¦ä¸ºâ€œé›¶ç‚¹â€
                startBeta = currentBeta;
                startGamma = currentGamma;

                // UI çŠ¶æ€
                btn.classList.add('gyro-active');
                msg.classList.add('active');
                msg.innerText = "ğŸ“± æ™ƒåŠ¨æ‰‹æœºé¢„è§ˆ (å·²é™åˆ¶å¹…åº¦)";

            } else {
                // === å…³é—­ä½“æ„Ÿæ¨¡å¼ ===
                
                // 1. æ¢å¤æ‰‹æŒ‡è§¦æ§
                controls.enabled = true;

                // UI çŠ¶æ€
                btn.classList.remove('gyro-active');
                msg.classList.remove('active');
                msg.innerText = "ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨å¯»æ‰¾è§†è§’";
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isGyroOn) {
                // ==========================
                // ğŸª é™€èºä»ªæ ¸å¿ƒç®—æ³• (æ”¹è‰¯ç‰ˆ)
                // ==========================

                // 1. è®¡ç®—åç§»é‡ (ç°åœ¨ - åˆå§‹)
                let deltaX = currentBeta - startBeta;   // å‚ç›´å˜åŒ– (æŠ¬å¤´ä½å¤´)
                let deltaY = currentGamma - startGamma; // æ°´å¹³å˜åŒ– (å·¦è½¬å³è½¬)

                // 2. é™åˆ¶è§’åº¦ (Clamping) - è¿™å°±æ˜¯ä½ è¦æ±‚çš„â€œä»¥å…æš´éœ²ä¸å®Œç¾çš„åœ°æ–¹â€
                // è¿™é‡Œè®¾ç½®ä¸º 15 åº¦ã€‚è¶…è¿‡15åº¦ï¼Œè§†è§’å°±ä¸å†åŠ¨äº†ã€‚
                const MAX_ANGLE = 15; 
                deltaX = Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, deltaX));
                deltaY = Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, deltaY));

                // 3. è½¬æ¢æ–¹å‘ (Mapping)
                // ä½ çš„è¦æ±‚ï¼šå‘å·¦ç§»åŠ¨ = æµè§ˆæ¨¡å¼å•æŒ‡å‘å³æ»‘ (å³è§†è§’å‘å·¦è½¬)
                // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š
                // æ‰‹æœºå‘å·¦å€¾æ–œ (Gammaå˜å°) -> Cameraéœ€è¦å‘å·¦çœ‹ (ç»•Yè½´æ­£å‘æ—‹è½¬)
                // æ‰‹æœºå‘ä¸Šå€¾æ–œ (Betaå˜å¤§)   -> Cameraéœ€è¦å‘ä¸Šçœ‹ (ç»•Xè½´æ­£å‘æ—‹è½¬)
                
                const sensitivity = 0.8; // çµæ•åº¦ï¼Œè¶Šå°è¶Šå¹³æ»‘

                const qx = new THREE.Quaternion();
                qx.setFromAxisAngle(new THREE.Vector3(1, 0, 0), THREE.MathUtils.degToRad(deltaX * sensitivity));
                
                const qy = new THREE.Quaternion();
                qy.setFromAxisAngle(new THREE.Vector3(0, 1, 0), THREE.MathUtils.degToRad(deltaY * sensitivity));

                // 4. åº”ç”¨æ—‹è½¬
                // ç›®æ ‡è§’åº¦ = åˆå§‹åŸºå‡†è§’åº¦ * å·¦å³åç§» * ä¸Šä¸‹åç§»
                const targetQuaternion = baseQuaternion.clone().multiply(qy).multiply(qx);

                // 5. å¹³æ»‘æ’å€¼ (Slerp) - è®©è¿åŠ¨åƒæœå†»ä¸€æ ·é¡ºæ»‘ï¼Œä¸æŠ–åŠ¨
                viewer.camera.quaternion.slerp(targetQuaternion, 0.1);

            } else {
                // === æ‰‹æŒ‡è§¦æ§æ¨¡å¼ ===
                controls.update();
            }

            // å¼ºåˆ¶æ¸²æŸ“
            if (viewer) {
                viewer.update();
                viewer.render();
            }
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
