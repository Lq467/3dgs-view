<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS å®Œç¾äº¤äº’ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ¡ */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 10px; background: rgba(0,0,0,0.6); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        #controls {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            z-index: 1000; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°æŒ‰é’® */
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            pointer-events: auto;
            padding: 12px 24px; font-size: 16px; font-weight: bold;
            border-radius: 30px; border: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }

        /* é™€èºä»ªæŒ‰é’® */
        #gyro-btn {
            background: #444; color: white; border: 2px solid #666;
        }
        #gyro-btn.active {
            background: #0f0; color: black; border-color: #0f0;
            box-shadow: 0 0 15px #0f0;
        }

        /* é‡ç½®è§†è§’æŒ‰é’® */
        #reset-btn {
            background: white; color: black;
        }
    </style>
    
    <!-- å¼•ç”¨ v0.4.7 å¼•æ“ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">å‡†å¤‡åŠ è½½...</div>

    <div id="controls">
        <button id="reset-btn" class="btn" style="display:none">ğŸ‘€ é‡ç½®è§†è§’</button>
        <button id="gyro-btn" class="btn" style="display:none">ğŸ§­ å¼€å¯é™€èºä»ª</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ğŸ‘‡ ä½ çš„ HF ç›´é“¾
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const gyroBtn = document.getElementById('gyro-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        let viewer;
        let isGyroActive = false;
        let initialGyro = null;
        
        // é™€èºä»ªé™åˆ¶è§’åº¦
        const CLAMP_X = 0.6; 
        const CLAMP_Y = 0.8; 

        async function main() {
            // 1. åˆå§‹åŒ–å¼•æ“
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                // ğŸŸ¢ ä¿®å¤å±€éƒ¨æ˜¾ç¤ºï¼šæŠŠç›¸æœºæ‹‰è¿œä¸€ç‚¹ (z=5)ï¼ŒæŠ¬é«˜ä¸€ç‚¹ (y=1)
                'initialCameraPosition': [0, 1, 5], 
                'initialCameraLookAt': [0, 0, 0],
                // å¯ç”¨å†…ç½®è§¦æ‘¸æ§åˆ¶å™¨ (OrbitControls)
                'useBuiltInControls': true,
                'sharedMemoryForWorkers': false,
            });
            document.body.appendChild(viewer.renderer.domElement);

            try {
                // 2. ä¸‹è½½å¹¶åŠ è½½ (ä½¿ç”¨ Blob + åç¼€æ¬ºéª—æ³•)
                status.innerText = "ğŸš€ æ­£åœ¨ä¸‹è½½æ¨¡å‹...";
                const response = await fetch(MODEL_URL);
                if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥: " + response.status);

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0; 
                let chunks = []; 

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    let progress = contentLength ? Math.round((receivedLength / contentLength) * 100) + "%" : (receivedLength / 1024 / 1024).toFixed(1) + " MB";
                    status.innerText = `ğŸ“¥ ä¸‹è½½ä¸­... ${progress}`;
                }

                status.innerText = "âš™ï¸ è§£ææ¨¡å‹ä¸­...";
                const blob = new Blob(chunks);
                const originalUrl = URL.createObjectURL(blob);
                const fakeUrl = originalUrl + '#.splat'; // æ¬ºéª—å¼•æ“åç¼€

                await viewer.addSplatScene(fakeUrl, {
                    'showLoadingUI': false,
                    // ğŸŸ¢ ä¿®å¤å±€éƒ¨æ˜¾ç¤ºï¼šå‡å°é€æ˜åº¦é˜ˆå€¼ï¼Œè®©æ›´å¤šç»†èŠ‚æ˜¾ç¤ºå‡ºæ¥
                    'splatAlphaRemovalThreshold': 1, 
                    'scale': [1, 1, 1],
                    'rotation': [0, 0, 0, 1]
                });

                status.innerText = "âœ… åŠ è½½æˆåŠŸï¼";
                setTimeout(() => { status.style.display = 'none'; }, 2000);
                
                // æ˜¾ç¤ºæŒ‰é’®
                gyroBtn.style.display = 'block';
                resetBtn.style.display = 'block';
                
                viewer.start();

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
            }
        }

        // ================= äº¤äº’é€»è¾‘ =================

        // 1. é‡ç½®è§†è§’ (å¸®ä½ æ‰¾å›æ¨¡å‹)
        resetBtn.addEventListener('click', () => {
            // å¼ºåˆ¶æŠŠç›¸æœºæ¬å›åˆå§‹ä½ç½®
            viewer.camera.position.set(0, 1, 5);
            viewer.camera.lookAt(0, 0, 0);
            
            // å¦‚æœä½ åœ¨ä¹±è½¬çš„æ—¶å€™æ‰¾ä¸åˆ°æ¨¡å‹äº†ï¼Œç‚¹è¿™ä¸ª
            if (viewer.controls) {
                viewer.controls.target.set(0, 0, 0);
                viewer.controls.update();
            }
        });

        // 2. é™€èºä»ªå¼€å…³
        gyroBtn.addEventListener('click', () => {
            if (!isGyroActive) {
                // === å¼€å¯é™€èºä»ª ===
                requestGyro();
            } else {
                // === å…³é—­é™€èºä»ª ===
                isGyroActive = false;
                gyroBtn.classList.remove('active');
                gyroBtn.innerText = "ğŸ§­ å¼€å¯é™€èºä»ª";
                status.style.display = 'block';
                status.innerText = "âœ‹ å·²åˆ‡æ¢å›è§¦æ‘¸æ¨¡å¼";
                setTimeout(() => status.style.display = 'none', 1500);
                
                // æ¢å¤è§¦æ‘¸æ§åˆ¶
                if (viewer.controls) viewer.controls.enabled = true;
                window.removeEventListener('deviceorientation', handleOrientation);
            }
        });

        function requestGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateGyro();
                        } else {
                            alert('éœ€è¦å…è®¸æƒé™æ‰èƒ½ä½¿ç”¨é™€èºä»ª');
                        }
                    }).catch(console.error);
            } else {
                activateGyro();
            }
        }

        function activateGyro() {
            isGyroActive = true;
            initialGyro = null; // é‡ç½®é›¶ç‚¹
            
            // è§†è§‰åé¦ˆ
            gyroBtn.classList.add('active');
            gyroBtn.innerText = "ğŸ›‘ å…³é—­é™€èºä»ª";
            status.style.display = 'block';
            status.innerText = "ğŸ“± é™€èºä»ªå·²æ¥ç®¡ (è§¦æ‘¸æš‚åœ)";
            
            // ç¦ç”¨è§¦æ‘¸æ§åˆ¶ï¼Œé˜²æ­¢å†²çª
            if (viewer.controls) viewer.controls.enabled = false;
            
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleOrientation(event) {
            if (!viewer || !isGyroActive) return;

            // è®°å½•åˆå§‹å§¿æ€
            if (!initialGyro && event.alpha !== null) {
                initialGyro = { beta: event.beta, gamma: event.gamma };
                return;
            }
            if (!initialGyro) return;

            // è®¡ç®—æ—‹è½¬é‡
            let deltaX = (event.beta - initialGyro.beta) * (Math.PI / 180);
            let deltaY = (event.gamma - initialGyro.gamma) * (Math.PI / 180);

            // é™åˆ¶èŒƒå›´ (é˜²ç©¿å¸®)
            deltaX = Math.max(-CLAMP_X, Math.min(CLAMP_X, deltaX));
            deltaY = Math.max(-CLAMP_Y, Math.min(CLAMP_Y, deltaY));

            // ç›´æ¥æ§åˆ¶ç›¸æœºæ—‹è½¬
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ YXZ é¡ºåºï¼Œæ›´ç¬¦åˆæ‰‹æœºæ“ä½œç›´è§‰
            viewer.camera.rotation.set(deltaX, deltaY, 0, 'YXZ');
            
            // å¼ºåˆ¶æ¸²æŸ“æ›´æ–°
            viewer.update();
        }

        main();
    </script>
</body>
</html>
