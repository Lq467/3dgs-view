<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Stable Fix</title>
    <style>
        /* --- æ ¸å¿ƒæ ·å¼ï¼šå…¨å±ã€æ— æ»šåŠ¨ã€é»‘è‰²èƒŒæ™¯ --- */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨æ¥ç®¡è§¦æ‘¸ */
            font-family: monospace;
            user-select: none;
        }

        /* --- é”™è¯¯æ—¥å¿—æ§åˆ¶å° (å…³é”®è°ƒè¯•å·¥å…·) --- */
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: auto; max-height: 150px;
            background: rgba(200, 0, 0, 0.6); color: white;
            font-size: 11px; padding: 5px; pointer-events: none; z-index: 9999;
            display: none; /* å¹³æ—¶éšè—ï¼Œæœ‰é”™æ‰æ˜¾ç¤º */
            overflow-y: auto; text-align: left;
        }

        /* --- åŠ è½½ç•Œé¢ --- */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 5000;
            transition: opacity 0.5s;
        }
        .loading-bar { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; }
        .loading-progress { width: 0%; height: 100%; background: #00ff88; transition: width 0.1s; }
        .loading-text { color: #888; margin-top: 10px; font-size: 12px; }

        /* --- é¡¶éƒ¨åŠŸèƒ½åŒº --- */
        #header-bar {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: none; z-index: 1000;
        }
        
        /* é”å®šè§†è§’æŒ‰é’® */
        #lock-toggle {
            pointer-events: auto;
            background: rgba(50, 50, 50, 0.8); border: 1px solid #666; color: #ddd;
            padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 5px; opacity: 0; transition: all 0.3s;
        }
        #lock-toggle.visible { opacity: 1; }
        #lock-toggle.active { background: #ffaa00; color: #000; border-color: #ffaa00; box-shadow: 0 0 15px rgba(255,170,0,0.5); }

        /* é‡ç½®æŒ‰é’® */
        #reset-btn {
            pointer-events: auto;
            background: rgba(50, 50, 50, 0.8); color: white; border: 1px solid #555;
            padding: 8px 12px; border-radius: 20px; cursor: pointer;
        }

        /* --- åº•éƒ¨å·¥å…·æ  --- */
        #dock {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20,20,20,0.9); padding: 8px; border-radius: 24px;
            display: flex; gap: 10px; border: 1px solid #444; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .dock-btn {
            width: 50px; height: 50px; background: transparent; border: none;
            color: #888; font-size: 20px; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative;
        }
        .dock-btn span { font-size: 10px; margin-top: 3px; }
        
        .dock-btn.active { background: #333; color: white; transform: translateY(-3px); }
        .dock-btn.active.view { color: #00ff88; box-shadow: 0 5px 15px rgba(0,255,136,0.2); }
        .dock-btn.active.edit { color: #00aaff; box-shadow: 0 5px 15px rgba(0,170,255,0.2); }
        
        .divider { width: 1px; height: 30px; background: #444; margin: 10px 0; }

        /* çŠ¶æ€æç¤ºåå¸ */
        #toast {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 6px 15px;
            border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 2000; border: 1px solid #333;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <!-- é”™è¯¯æ—¥å¿— (è‡ªåŠ¨æ˜¾ç¤º) -->
    <div id="console-log"></div>

    <!-- åŠ è½½å±‚ -->
    <div id="loader">
        <div style="color:white; font-weight:bold;">âœ¨ ç³»ç»Ÿåˆå§‹åŒ–...</div>
        <div class="loading-bar"><div class="loading-progress" id="progress"></div></div>
        <div class="loading-text" id="progress-text">0%</div>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div id="toast">æç¤ºä¿¡æ¯</div>

    <!-- é¡¶éƒ¨ -->
    <div id="header-bar">
        <button id="reset-btn">ğŸ”„ é‡ç½®</button>
        <button id="lock-toggle">ğŸ”“ é”å®šè§†è§’</button>
    </div>

    <!-- åº•éƒ¨ Dock -->
    <div id="dock">
        <button class="dock-btn active view" id="btn-view" onclick="app.setMode('view')">
            ğŸ‘ï¸<span>æµè§ˆ</span>
        </button>
        <div class="divider"></div>
        <button class="dock-btn" id="btn-translate" onclick="app.setMode('translate')">
            âœ¢<span>ç§»åŠ¨</span>
        </button>
        <button class="dock-btn" id="btn-rotate" onclick="app.setMode('rotate')">
            â†»<span>æ—‹è½¬</span>
        </button>
        <button class="dock-btn" id="btn-scale" onclick="app.setMode('scale')">
            â¤¢<span>ç¼©æ”¾</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        // å›å½’ç¨³å®šçš„ OrbitControlsï¼Œè¿™æ˜¯æœ€ä¿é™©çš„
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // --- å…¨å±€é”™è¯¯æ•è· ---
        window.onerror = function(msg, url, line) {
            const log = document.getElementById('console-log');
            log.style.display = 'block';
            log.innerHTML += `âŒ ERROR: ${msg} (Line ${line})<br>`;
            document.getElementById('loader').style.display = 'none'; // å‘ç”Ÿé”™è¯¯éšè—åŠ è½½æ¡ï¼Œé˜²æ­¢é®æŒ¡
        };

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.gizmo = null;
                this.splatMesh = null;
                this.isLocked = false; // è§†è§’é”å®šçŠ¶æ€
                this.currentMode = 'view';
            }

            async init() {
                try {
                    // 1. åˆå§‹åŒ– Viewer (âš ï¸ å¿…é¡»ç¦ç”¨å†…ç½®æ§åˆ¶)
                    this.viewer = new Viewer({
                        'cameraUp': [0, 1, 0],
                        'initialCameraPosition': [0, 1, 4],
                        'initialCameraLookAt': [0, 0, 0],
                        'useBuiltInControls': false, 
                        'selfDrivenMode': false, // æ‰‹åŠ¨é©±åŠ¨
                        'sharedMemoryForWorkers': false
                    });
                    
                    document.body.appendChild(this.viewer.renderer.domElement);

                    // 2. åˆå§‹åŒ– OrbitControls (ç»‘å®šåˆ° body)
                    this.controls = new OrbitControls(this.viewer.camera, document.body);
                    this.controls.enableDamping = true; // å¼€å¯é˜»å°¼(æƒ¯æ€§)
                    this.controls.dampingFactor = 0.05;
                    this.controls.screenSpacePanning = true;
                    // æ”¾å¼€é™åˆ¶ï¼Œè™½ç„¶ä¸èƒ½ç¿»è·Ÿå¤´ï¼Œä½†èƒ½çœ‹å¤©çœ‹åœ°
                    this.controls.minDistance = 0.1;
                    this.controls.maxDistance = 100;
                    this.controls.minPolarAngle = 0; // å…è®¸çœ‹åˆ°æ­£ä¸Šæ–¹
                    this.controls.maxPolarAngle = Math.PI; // å…è®¸çœ‹åˆ°æ­£ä¸‹æ–¹

                    // 3. åˆå§‹åŒ– Gizmo (ç¼–è¾‘è½´)
                    this.gizmo = new TransformControls(this.viewer.camera, this.viewer.renderer.domElement);
                    this.gizmo.setSize(1.2); 
                    // ğŸ”¥ è®©åæ ‡è½´æ°¸è¿œæ˜¾ç¤ºåœ¨æœ€å‰é¢ (ä¸è¢«æ¨¡å‹é®æŒ¡)
                    this.gizmo.traverse(child => {
                        if(child.material) {
                            child.material.depthTest = false;
                            child.material.depthWrite = false;
                        }
                    });

                    // æ‹–æ‹½ Gizmo æ—¶è‡ªåŠ¨å¤„ç†äº‹ä»¶
                    this.gizmo.addEventListener('dragging-changed', (event) => {
                        if (!this.isLocked) {
                            // åªæœ‰åœ¨æœªé”å®šçš„æƒ…å†µä¸‹ï¼Œæ‰è‡ªåŠ¨å¼€å…³è§†è§’
                            this.controls.enabled = !event.value;
                        }
                    });
                    this.viewer.threeScene.add(this.gizmo);

                    // 4. ç½‘æ ¼
                    const grid = new THREE.GridHelper(20, 20, 0x444444, 0x111111);
                    grid.position.y = -1;
                    this.viewer.threeScene.add(grid);

                    // 5. å¯åŠ¨å¾ªç¯
                    this.animate();

                    // 6. ä¸‹è½½å¹¶åŠ è½½
                    await this.loadModel();

                } catch (e) {
                    throw new Error("Init Failed: " + e.message);
                }
            }

            async loadModel() {
                const pBar = document.getElementById('progress');
                const pText = document.getElementById('progress-text');
                
                const response = await fetch(MODEL_URL);
                const len = +response.headers.get('Content-Length');
                const reader = response.body.getReader();
                let received = 0;
                let chunks = [];

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    chunks.push(value);
                    received += value.length;
                    if(len) {
                        const pct = (received/len)*100;
                        pBar.style.width = pct + "%";
                        pText.innerText = `ä¸‹è½½ä¸­ ${Math.round(pct)}%`;
                    }
                }

                pText.innerText = "è§£ææ¨¡å‹...";
                const blob = new Blob(chunks);
                const url = URL.createObjectURL(blob) + '#.splat';

                await this.viewer.addSplatScene(url, { 'showLoadingUI': false, 'splatAlphaRemovalThreshold': 5 });
                
                this.splatMesh = this.viewer.getSplatScene(0);

                // éšè—åŠ è½½
                document.getElementById('loader').style.opacity = 0;
                setTimeout(()=>document.getElementById('loader').style.display='none', 500);
                
                if(this.splatMesh) {
                    this.showToast("âœ… åŠ è½½æˆåŠŸ");
                    this.setMode('view');
                }
            }

            setMode(mode) {
                this.currentMode = mode;
                
                // UI æ›´æ–°
                document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active', 'view', 'edit'));
                const activeBtn = document.getElementById(mode === 'view' ? 'btn-view' : 'btn-' + mode);
                activeBtn.classList.add('active', mode === 'view' ? 'view' : 'edit');

                const lockBtn = document.getElementById('lock-toggle');

                if (mode === 'view') {
                    // æµè§ˆæ¨¡å¼
                    this.gizmo.detach();
                    this.unlockCamera(); // å¼ºåˆ¶è§£é”
                    lockBtn.classList.remove('visible'); // éšè—é”å®šæŒ‰é’®
                    this.showToast("ğŸ‘ï¸ æµè§ˆæ¨¡å¼");
                } else {
                    // ç¼–è¾‘æ¨¡å¼
                    if (this.splatMesh) {
                        this.gizmo.attach(this.splatMesh);
                        this.gizmo.setMode(mode);
                    }
                    lockBtn.classList.add('visible'); // æ˜¾ç¤ºé”å®šæŒ‰é’®
                    this.showToast(`ğŸ”§ ${mode}æ¨¡å¼`);
                }
            }

            toggleLock() {
                if (this.isLocked) this.unlockCamera();
                else this.lockCamera();
            }

            lockCamera() {
                this.isLocked = true;
                this.controls.enabled = false;
                const btn = document.getElementById('lock-toggle');
                btn.classList.add('active');
                btn.innerHTML = "ğŸ”’ è§†è§’å·²é”";
                this.showToast("ğŸ”’ è§†è§’é”å®šï¼šåªèƒ½ç¼–è¾‘æ¨¡å‹");
            }

            unlockCamera() {
                this.isLocked = false;
                this.controls.enabled = true;
                const btn = document.getElementById('lock-toggle');
                btn.classList.remove('active');
                btn.innerHTML = "ğŸ”“ é”å®šè§†è§’";
                if(this.currentMode !== 'view') this.showToast("ğŸ”“ è§†è§’è§£é”");
            }

            resetView() {
                this.controls.reset();
                this.viewer.camera.position.set(0, 1, 4);
                this.viewer.camera.lookAt(0,0,0);
                this.showToast("ğŸ“· è§†è§’é‡ç½®");
            }

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.opacity = 1;
                clearTimeout(this.toastTimer);
                this.toastTimer = setTimeout(()=>t.style.opacity=0, 2500);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                if(this.controls) this.controls.update();
                if(this.viewer) {
                    this.viewer.update();
                    this.viewer.render();
                }
            }
        }

        // å¯åŠ¨
        window.app = new App();
        window.app.init();

        // ç»‘å®šHTMLæŒ‰é’®äº‹ä»¶
        document.getElementById('reset-btn').addEventListener('click', () => window.app.resetView());
        document.getElementById('lock-toggle').addEventListener('click', () => window.app.toggleLock());

    </script>
</body>
</html>
