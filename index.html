<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS ä¸‡èƒ½è°ƒè¯•ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ¡ */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 10px; background: rgba(0,0,0,0.6); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶åŒº (æ»‘æ† + æŒ‰é’®) */
        #ui-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8); padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000;
        }

        .slider-row {
            display: flex; align-items: center; justify-content: space-between;
            color: white; font-size: 14px;
        }
        .slider-row input { flex: 1; margin: 0 10px; }

        .btn-row {
            display: flex; justify-content: center; gap: 20px; margin-top: 10px;
        }

        .btn {
            padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none;
            background: #444; color: white; cursor: pointer;
        }
        .btn.active { background: #0f0; color: black; }
    </style>
    
    <!-- å¼•ç”¨ v0.4.7 å¼•æ“ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">æ­£åœ¨åŠ è½½...</div>

    <div id="ui-panel" style="display:none">
        <!-- è°ƒè¯•æ»‘æ†ï¼šå¸®ä½ æ‰¾åˆ°æ¨¡å‹ï¼ -->
        <div class="slider-row">
            <span>ğŸ“· è·ç¦»</span>
            <input type="range" id="cam-dist" min="1" max="50" step="0.5" value="5">
            <span id="dist-val">5.0</span>
        </div>
        <div class="slider-row">
            <span>ğŸ“ å¤§å°</span>
            <input type="range" id="model-scale" min="0.1" max="10" step="0.1" value="1">
            <span id="scale-val">1.0</span>
        </div>
        
        <!-- æŒ‰é’® -->
        <div class="btn-row">
            <button id="gyro-btn" class="btn">ğŸ§­ å¼€å¯é™€èºä»ª</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ğŸ‘‡ ä½ çš„ HF ç›´é“¾
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const uiPanel = document.getElementById('ui-panel');
        const gyroBtn = document.getElementById('gyro-btn');
        
        // æ»‘æ†å…ƒç´ 
        const distSlider = document.getElementById('cam-dist');
        const scaleSlider = document.getElementById('model-scale');
        const distVal = document.getElementById('dist-val');
        const scaleVal = document.getElementById('scale-val');

        let viewer;
        let splatScene; // ä¿å­˜æ¨¡å‹å¼•ç”¨
        let isGyroActive = false;
        let initialGyro = null;
        
        // é™€èºä»ªçµæ•åº¦
        const SENSITIVITY_X = 1.0; 
        const SENSITIVITY_Y = 1.2; 

        async function main() {
            // 1. åˆå§‹åŒ–å¼•æ“
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                // åˆå§‹ç›¸æœºæ”¾è¿œä¸€ç‚¹ï¼(Z=10)
                'initialCameraPosition': [0, 1, 10], 
                'initialCameraLookAt': [0, 0, 0],
                'useBuiltInControls': true, // å¼€å¯è§¦æ‘¸æ§åˆ¶
                'sharedMemoryForWorkers': false,
            });
            document.body.appendChild(viewer.renderer.domElement);

            try {
                status.innerText = "ğŸš€ ä¸‹è½½æ¨¡å‹ä¸­...";
                const response = await fetch(MODEL_URL);
                if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥");

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0; 
                let chunks = []; 

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    let progress = contentLength ? Math.round((receivedLength / contentLength) * 100) + "%" : (receivedLength / 1024 / 1024).toFixed(1) + " MB";
                    status.innerText = `ğŸ“¥ ä¸‹è½½ä¸­... ${progress}`;
                }

                status.innerText = "âš™ï¸ è§£æä¸­...";
                const blob = new Blob(chunks);
                // ä¼ªé€ æ–‡ä»¶å¯¹è±¡ï¼Œéª—è¿‡åç¼€æ£€æŸ¥
                const file = new File([blob], "model.splat");

                // åŠ è½½æ¨¡å‹
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬è·å–äº†è¿”å›å€¼ï¼Œä¿å­˜åˆ° splatScene å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä¿®æ”¹ Scale
                const scenes = await viewer.addSplatScene(file, {
                    'showLoadingUI': false,
                    'splatAlphaRemovalThreshold': 2, // è°ƒä½é˜ˆå€¼ï¼Œé˜²æ­¢æ¨¡å‹å˜ç¨€ç–
                });
                
                // è·å–åœºæ™¯å¼•ç”¨ (v0.4.7 è¿”å›çš„æ˜¯æ•°ç»„)
                splatScene = scenes[0];

                status.innerText = "âœ… åŠ è½½æˆåŠŸï¼è¯·è°ƒèŠ‚ä¸‹æ–¹æ»‘æ†å¯»æ‰¾æ¨¡å‹";
                setTimeout(() => { status.style.display = 'none'; }, 2000);
                
                uiPanel.style.display = 'block';
                viewer.start();

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
            }
        }

        // ================= æ»‘æ†æ§åˆ¶ =================

        // 1. è·ç¦»æ»‘æ†ï¼šæ§åˆ¶ç›¸æœº Z è½´
        distSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            distVal.innerText = val.toFixed(1);
            
            // ç§»åŠ¨ç›¸æœº
            viewer.camera.position.z = val;
            viewer.camera.lookAt(0, 0, 0);
            
            // å¦‚æœè§¦æ‘¸æ§åˆ¶å™¨å¼€å¯ï¼Œä¹Ÿè¦æ›´æ–°æ§åˆ¶å™¨çš„ç›®æ ‡
            if (viewer.controls) {
                viewer.controls.update();
            }
        });

        // 2. å¤§å°æ»‘æ†ï¼šæ§åˆ¶æ¨¡å‹ Scale
        scaleSlider.addEventListener('input', (e) => {
            if (!splatScene) return;
            const val = parseFloat(e.target.value);
            scaleVal.innerText = val.toFixed(1);
            
            // ä¿®æ”¹æ¨¡å‹ç¼©æ”¾
            splatScene.scale.set(val, val, val);
        });


        // ================= é™€èºä»ªæ§åˆ¶ =================

        gyroBtn.addEventListener('click', () => {
            if (!isGyroActive) {
                // å¼€å¯
                requestGyro();
            } else {
                // å…³é—­
                isGyroActive = false;
                gyroBtn.classList.remove('active');
                gyroBtn.innerText = "ğŸ§­ å¼€å¯é™€èºä»ª";
                status.style.display = 'block';
                status.innerText = "âœ‹ å·²æ¢å¤è§¦æ‘¸æ¨¡å¼";
                setTimeout(() => status.style.display = 'none', 1000);
                
                // æ¢å¤è§¦æ‘¸
                if (viewer.controls) viewer.controls.enabled = true;
                window.removeEventListener('deviceorientation', handleOrientation);
            }
        });

        function requestGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateGyro();
                        } else {
                            alert('æ— æƒé™');
                        }
                    }).catch(console.error);
            } else {
                activateGyro();
            }
        }

        function activateGyro() {
            isGyroActive = true;
            initialGyro = null;
            gyroBtn.classList.add('active');
            gyroBtn.innerText = "ğŸ›‘ å…³é—­é™€èºä»ª";
            
            status.style.display = 'block';
            status.innerText = "ğŸ“± é™€èºä»ªæ¨¡å¼ (è§¦æ‘¸å·²ç¦ç”¨)";
            
            // ã€å…³é”®ã€‘ç¦ç”¨è§¦æ‘¸æ§åˆ¶å™¨ï¼Œå¦åˆ™å®ƒä¼šå’Œé™€èºä»ªæ‰“æ¶
            if (viewer.controls) viewer.controls.enabled = false;
            
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleOrientation(event) {
            if (!viewer || !isGyroActive) return;

            if (!initialGyro && event.alpha !== null) {
                initialGyro = { beta: event.beta, gamma: event.gamma };
                return;
            }
            if (!initialGyro) return;

            // è®¡ç®—å·®å€¼
            let deltaX = (event.beta - initialGyro.beta) * (Math.PI / 180);
            let deltaY = (event.gamma - initialGyro.gamma) * (Math.PI / 180);

            // é™åˆ¶è§’åº¦ (Clamp) - é˜²æ­¢è½¬åˆ°èƒŒé¢ç©¿å¸®
            // ä¸Šä¸‹ 30 åº¦ï¼Œå·¦å³ 45 åº¦
            deltaX = Math.max(-0.5, Math.min(0.5, deltaX));
            deltaY = Math.max(-0.8, Math.min(0.8, deltaY));

            // åº”ç”¨æ—‹è½¬
            viewer.camera.rotation.set(
                deltaX * SENSITIVITY_X, 
                deltaY * SENSITIVITY_Y, 
                0, 
                'YXZ'
            );
            
            viewer.update();
        }

        main();
    </script>
</body>
</html>
