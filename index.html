<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS è§¦æ‘¸äº¤äº’ç‰ˆ (ç±»SuperSplat)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: sans-serif; }
        
        /* é¡¶éƒ¨åŠ è½½æç¤º */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 10px; background: rgba(0,0,0,0.8); 
            color: #0f0; text-align: center; font-size: 14px; 
            z-index: 999; pointer-events: none;
        }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        #controls-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;
            background: rgba(30,30,30,0.9); 
            border-top: 1px solid #444;
            display: flex; flex-direction: column;
            z-index: 1000; transition: transform 0.3s;
        }

        /* é¢æ¿æ ‡é¢˜æ  */
        .panel-header {
            padding: 10px; background: #333; color: white; 
            font-size: 14px; display: flex; justify-content: space-between;
            cursor: pointer; user-select: none;
        }
        
        /* æ»šåŠ¨åŒºåŸŸ */
        .scroll-area {
            flex: 1; overflow-y: auto; padding: 15px;
        }

        /* æ§åˆ¶ç»„ */
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .control-title { color: #aaa; font-size: 12px; margin-bottom: 8px; font-weight: bold; }
        
        /* æ»‘æ†æ ·å¼ */
        .slider-row {
            display: flex; align-items: center; margin-bottom: 8px;
        }
        .slider-label { color: white; width: 20px; font-size: 12px; }
        input[type=range] { flex: 1; margin: 0 10px; cursor: pointer; }
        .slider-val { color: #0f0; width: 40px; font-size: 12px; text-align: right; }

        /* é‡ç½®æŒ‰é’® */
        #reset-cam {
            position: absolute; top: 20px; right: 20px;
            background: white; border: none; padding: 8px 15px;
            border-radius: 20px; cursor: pointer; z-index: 900;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); font-weight: bold;
        }
    </style>
    
    <!-- å¼•ç”¨ v0.4.7 å¼•æ“ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="status-bar">å‡†å¤‡åŠ è½½...</div>
    
    <!-- é‡ç½®ç›¸æœºæŒ‰é’® -->
    <button id="reset-cam">ğŸ”„ é‡ç½®è§†è§’</button>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="controls-panel">
        <div class="panel-header" id="toggle-panel">
            <span>ğŸ›ï¸ æ¨¡å‹å˜æ¢ (è°ƒæ•´æ¨¡å‹ä½ç½®/å¤§å°)</span>
            <span>â¬‡ï¸</span>
        </div>
        <div class="scroll-area">
            
            <!-- ç¼©æ”¾æ§åˆ¶ -->
            <div class="control-group">
                <div class="control-title">ç¼©æ”¾ (Scale) - è¿™é‡Œçš„ç¼©æ”¾ä¸€å®šç®¡ç”¨</div>
                <div class="slider-row">
                    <span class="slider-label">S</span>
                    <input type="range" id="scale" min="0.1" max="5.0" step="0.1" value="1.0">
                    <span class="slider-val" id="val-scale">1.0</span>
                </div>
            </div>

            <!-- æ—‹è½¬æ§åˆ¶ -->
            <div class="control-group">
                <div class="control-title">æ—‹è½¬ (Rotation) - æ‘†æ­£æ¨¡å‹</div>
                <div class="slider-row">
                    <span class="slider-label">X</span>
                    <input type="range" class="rot-slider" data-axis="x" min="-180" max="180" value="0">
                    <span class="slider-val" id="val-rot-x">0Â°</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Y</span>
                    <input type="range" class="rot-slider" data-axis="y" min="-180" max="180" value="0">
                    <span class="slider-val" id="val-rot-y">0Â°</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Z</span>
                    <input type="range" class="rot-slider" data-axis="z" min="-180" max="180" value="0">
                    <span class="slider-val" id="val-rot-z">0Â°</span>
                </div>
            </div>

            <!-- ä½ç½®æ§åˆ¶ -->
            <div class="control-group" style="border:none">
                <div class="control-title">ä½ç§» (Position) - æŠŠå®ƒæŒªåˆ°å±å¹•ä¸­é—´</div>
                <div class="slider-row">
                    <span class="slider-label">X</span>
                    <input type="range" class="pos-slider" data-axis="x" min="-10" max="10" step="0.1" value="0">
                    <span class="slider-val" id="val-pos-x">0</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Y</span>
                    <input type="range" class="pos-slider" data-axis="y" min="-10" max="10" step="0.1" value="0">
                    <span class="slider-val" id="val-pos-y">0</span>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ä½ çš„ HF ç›´é“¾
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        const status = document.getElementById('status-bar');
        const resetBtn = document.getElementById('reset-cam');
        let viewer;
        let splatMesh = null; // å­˜å‚¨çœŸæ­£çš„æ¨¡å‹ç½‘æ ¼

        // å˜æ¢å‚æ•°
        let params = {
            scale: 1.0,
            rot: { x: 0, y: 0, z: 0 },
            pos: { x: 0, y: 0, z: 0 }
        };

        async function main() {
            // 1. åˆå§‹åŒ–å¼•æ“
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                // ç›¸æœºä½ç½®ï¼šå¾€åæ‹‰(Z=5)ï¼Œç¨å¾®æŠ¬é«˜(Y=1)
                'initialCameraPosition': [0, 1, 5], 
                'initialCameraLookAt': [0, 0, 0],
                // ğŸŸ¢ å…³é”®ï¼šå¯ç”¨å†…ç½®æ§åˆ¶å™¨ï¼Œå®ç°å¹³æ»‘è§¦æ‘¸
                'useBuiltInControls': true, 
                'sharedMemoryForWorkers': false,
            });
            document.body.appendChild(viewer.renderer.domElement);

            try {
                // 2. ä¸‹è½½æ•°æ®
                status.innerText = "ğŸš€ æ­£åœ¨ä¸‹è½½...";
                const response = await fetch(MODEL_URL);
                if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥: " + response.status);

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0; 
                let chunks = []; 

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    let progress = contentLength ? Math.round((receivedLength / contentLength) * 100) + "%" : (receivedLength / 1024 / 1024).toFixed(1) + " MB";
                    status.innerText = `ğŸ“¥ ä¸‹è½½ä¸­... ${progress}`;
                }

                status.innerText = "âš™ï¸ å¤„ç†æ¨¡å‹...";
                const blob = new Blob(chunks);
                const originalUrl = URL.createObjectURL(blob);
                const fakeUrl = originalUrl + '#.splat'; // åç¼€æ¬ºéª—

                // 3. åŠ è½½åœºæ™¯
                await viewer.addSplatScene(fakeUrl, {
                    'showLoadingUI': false,
                    'splatAlphaRemovalThreshold': 2, 
                });

                // ğŸŸ¢ ç»ˆæä¿®æ­£ï¼šéå†åœºæ™¯å›¾ï¼Œæ‰¾åˆ°çœŸæ­£çš„ SplatMesh
                // ä¹‹å‰çš„ getSplatScene(0) å¯èƒ½è¿”å›çš„æ˜¯åŒ…è£…å™¨ï¼Œç¼©æ”¾ä¸ç”Ÿæ•ˆ
                // è¿™æ¬¡æˆ‘ä»¬æš´åŠ›æœç´¢ï¼
                viewer.scene.traverse((child) => {
                    // SplatMesh é€šå¸¸æœ‰ç‰¹æ®Šçš„å±æ€§ï¼Œæˆ–è€…å®ƒå°±æ˜¯é‚£ä¸ªå”¯ä¸€çš„ Mesh
                    if (child.isMesh || child.constructor.name.includes('Splat')) {
                        splatMesh = child;
                    }
                });
                
                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±æ‹¿ç¬¬ä¸€ä¸ªå­å¯¹è±¡å½“æ›¿è¡¥
                if (!splatMesh) {
                    splatMesh = viewer.getSplatScene(0);
                }

                console.log("æ‰¾åˆ°æ¨¡å‹å¯¹è±¡:", splatMesh);

                status.innerText = "âœ… åŠ è½½æˆåŠŸï¼è¯·ä½¿ç”¨ä¸‹æ–¹æ»‘æ†è°ƒæ•´æ¨¡å‹";
                setTimeout(() => { status.style.display = 'none'; }, 2000);
                
                viewer.start();

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ é”™è¯¯: " + err.message;
                status.style.color = "red";
            }
        }

        // ================= æ¨¡å‹å˜æ¢é€»è¾‘ =================
        
        function updateTransform() {
            if (!splatMesh) return;

            // åº”ç”¨ç¼©æ”¾
            splatMesh.scale.set(params.scale, params.scale, params.scale);

            // åº”ç”¨æ—‹è½¬ (è½¬ä¸ºå¼§åº¦)
            splatMesh.rotation.set(
                THREE.MathUtils.degToRad(params.rot.x),
                THREE.MathUtils.degToRad(params.rot.y),
                THREE.MathUtils.degToRad(params.rot.z)
            );

            // åº”ç”¨ä½ç§»
            splatMesh.position.set(params.pos.x, params.pos.y, params.pos.z);
        }

        // ç›‘å¬ç¼©æ”¾
        document.getElementById('scale').addEventListener('input', (e) => {
            params.scale = parseFloat(e.target.value);
            document.getElementById('val-scale').innerText = params.scale;
            updateTransform();
        });

        // ç›‘å¬æ—‹è½¬ (X, Y, Z)
        document.querySelectorAll('.rot-slider').forEach(el => {
            el.addEventListener('input', (e) => {
                const axis = e.target.dataset.axis;
                const val = parseFloat(e.target.value);
                params.rot[axis] = val;
                document.getElementById(`val-rot-${axis}`).innerText = val + "Â°";
                updateTransform();
            });
        });

        // ç›‘å¬ä½ç§» (X, Y)
        document.querySelectorAll('.pos-slider').forEach(el => {
            el.addEventListener('input', (e) => {
                const axis = e.target.dataset.axis;
                const val = parseFloat(e.target.value);
                params.pos[axis] = val;
                document.getElementById(`val-pos-${axis}`).innerText = val;
                updateTransform();
            });
        });

        // ================= äº¤äº’åŠŸèƒ½ =================

        // é‡ç½®ç›¸æœºæŒ‰é’®
        resetBtn.addEventListener('click', () => {
            viewer.camera.position.set(0, 1, 5);
            viewer.camera.lookAt(0, 0, 0);
            if (viewer.controls) {
                viewer.controls.target.set(0, 0, 0);
                viewer.controls.update();
            }
        });

        // æŠ˜å é¢æ¿
        const panel = document.getElementById('controls-panel');
        const header = document.getElementById('toggle-panel');
        let isExpanded = true;
        
        header.addEventListener('click', () => {
            isExpanded = !isExpanded;
            if (isExpanded) {
                panel.style.transform = "translateY(0)";
                header.querySelector('span:last-child').innerText = "â¬‡ï¸";
            } else {
                panel.style.transform = "translateY(calc(100% - 40px))"; // åªç•™æ ‡é¢˜
                header.querySelector('span:last-child').innerText = "â¬†ï¸";
            }
        });

        main();
    </script>
</body>
</html>
