<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS å…¨å±æ‰‹åŠ¿ç‰ˆ</title>
    <style>
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; /* ç¦æ­¢ç³»ç»Ÿæ»šåŠ¨ */
            font-family: sans-serif; user-select: none;
        }

        /* é¡¶éƒ¨æ“ä½œè¯´æ˜ */
        #header {
            position: absolute; top: 20px; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 1000;
        }
        .status-pill {
            background: rgba(30,30,30,0.9); color: #00ff88;
            padding: 8px 20px; border-radius: 30px; font-size: 14px; font-weight: bold;
            display: inline-block; border: 1px solid #555;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* åº•éƒ¨å·¥å…·æ  */
        #dock {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1a1a1a; padding: 10px; border-radius: 20px;
            display: flex; gap: 12px; border: 1px solid #444; z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .btn {
            width: 60px; height: 60px; background: #333; border: 1px solid #444;
            border-radius: 14px; color: #888; font-size: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.1s; position: relative;
        }
        .btn span { font-size: 11px; margin-top: 4px; }
        
        .btn.active { background: #007bff; color: white; transform: scale(1.05); border-color: #00aaff; }
        .btn.active.view { background: #00ff88; color: #000; border-color: #00ff88; }
        .btn.active.edit { background: #ffaa00; color: #000; border-color: #ffaa00; }

        /* ä¸­å¿ƒå‚è€ƒåå­—çº¿ (ä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤º) */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 500;
            display: none; opacity: 0.5;
        }
        #crosshair::before, #crosshair::after {
            content: ''; position: absolute; background: white;
        }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }

        /* è§¦æ‘¸åé¦ˆåœ†ç‚¹ */
        #touch-feedback {
            position: absolute; width: 40px; height: 40px;
            border: 2px solid rgba(255,255,255,0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 9000;
            display: none;
        }

        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="font-size:30px;">â³</div>
        <div style="color:#888; margin-top:10px;">èµ„æºåŠ è½½ä¸­...</div>
    </div>

    <div id="header">
        <div class="status-pill" id="status">ğŸ‘€ æµè§ˆæ¨¡å¼</div>
    </div>

    <div id="crosshair"></div>
    <div id="touch-feedback"></div>

    <div id="dock">
        <button class="btn active view" onclick="app.setMode('view')" id="btn-view">
            ğŸ‘ï¸<span>æµè§ˆ</span>
        </button>
        <div style="width:1px; background:#444; margin:0 5px;"></div>
        <button class="btn" onclick="app.setMode('translate')" id="btn-translate">
            âœ¢<span>ç§»åŠ¨</span>
        </button>
        <button class="btn" onclick="app.setMode('rotate')" id="btn-rotate">
            â†»<span>æ—‹è½¬</span>
        </button>
        <button class="btn" onclick="app.setMode('scale')" id="btn-scale">
            â¤¢<span>ç¼©æ”¾</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.orbit = null;
                this.container = null; // æˆ‘ä»¬çš„æ¨¡å‹å®¹å™¨
                this.helper = null;
                this.mode = 'view';
                
                // è§¦æ‘¸æ§åˆ¶å˜é‡
                this.isDragging = false;
                this.lastX = 0;
                this.lastY = 0;
            }

            async init() {
                // 1. åˆå§‹åŒ– Viewer (ç¦ç”¨ä¸€åˆ‡è‡ªå¸¦æ§åˆ¶)
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 1, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, 
                    'selfDrivenMode': false,
                    'sharedMemoryForWorkers': false
                });

                document.body.appendChild(this.viewer.renderer.domElement);

                // 2. åˆ›å»ºå®¹å™¨ (æ‰€æœ‰æ¨¡å‹éƒ½æ”¾è¿™é‡Œé¢)
                this.container = new THREE.Group();
                this.viewer.threeScene.add(this.container);

                // 3. OrbitControls (ä»…ç”¨äºæµè§ˆæ¨¡å¼)
                this.orbit = new OrbitControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.orbit.enableDamping = true;
                this.orbit.dampingFactor = 0.08;

                // 4. æ·»åŠ ç½‘æ ¼å’ŒåŒ…å›´ç›’(è§†è§‰è¾…åŠ©)
                const grid = new THREE.GridHelper(20, 20, 0x333333, 0x111111);
                grid.position.y = -1;
                this.viewer.threeScene.add(grid);

                this.helper = new THREE.BoxHelper(this.container, 0xffff00);
                this.helper.visible = false;
                this.viewer.threeScene.add(this.helper);

                // 5. ç»‘å®šå…¨å±è§¦æ‘¸äº‹ä»¶ (æ ¸å¿ƒé€»è¾‘)
                this.setupTouchInput();

                // 6. å¯åŠ¨å¾ªç¯
                this.animate();

                // 7. åŠ è½½
                await this.loadModel();
            }

            setupTouchInput() {
                const canvas = this.viewer.renderer.domElement;
                const feedback = document.getElementById('touch-feedback');

                // è§¦æ‘¸å¼€å§‹
                canvas.addEventListener('pointerdown', (e) => {
                    this.isDragging = true;
                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                    
                    // æ˜¾ç¤ºè§¦æ‘¸åé¦ˆ
                    if (this.mode !== 'view') {
                        feedback.style.display = 'block';
                        feedback.style.left = e.clientX + 'px';
                        feedback.style.top = e.clientY + 'px';
                    }
                });

                // è§¦æ‘¸ç§»åŠ¨
                canvas.addEventListener('pointermove', (e) => {
                    if (!this.isDragging) return;
                    
                    if (this.mode !== 'view') {
                        // æ›´æ–°åé¦ˆUIä½ç½®
                        feedback.style.left = e.clientX + 'px';
                        feedback.style.top = e.clientY + 'px';
                        
                        // è®¡ç®—æ»‘åŠ¨è·ç¦» (Delta)
                        const dx = e.clientX - this.lastX;
                        const dy = e.clientY - this.lastY;
                        
                        // åº”ç”¨å˜æ¢ (æ ¸å¿ƒï¼šæ‰‹æŒ‡åŠ¨ï¼Œæ¨¡å‹å°±åŠ¨)
                        this.applyTransform(dx, dy);
                    }

                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                });

                // è§¦æ‘¸ç»“æŸ
                const endDrag = () => {
                    this.isDragging = false;
                    feedback.style.display = 'none';
                };
                canvas.addEventListener('pointerup', endDrag);
                canvas.addEventListener('pointerleave', endDrag);
            }

            applyTransform(dx, dy) {
                // ç§»åŠ¨é€Ÿåº¦ç³»æ•°
                const moveSpeed = 0.01;
                const rotSpeed = 0.005;
                const scaleSpeed = 0.01;

                if (this.mode === 'translate') {
                    // ç§»åŠ¨ï¼šæ‰‹æŒ‡æ»‘å¤šè¿œï¼Œæ¨¡å‹ç§»å¤šè¿œ
                    // è·å–ç›¸æœºæœå‘æ¥å†³å®šç§»åŠ¨æ–¹å‘ï¼ˆç®€å•ç‰ˆï¼šç›´æ¥æ”¹XYZï¼‰
                    this.container.position.x += dx * moveSpeed;
                    this.container.position.y -= dy * moveSpeed; 
                } 
                else if (this.mode === 'rotate') {
                    // æ—‹è½¬ï¼šå·¦å³æ»‘ç»•Yè½´è½¬
                    this.container.rotation.y += dx * rotSpeed;
                    // ä¸Šä¸‹æ»‘ç»•Xè½´è½¬
                    this.container.rotation.x += dy * rotSpeed;
                } 
                else if (this.mode === 'scale') {
                    // ç¼©æ”¾ï¼šå‘ä¸Šæ»‘æ”¾å¤§ï¼Œå‘ä¸‹æ»‘ç¼©å°
                    let s = this.container.scale.x - (dy * scaleSpeed);
                    if (s < 0.1) s = 0.1; // æœ€å°é™åˆ¶
                    if (s > 10) s = 10;   // æœ€å¤§é™åˆ¶
                    this.container.scale.set(s, s, s);
                }
            }

            async loadModel() {
                const response = await fetch(MODEL_URL);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob) + '#.splat';

                await this.viewer.addSplatScene(url, { 'showLoadingUI': false });

                // æŠŠ Splat æ”¾å…¥å®¹å™¨
                setTimeout(() => {
                    const splat = this.viewer.getSplatScene(0);
                    if (splat) {
                        this.container.add(splat);
                        document.getElementById('loader').style.display = 'none';
                    }
                }, 200);
            }

            setMode(mode) {
                this.mode = mode;
                
                // UI æ›´æ–°
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('active', 'view', 'edit'));
                const btn = document.getElementById('btn-' + mode);
                btn.classList.add('active', mode === 'view' ? 'view' : 'edit');

                const status = document.getElementById('status');
                const crosshair = document.getElementById('crosshair');

                if (mode === 'view') {
                    this.orbit.enabled = true; // å¼€å¯è§†è§’
                    this.helper.visible = false;
                    crosshair.style.display = 'none';
                    status.innerText = "ğŸ‘€ æµè§ˆæ¨¡å¼";
                    status.style.color = "#00ff88";
                    status.style.borderColor = "#00ff88";
                } else {
                    this.orbit.enabled = false; // ğŸ”’ é”æ­»è§†è§’
                    this.helper.visible = true; // æ˜¾ç¤ºé»„æ¡†
                    crosshair.style.display = 'block';
                    
                    const actionName = mode==='translate'?'å¹³ç§»':(mode==='rotate'?'æ—‹è½¬':'ç¼©æ”¾');
                    status.innerText = `ğŸ–ï¸ ${actionName}æ¨¡å¼ï¼šåœ¨å±å¹•ä»»æ„å¤„æ»‘åŠ¨`;
                    status.style.color = "#ffaa00";
                    status.style.borderColor = "#ffaa00";
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.orbit.update();
                if(this.helper) this.helper.update();
                this.viewer.update();
                this.viewer.render();
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
