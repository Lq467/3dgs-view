<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Master Editor</title>
    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #050505;
            touch-action: none; user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        #top-bar {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; z-index: 1000;
            pointer-events: none; /* è®©ä¸­é—´é€ä¼  */
        }
        
        .top-btn {
            pointer-events: auto;
            background: rgba(30,30,30,0.8); color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 600;
            backdrop-filter: blur(10px); display: flex; align-items: center; gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .top-btn:active { transform: scale(0.95); }

        /* è§†è§’é”å®šæŒ‰é’®ç‰¹åˆ«æ ·å¼ */
        #lock-btn {
            border-color: #ffaa00; color: #ffaa00;
            opacity: 0; transition: opacity 0.3s, background 0.3s;
            pointer-events: none; /* é»˜è®¤ä¸å¯ç‚¹ */
        }
        #lock-btn.visible { opacity: 1; pointer-events: auto; }
        #lock-btn.locked { background: #ffaa00; color: black; box-shadow: 0 0 15px rgba(255,170,0,0.4); }

        /* --- åº•éƒ¨å·¥å…·æ  --- */
        #dock {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 15, 15, 0.9);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 6px 12px; border-radius: 28px;
            display: flex; gap: 8px; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .tool-btn {
            width: 52px; height: 52px;
            border-radius: 20px; border: none;
            background: transparent; color: #777;
            font-size: 22px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: all 0.2s; position: relative;
        }
        .tool-btn span { font-size: 10px; margin-top: 2px; font-weight: 500; }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .tool-btn.active { background: #333; color: white; transform: translateY(-3px); }
        .tool-btn.active.view { color: #00ff99; box-shadow: 0 5px 15px rgba(0,255,153,0.15); }
        .tool-btn.active.edit { color: #00ccff; box-shadow: 0 5px 15px rgba(0,204,255,0.15); }

        .divider { width: 1px; height: 32px; background: rgba(255,255,255,0.1); margin: 0 4px; }

        /* --- çŠ¶æ€æç¤º --- */
        #status-toast {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: #fff; border: 1px solid #333;
            padding: 8px 20px; border-radius: 30px; font-size: 13px;
            pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 2000;
            white-space: nowrap;
        }

        /* --- åŠ è½½ --- */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 5000;
            transition: opacity 0.5s;
        }
        .bar-bg { width: 200px; height: 4px; background: #333; border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .bar-fill { height: 100%; background: #00ff99; width: 0%; transition: width 0.1s; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div style="color:#00ff99; font-weight:bold;">ğŸš€ å¼•æ“å¯åŠ¨ä¸­...</div>
        <div class="bar-bg"><div class="bar-fill" id="progress-bar"></div></div>
        <div style="color:#666; font-size:12px; margin-top:5px;" id="progress-text">0%</div>
    </div>

    <div id="status-toast"></div>

    <div id="top-bar">
        <div class="top-btn" id="btn-reset">â†º é‡ç½®</div>
        <!-- æ ¸å¿ƒåŠŸèƒ½ï¼šé”å®šè§†è§’ -->
        <div class="top-btn" id="lock-btn">ğŸ”“ è§†è§’æœªé”</div>
    </div>

    <div id="dock">
        <button class="tool-btn active view" id="mode-view">
            <span>ğŸ‘ï¸</span><span>æµè§ˆ</span>
        </button>
        <div class="divider"></div>
        <button class="tool-btn" id="mode-translate">
            <span>âœ¢</span><span>ç§»åŠ¨</span>
        </button>
        <button class="tool-btn" id="mode-rotate">
            <span>â†»</span><span>æ—‹è½¬</span>
        </button>
        <button class="tool-btn" id="mode-scale">
            <span>â¤¢</span><span>ç¼©æ”¾</span>
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        // ğŸŒŸ å¼•å…¥ ArcballControlsï¼šè¿™æ˜¯360åº¦æ— é™æ—‹è½¬çš„å…³é”®ï¼Œæ¯”Orbité«˜çº§
        import { ArcballControls } from 'three/addons/controls/ArcballControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.gizmo = null;
                this.splatMesh = null;
                this.isCameraLocked = false; // è§†è§’é”å®šçŠ¶æ€
                this.currentMode = 'view';
            }

            async init() {
                // 1. åˆå§‹åŒ– Viewer
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 0, 5],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, // ğŸš« å¿…é¡»å…³é—­ï¼Œä½¿ç”¨è‡ªå·±çš„æ§åˆ¶å™¨
                    'selfDrivenMode': false,     // æ‰‹åŠ¨é©±åŠ¨æ¸²æŸ“
                    'sharedMemoryForWorkers': false
                });
                
                document.body.appendChild(this.viewer.renderer.domElement);

                // 2. ğŸŒŸ åˆå§‹åŒ– ArcballControls (æ›¿ä»£ OrbitControls)
                // document.body ç¡®ä¿å…¨å±è§¦æ§
                this.controls = new ArcballControls(this.viewer.camera, this.viewer.renderer.domElement, this.viewer.scene);
                this.controls.setGizmosVisible(false); // éšè—Arcballè‡ªå¸¦çš„UIåœˆåœˆ
                this.controls.cursorZoom = true;
                this.controls.enableAnimations = true; // å¼€å¯æƒ¯æ€§
                this.controls.dampingFactor = 10;
                this.controls.wMax = 10; // å…è®¸æ— é™ç¿»æ»š
                
                // 3. åˆå§‹åŒ– Gizmo (ç¼–è¾‘è½´)
                this.gizmo = new TransformControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.gizmo.setSize(1.3); // åŠ å¤§å°ºå¯¸
                this.gizmo.setSpace('local');
                
                // ğŸ”¥ å…³é”®ï¼šå¼ºåˆ¶è®©åæ ‡è½´æ¸²æŸ“åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«æ¨¡å‹é®æŒ¡
                this.gizmo.traverse((child) => {
                    if (child.material) {
                        child.material.depthTest = false;
                        child.material.depthWrite = false;
                    }
                });

                // ç›‘å¬æ‹–åŠ¨ï¼šå½“æ‹–åŠ¨ Gizmo æ—¶ï¼Œæš‚æ—¶ç¦ç”¨æ§åˆ¶å™¨
                this.gizmo.addEventListener('dragging-changed', (event) => {
                    if (!this.isCameraLocked) {
                        // åªæœ‰åœ¨æ²¡é”è§†è§’çš„æƒ…å†µä¸‹ï¼Œæ‰éœ€è¦è‡ªåŠ¨åˆ‡æ¢
                        this.controls.enabled = !event.value;
                    }
                });
                
                this.viewer.threeScene.add(this.gizmo);

                // 4. æ·»åŠ ç½‘æ ¼ (ä½œä¸ºæ°´å¹³å‚è€ƒ)
                const grid = new THREE.GridHelper(30, 30, 0x444444, 0x111111);
                this.viewer.threeScene.add(grid);

                // 5. å¯åŠ¨å¾ªç¯
                this.animate();

                // 6. åŠ è½½æ•°æ®
                await this.loadData();

                // 7. ç»‘å®šUIäº‹ä»¶
                this.bindEvents();
            }

            async loadData() {
                const pBar = document.getElementById('progress-bar');
                const pText = document.getElementById('progress-text');
                
                try {
                    const response = await fetch(MODEL_URL);
                    const reader = response.body.getReader();
                    const len = +response.headers.get('Content-Length');
                    let received = 0;
                    let chunks = [];

                    while(true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        received += value.length;
                        if(len) {
                            const pct = (received/len)*100;
                            pBar.style.width = pct + "%";
                            pText.innerText = Math.round(pct) + "%";
                        }
                    }

                    const blob = new Blob(chunks);
                    const url = URL.createObjectURL(blob) + '#.splat';
                    
                    await this.viewer.addSplatScene(url, { 'showLoadingUI': false, 'splatAlphaRemovalThreshold': 5 });
                    
                    // è·å–æ¨¡å‹
                    this.splatMesh = this.viewer.getSplatScene(0);
                    
                    // éšè—åŠ è½½å±‚
                    document.getElementById('loader').style.opacity = 0;
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

                    this.toast("âœ… åŠ è½½å®Œæˆ - 360Â°æ— é™è§†è§’å°±ç»ª");

                } catch(e) {
                    pText.innerText = "Error: " + e.message;
                    pBar.style.backgroundColor = "red";
                }
            }

            setMode(mode) {
                this.currentMode = mode;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active', 'view', 'edit'));
                const btn = document.getElementById('mode-' + mode);
                const lockBtn = document.getElementById('lock-btn');

                if (mode === 'view') {
                    // æµè§ˆæ¨¡å¼
                    btn.classList.add('active', 'view');
                    this.gizmo.detach();
                    
                    // å¼ºåˆ¶è§£é”ç›¸æœº
                    this.isCameraLocked = false;
                    this.controls.enabled = true;
                    
                    // éšè—é”å®šæŒ‰é’®
                    lockBtn.classList.remove('visible');
                    this.updateLockBtnState();
                    
                    this.toast("ğŸ‘€ æµè§ˆæ¨¡å¼ï¼šåŒæŒ‡ç¼©æ”¾ï¼Œä»»æ„æ—‹è½¬");
                } else {
                    // ç¼–è¾‘æ¨¡å¼
                    btn.classList.add('active', 'edit');
                    if (this.splatMesh) {
                        this.gizmo.attach(this.splatMesh);
                        this.gizmo.setMode(mode);
                    }
                    // æ˜¾ç¤ºé”å®šæŒ‰é’®
                    lockBtn.classList.add('visible');
                    this.toast(`ğŸ”§ ${mode}æ¨¡å¼ï¼šç‚¹å‡»ä¸Šæ–¹ã€ğŸ”“ã€‘å¯é”å®šè§†è§’`);
                }
            }

            toggleLock() {
                this.isCameraLocked = !this.isCameraLocked;
                this.controls.enabled = !this.isCameraLocked;
                this.updateLockBtnState();
                
                if (this.isCameraLocked) {
                    this.toast("ğŸ”’ è§†è§’å·²é”å®šï¼šåªèƒ½æ“ä½œæ¨¡å‹");
                } else {
                    this.toast("ğŸ”“ è§†è§’å·²è§£é”");
                }
            }

            updateLockBtnState() {
                const btn = document.getElementById('lock-btn');
                if (this.isCameraLocked) {
                    btn.innerHTML = "ğŸ”’ è§†è§’å·²é”";
                    btn.classList.add('locked');
                } else {
                    btn.innerHTML = "ğŸ”“ è§†è§’æœªé”";
                    btn.classList.remove('locked');
                }
            }

            resetView() {
                this.controls.reset();
                this.viewer.camera.position.set(0, 0, 5);
                this.viewer.camera.lookAt(0, 0, 0);
                // Arcballé‡ç½®æ—¶è¦æ‰‹åŠ¨æŠŠ up è½´è®¾å›å»
                this.viewer.camera.up.set(0, 1, 0);
                this.toast("ğŸ”„ è§†è§’å·²å½’ä½");
            }

            toast(msg) {
                const t = document.getElementById('status-toast');
                t.innerText = msg;
                t.style.opacity = 1;
                clearTimeout(this.timer);
                this.timer = setTimeout(() => t.style.opacity = 0, 2500);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.controls.update();
                this.viewer.update();
                this.viewer.render();
            }

            bindEvents() {
                ['view', 'translate', 'rotate', 'scale'].forEach(m => {
                    document.getElementById('mode-' + m).addEventListener('click', () => this.setMode(m));
                });
                document.getElementById('btn-reset').addEventListener('click', () => this.resetView());
                document.getElementById('lock-btn').addEventListener('click', () => this.toggleLock());
            }
        }

        const app = new App();
        app.init();

    </script>
</body>
</html>
