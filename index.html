<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3DGS Gyro Viewer</title>
    <style>
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            user-select: none;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        #header {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; z-index: 1000;
        }
        .status-pill {
            background: rgba(30,30,30,0.6); backdrop-filter: blur(10px);
            color: #fff; padding: 6px 16px; border-radius: 20px;
            font-size: 13px; border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .status-pill.active {
            background: rgba(0, 255, 136, 0.2); color: #00ff88; border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
        }

        /* åº•éƒ¨æ§åˆ¶æŒ‰é’® */
        #controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; z-index: 1000;
        }

        .btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: rgba(40,40,40,0.9); color: #ccc;
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: transform 0.1s, background 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:active { transform: scale(0.9) translateX(-50%); }
        
        /* é™€èºä»ªæ¿€æ´»æ ·å¼ */
        #btn-gyro.active {
            background: #00ff88; color: #000; box-shadow: 0 0 20px rgba(0,255,136,0.6);
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000;
            transition: opacity 0.5s;
        }
        .spinner { width:40px; height:40px; border:3px solid #333; border-top-color:#00ff88; border-radius:50%; animation:spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="color:#666; font-size:12px; margin-top:15px;">æ¨¡å‹åŠ è½½ä¸­...</div>
    </div>

    <div id="header">
        <div class="status-pill" id="status-text">ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨è°ƒæ•´è§†è§’</div>
    </div>

    <div id="controls">
        <button class="btn" id="btn-reset" title="é‡ç½®è§†è§’">â†º</button>
        <button class="btn" id="btn-gyro" title="å¼€å¯ä½“æ„Ÿé¢„è§ˆ">ğŸ“±</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        class App {
            constructor() {
                this.viewer = null;
                this.controls = null;
                this.gyroEnabled = false;

                // é™€èºä»ªç›¸å…³å˜é‡
                this.baseQuaternion = new THREE.Quaternion(); // å¼€å¯é™€èºä»ªæ—¶çš„åˆå§‹è§’åº¦
                this.initialDeviceState = { beta: 0, gamma: 0 }; // åˆå§‹æ‰‹æœºå§¿æ€
                this.currentDeviceState = { beta: 0, gamma: 0 };
            }

            async init() {
                // 1. åˆå§‹åŒ–å¼•æ“
                this.viewer = new Viewer({
                    'cameraUp': [0, 1, 0],
                    'initialCameraPosition': [0, 1, 4],
                    'initialCameraLookAt': [0, 0, 0],
                    'useBuiltInControls': false, // ç¦ç”¨å†…ç½®ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„
                    'selfDrivenMode': false,
                    'sharedMemoryForWorkers': false
                });
                document.body.appendChild(this.viewer.renderer.domElement);

                // 2. åˆå§‹åŒ– OrbitControls (è§¦æ‘¸æ§åˆ¶)
                this.controls = new OrbitControls(this.viewer.camera, this.viewer.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 0.1;
                this.controls.maxDistance = 100;

                // 3. ç›‘å¬è®¾å¤‡æ–¹å‘ (ä½†ä¸ç«‹å³åº”ç”¨)
                window.addEventListener('deviceorientation', (e) => this.handleOrientation(e));

                // 4. å¯åŠ¨å¾ªç¯
                this.animate();

                // 5. åŠ è½½æ¨¡å‹
                await this.loadModel();

                // 6. ç»‘å®šæŒ‰é’®
                this.bindEvents();
            }

            async loadModel() {
                try {
                    const response = await fetch(MODEL_URL);
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob) + '#.splat';

                    await this.viewer.addSplatScene(url, { 'showLoadingUI': false });
                    
                    document.getElementById('loader').style.opacity = 0;
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                } catch (e) {
                    alert("åŠ è½½å¤±è´¥: " + e.message);
                }
            }

            // å¤„ç†é™€èºä»ªæ•°æ®
            handleOrientation(event) {
                if (!this.gyroEnabled) return;

                // beta: å‰åå€¾æ–œ (-180 ~ 180)
                // gamma: å·¦å³å€¾æ–œ (-90 ~ 90)
                // alpha: ç½—ç›˜æ–¹å‘ (æˆ‘ä»¬ä¸éœ€è¦ï¼Œå› ä¸ºæ˜¯ç›¸å¯¹è¿åŠ¨)
                this.currentDeviceState.beta = event.beta || 0;
                this.currentDeviceState.gamma = event.gamma || 0;
            }

            toggleGyro() {
                // iOS 13+ æƒé™è¯·æ±‚
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                this._switchGyroState();
                            } else {
                                alert("éœ€è¦é™€èºä»ªæƒé™æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½");
                            }
                        })
                        .catch(console.error);
                } else {
                    // Android æˆ–æ—§ç‰ˆ iOS ç›´æ¥åˆ‡æ¢
                    this._switchGyroState();
                }
            }

            _switchGyroState() {
                this.gyroEnabled = !this.gyroEnabled;
                
                const btn = document.getElementById('btn-gyro');
                const status = document.getElementById('status-text');

                if (this.gyroEnabled) {
                    // === å¼€å¯é™€èºä»ªæ¨¡å¼ ===
                    
                    // 1. ç¦ç”¨è§¦æ‘¸æ§åˆ¶ (é˜²æ­¢å†²çª)
                    this.controls.enabled = false;
                    
                    // 2. è®°å½•å½“å‰çš„åŸºå‡†çŠ¶æ€ (æŠŠå½“å‰è§†è§’ä½œä¸º 0 ç‚¹)
                    this.baseQuaternion.copy(this.viewer.camera.quaternion);
                    this.initialDeviceState.beta = this.currentDeviceState.beta;
                    this.initialDeviceState.gamma = this.currentDeviceState.gamma;

                    btn.classList.add('active');
                    status.classList.add('active');
                    status.innerText = "ğŸ“± æ™ƒåŠ¨æ‰‹æœºä»¥é¢„è§ˆ";
                } else {
                    // === å›åˆ°è§¦æ‘¸æ¨¡å¼ ===
                    this.controls.enabled = true; // æ¢å¤æ‰‹æŒ‡æ§åˆ¶
                    
                    // æ¢å¤åˆ°å¼€å¯å‰çš„åŸºå‡†è§’åº¦ (å¯é€‰ï¼Œé˜²æ­¢è§†è§’æ­ªå¾—å¤ªå‰å®³)
                    // this.viewer.camera.quaternion.copy(this.baseQuaternion);

                    btn.classList.remove('active');
                    status.classList.remove('active');
                    status.innerText = "ğŸ‘† æ‰‹æŒ‡æ»‘åŠ¨è°ƒæ•´è§†è§’";
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                if (this.gyroEnabled) {
                    // === é™€èºä»ªé€»è¾‘ ===
                    
                    // è®¡ç®—åç§»é‡ (å½“å‰è§’åº¦ - åˆå§‹è§’åº¦)
                    let deltaBeta = this.currentDeviceState.beta - this.initialDeviceState.beta;
                    let deltaGamma = this.currentDeviceState.gamma - this.initialDeviceState.gamma;

                    // é™åˆ¶å¹…åº¦ (å¹…åº¦ä¸è¦å¤ªå¤§) -> çµæ•åº¦ç³»æ•° 0.5 åº¦
                    const SENSITIVITY = 0.5; 
                    const MAX_ANGLE = 30; // æœ€å¤§åè½¬ 30 åº¦

                    // ç®€å•Clampé˜²æ­¢ç¿»è½¬è¿‡åº¦
                    deltaBeta = Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, deltaBeta));
                    deltaGamma = Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, deltaGamma));

                    // å°†è§’åº¦è½¬ä¸ºå¼§åº¦
                    const radX = THREE.MathUtils.degToRad(deltaBeta * SENSITIVITY);
                    const radY = THREE.MathUtils.degToRad(deltaGamma * SENSITIVITY);

                    // åˆ›å»ºåç§»æ—‹è½¬
                    const qx = new THREE.Quaternion();
                    qx.setFromAxisAngle(new THREE.Vector3(1, 0, 0), radX); // ä¸Šä¸‹ç‚¹å¤´ (Beta)
                    
                    const qy = new THREE.Quaternion();
                    qy.setFromAxisAngle(new THREE.Vector3(0, 1, 0), radY); // å·¦å³æ‘‡å¤´ (Gamma)

                    // åº”ç”¨æ—‹è½¬ï¼šåŸºå‡†è§’åº¦ * åç§»Y * åç§»X
                    // æ³¨æ„ä¹˜æ³•é¡ºåºå½±å“æ—‹è½¬è½´æ˜¯æœ¬åœ°è¿˜æ˜¯ä¸–ç•Œ
                    this.viewer.camera.quaternion.copy(this.baseQuaternion);
                    this.viewer.camera.quaternion.multiply(qy);
                    this.viewer.camera.quaternion.multiply(qx);

                } else {
                    // === è§¦æ‘¸é€»è¾‘ ===
                    this.controls.update();
                }

                this.viewer.update();
                this.viewer.render();
            }

            bindEvents() {
                document.getElementById('btn-reset').addEventListener('click', () => {
                    this.controls.reset();
                    // å…³æ‰é™€èºä»ªï¼Œå›åˆ°åˆå§‹çŠ¶æ€
                    if(this.gyroEnabled) this._switchGyroState();
                });

                document.getElementById('btn-gyro').addEventListener('click', () => {
                    this.toggleGyro();
                });
            }
        }

        window.app = new App();
        window.app.init();

    </script>
</body>
</html>
