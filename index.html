<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS SuperSplat é£æ ¼ç¼–è¾‘å™¨</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: sans-serif; }
        
        /* é¡¶éƒ¨åŠ è½½æç¤º */
        #loader-bar {
            position: absolute; top: 0; left: 0; width: 0%; height: 4px; 
            background: #00ff88; z-index: 2000; transition: width 0.2s;
        }
        #status-text {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            color: #fff; background: rgba(0,0,0,0.7); padding: 5px 15px;
            border-radius: 20px; font-size: 13px; pointer-events: none; z-index: 2000;
        }

        /* åº•éƒ¨å·¥å…·æ  - ä»¿ SuperSplat é£æ ¼ */
        #toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(40, 40, 40, 0.9);
            padding: 10px 20px; border-radius: 12px;
            display: flex; gap: 15px;
            border: 1px solid #555;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .tool-btn {
            background: #333; border: 1px solid #666; color: #ccc;
            width: 40px; height: 40px; border-radius: 8px;
            cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .tool-btn:hover { background: #444; color: #fff; }
        .tool-btn.active { background: #007bff; border-color: #0056b3; color: white; }

        /* å³ä¸Šè§’é‡ç½®æŒ‰é’® */
        #reset-view {
            position: absolute; top: 20px; right: 20px;
            background: #333; color: white; border: 1px solid #555;
            padding: 8px 15px; border-radius: 8px; cursor: pointer;
            z-index: 1000;
        }
        #reset-view:hover { background: #444; }

    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader-bar"></div>
    <div id="status-text">å‡†å¤‡åŠ è½½...</div>

    <button id="reset-view">ğŸ¥ é‡ç½®è§†è§’</button>

    <div id="toolbar">
        <button class="tool-btn active" id="btn-translate" title="ç§»åŠ¨ (Translate)">âœ¢</button>
        <button class="tool-btn" id="btn-rotate" title="æ—‹è½¬ (Rotate)">â†»</button>
        <button class="tool-btn" id="btn-scale" title="ç¼©æ”¾ (Scale)">â¤¢</button>
        <div style="width:1px; background:#555; margin:0 5px;"></div>
        <button class="tool-btn" id="btn-reset-model" title="é‡ç½®æ¨¡å‹çŠ¶æ€">â†º</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // æ¨¡å‹åœ°å€
        const MODEL_URL = 'https://huggingface.co/datasets/liu1230/my-3dgs/resolve/main/scene.splat';

        // UI å…ƒç´ 
        const statusBar = document.getElementById('loader-bar');
        const statusText = document.getElementById('status-text');
        
        let viewer, transformControl, splatMesh;

        async function init() {
            // 1. åˆå§‹åŒ– Viewer
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': [0, 2, 5],
                'initialCameraLookAt': [0, 0, 0],
                'useBuiltInControls': true, // ä½¿ç”¨å†…ç½®çš„ OrbitControls
                'sharedMemoryForWorkers': false
            });
            document.body.appendChild(viewer.renderer.domElement);

            // 2. æ·»åŠ ç¯å¢ƒè¾…åŠ©ï¼ˆç½‘æ ¼ï¼‰
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            viewer.threeScene.add(gridHelper);

            // 3. åˆå§‹åŒ–å˜æ¢æ§åˆ¶å™¨ (Gizmo)
            setupTransformControls();

            // 4. ä¸‹è½½å¹¶åŠ è½½æ¨¡å‹
            try {
                const splatBuffer = await downloadWithProgress(MODEL_URL);
                await loadSplatFromBuffer(splatBuffer);
            } catch (err) {
                statusText.innerText = "âŒ é”™è¯¯: " + err.message;
                statusBar.style.backgroundColor = 'red';
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®¾ç½®å˜æ¢æ§åˆ¶å™¨ ---
        function setupTransformControls() {
            // TransformControls éœ€è¦ç›¸æœºå’Œæ¸²æŸ“å™¨DOM
            transformControl = new TransformControls(viewer.camera, viewer.renderer.domElement);
            
            // å½“ç”¨æˆ·æ‹–æ‹½ Gizmo æ—¶ï¼Œå¿…é¡»ç›‘å¬ 'dragging-changed'
            // å¦‚æœæ­£åœ¨æ‹–æ‹½ Gizmoï¼Œå°±ç¦ç”¨ viewer çš„ç›¸æœºæ§åˆ¶å™¨ï¼Œå¦åˆ™ç”»é¢ä¼šä¹±è½¬
            transformControl.addEventListener('dragging-changed', function (event) {
                if (viewer.controls) {
                    viewer.controls.enabled = !event.value;
                }
            });

            viewer.threeScene.add(transformControl);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå¤„ç†ä¸‹è½½è¿›åº¦ ---
        async function downloadWithProgress(url) {
            statusText.innerText = "æ­£åœ¨è¿æ¥...";
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            const contentLength = +response.headers.get('Content-Length');
            const reader = response.body.getReader();
            let receivedLength = 0; 
            let chunks = []; 

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                
                if (contentLength) {
                    const percent = (receivedLength / contentLength) * 100;
                    statusBar.style.width = percent + "%";
                    statusText.innerText = `ä¸‹è½½ä¸­... ${Math.round(percent)}%`;
                } else {
                    statusText.innerText = `ä¸‹è½½ä¸­... ${(receivedLength/1024/1024).toFixed(1)}MB`;
                }
            }

            return new Blob(chunks);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ è½½å¹¶ç»‘å®š ---
        async function loadSplatFromBuffer(blob) {
            statusText.innerText = "è§£ææ¨¡å‹...";
            const url = URL.createObjectURL(blob) + '#.splat';

            await viewer.addSplatScene(url, {
                'splatAlphaRemovalThreshold': 5,
                'showLoadingUI': false
            });

            // è·å–æ¨¡å‹å¯¹è±¡
            splatMesh = viewer.getSplatScene(0);

            if (splatMesh) {
                // ç»‘å®š Gizmo åˆ°æ¨¡å‹ä¸Š
                transformControl.attach(splatMesh);
                
                statusText.innerText = "âœ… å°±ç»ª";
                setTimeout(() => { 
                    statusText.style.display = 'none'; 
                    statusBar.style.width = '0%';
                }, 1000);
                
                viewer.start();
            } else {
                throw new Error("æ¨¡å‹å¯¹è±¡è·å–å¤±è´¥");
            }
        }

        // --- æŒ‰é’®äº‹ä»¶ç»‘å®š ---
        const modes = {
            'btn-translate': 'translate',
            'btn-rotate': 'rotate',
            'btn-scale': 'scale'
        };

        Object.keys(modes).forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                // åˆ‡æ¢æ¨¡å¼
                transformControl.setMode(modes[id]);
                
                // æ›´æ–°æŒ‰é’®é«˜äº®
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            });
        });

        // é‡ç½®æ¨¡å‹ä½ç½®
        document.getElementById('btn-reset-model').addEventListener('click', () => {
            if (splatMesh) {
                splatMesh.position.set(0, 0, 0);
                splatMesh.rotation.set(0, 0, 0);
                splatMesh.scale.set(1, 1, 1);
            }
        });

        // é‡ç½®ç›¸æœº
        document.getElementById('reset-view').addEventListener('click', () => {
            viewer.camera.position.set(0, 2, 5);
            viewer.camera.lookAt(0, 0, 0);
            if(viewer.controls) viewer.controls.target.set(0,0,0);
        });

        // ç›‘å¬é”®ç›˜å¿«æ·é”® (SuperSplat ä¹ æƒ¯)
        window.addEventListener('keydown', function (event) {
            switch (event.key.toLowerCase()) {
                case 't': // Translate
                    document.getElementById('btn-translate').click();
                    break;
                case 'r': // Rotate
                    document.getElementById('btn-rotate').click();
                    break;
                case 's': // Scale
                    document.getElementById('btn-scale').click();
                    break;
            }
        });

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
