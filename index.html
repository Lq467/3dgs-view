<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DGS 陀螺仪防穿帮演示</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #info {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-family: sans-serif; text-align: center;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; z-index: 999;
        }
        button { padding: 10px 20px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
    <!-- 引入 Three.js 和 GaussianSplats3D 引擎 -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.3.9/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <!-- 启动按钮（安卓必须用户点击才能获取陀螺仪权限） -->
    <div id="info">
        <h2>3DGS 陀螺仪查看器</h2>
        <p>点击下方按钮开始体验</p>
        <button id="startBtn">开始沉浸体验</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ================= 配置区域 (在这里修改你的参数) =================
        // 1. 你的模型文件路径 (上传到GitHub后把文件名改在这里)
        const MODEL_FILE = 'https://github.com/Lq467/3dgs-view/releases/download/1.0/scene.splat'; 

        // 2. 初始相机位置 (根据你的模型调整，xyz坐标)
        const INITIAL_POSITION = [0, 1, 2]; 

        // 3. 视角限制范围 (防穿帮核心！单位是弧度，0.5大约是30度)
        // 限制左右转动的幅度
        const MAX_Y_ANGLE = 0.6; 
        // 限制上下转动的幅度
        const MAX_X_ANGLE = 0.4; 

        // 4. 视场角 (FOV)，越小越像长焦，越大越像广角，默认60接近人眼
        const CAMERA_FOV = 60; 
        // ==============================================================

        let viewer;
        let isRunning = false;
        let initialGyro = null;

        const startBtn = document.getElementById('startBtn');
        const infoDiv = document.getElementById('info');

        startBtn.addEventListener('click', async () => {
            // 请求设备方向权限 (iOS 13+ 需要，安卓部分版本也建议)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') {
                        initViewer();
                    } else {
                        alert('需要陀螺仪权限才能控制视角');
                    }
                } catch (e) {
                    console.error(e);
                    // 非iOS设备通常直接进入
                    initViewer();
                }
            } else {
                // 非iOS设备 (安卓) 直接运行
                initViewer();
            }
        });

        function initViewer() {
            infoDiv.style.display = 'none';
            
            // 初始化 3DGS 查看器引擎
            viewer = new Viewer({
                'cameraUp': [0, 1, 0],
                'initialCameraPosition': INITIAL_POSITION,
                'initialCameraLookAt': [0, 0, 0],
                'cameraFoo': CAMERA_FOV, // 设置FOV
                'halfPrecisionCovariancesOnGPU': true,
            });

            // 加载模型
            viewer.addSplatScene(MODEL_FILE, {
                'showLoadingUI': true,
                'splatAlphaRemovalThreshold': 5, // 移除半透明杂点
                'scale': [1, 1, 1],
                'rotation': [0, 0, 0, 1] // 四元数旋转，如果模型倒了可以在这改
            })
            .then(() => {
                viewer.start();
                isRunning = true;
                
                // 监听陀螺仪数据
                window.addEventListener('deviceorientation', handleOrientation);
            });
        }

        // 陀螺仪控制逻辑
        function handleOrientation(event) {
            if (!viewer || !isRunning) return;

            const camera = viewer.camera;
            
            // beta 是前后倾斜 (-180 到 180) -> 对应相机 X 轴 (上下看)
            // gamma 是左右倾斜 (-90 到 90) -> 对应相机 Y 轴 (左右看)
            // 注意：安卓和iOS的坐标系有时不同，这里按通用Web标准写的
            
            let x = event.beta;  // 上下
            let y = event.gamma; // 左右

            // 记录初始角度作为“零点”
            if (initialGyro === null) {
                initialGyro = { x: x, y: y };
                return;
            }

            // 计算相对角度差 (转为弧度)
            let deltaX = (x - initialGyro.x) * (Math.PI / 180);
            let deltaY = (y - initialGyro.y) * (Math.PI / 180);

            // === 核心防穿帮：限制角度 ===
            // 使用 clamp 函数把角度锁死在设定范围内
            deltaX = Math.max(-MAX_X_ANGLE, Math.min(MAX_X_ANGLE, deltaX));
            deltaY = Math.max(-MAX_Y_ANGLE, Math.min(MAX_Y_ANGLE, deltaY));

            // 应用旋转
            // 这里我们保持相机位置不变，只改变朝向
            // 这是一个简单的欧拉角应用，更复杂的可以用四元数
            camera.rotation.set(
                deltaX, // 上下看
                deltaY, // 左右看
                0,      // 忽略 Z 轴滚转 (防止晕车)
                'YXZ'
            );
            
            // 确保渲染器知道相机更新了
            viewer.renderer.render(viewer.scene, viewer.camera);
        }
    </script>
</body>

</html>
